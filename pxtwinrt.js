var pxt;!function(e){!function(n){n.driveDeployCoreAsync=function(n){function t(n){return e.debug("writing "+o+" to "+n.displayName),e.winrt.promisify(n.createFileAsync(o,Windows.Storage.CreationCollisionOption.replaceExisting).then(function(e){return Windows.Storage.FileIO.writeTextAsync(e,a)})).then(function(e){}).catch(function(t){e.debug("failed to write "+o+" to "+n.displayName+" - "+t)})}var r=e.appTarget.compile.deployDrives;e.Util.assert(!!r),e.debug("deploying to drives "+r);var i=new RegExp(r),o=e.outputName(),a=n.outfiles[o];return e.winrt.promisify(Windows.Storage.KnownFolders.removableDevices.getFoldersAsync()).then(function(e){var n=e.filter(function(e){return i.test(e.displayName)}).map(t);return Promise.join.apply(Promise,n)}).then(function(e){})},n.browserDownloadAsync=function(n,t,r){var i;return e.winrt.promisify(Windows.Storage.ApplicationData.current.temporaryFolder.createFileAsync(t,Windows.Storage.CreationCollisionOption.replaceExisting).then(function(e){return Windows.Storage.FileIO.writeTextAsync(i=e,n)}).then(function(){return Windows.System.Launcher.launchFileAsync(i)}).then(function(e){}))},n.saveOnlyAsync=function(n){var t=e.appTarget.compile.useUF2,r=t?[".uf2"]:[".hex"],i=new Windows.Storage.Pickers.FileSavePicker;return i.suggestedStartLocation=Windows.Storage.Pickers.PickerLocationId.documentsLibrary,i.fileTypeChoices.insert("MakeCode binary file",r),i.suggestedFileName=n.downloadFileBaseName,e.winrt.promisify(i.pickSaveFileAsync().then(function(r){if(r){var i=t?n.outfiles[pxtc.BINARY_UF2]:n.outfiles[pxtc.BINARY_HEX],o=[];return e.Util.stringToUint8Array(atob(i)).forEach(function(e){return o.push(e)}),Windows.Storage.FileIO.writeBytesAsync(r,o).then(function(){return!0})}return Promise.resolve(!1)}))}}(e.winrt||(e.winrt={}))}(pxt||(pxt={}));var pxt;!function(e){!function(n){var t=function(){function n(){this.onData=function(e){},this.onEvent=function(e){},this.onError=function(e){}}return n.prototype.error=function(n){throw new Error(e.U.lf("USB/HID error ({0})",n))},n.prototype.reconnectAsync=function(){var e=this;return this.disconnectAsync().then(function(){return e.initAsync()})},n.prototype.disconnectAsync=function(){return this.dev&&(this.dev.close(),delete this.dev),Promise.resolve()},n.prototype.sendPacketAsync=function(n){if(!this.dev)return Promise.resolve();for(var t=[0],r=0;r<Math.max(n.length,64);++r)t.push(n[r]||0);var i=new Windows.Storage.Streams.DataWriter;i.writeBytes(t);var o=i.detachBuffer(),a=this.dev.createOutputReport(0);return a.data=o,e.winrt.promisify(this.dev.sendOutputReportAsync(a).then(function(n){e.debug("hf2: "+n+" bytes written")}))},n.prototype.initAsync=function(){var t=this;e.Util.assert(!this.dev,"HID interface not properly reseted");var r=Windows.Devices,i=r.HumanInterfaceDevice.HidDevice;return n.uf2Selectors||this.initUf2Selectors(),n.uf2Selectors.reduce(function(e,n){return e.then(function(e){return e&&e.length?Promise.resolve(e):r.Enumeration.DeviceInformation.findAllAsync(n,null)})},Promise.resolve(null)).then(function(n){if(!n||!n[0])return e.debug("no hid device found"),Promise.reject(new Error("no hid device found"));e.debug("hid enumerate "+n.length+" devices");var t=n[0];return e.debug("hid connect to "+t.name+" ("+t.id+")"),i.fromIdAsync(t.id,Windows.Storage.FileAccessMode.readWrite)}).then(function(n){return t.dev=n,t.dev?(e.debug("hid device version "+t.dev.version),t.dev.addEventListener("inputreportreceived",function(n){e.debug("input report");for(var r=Windows.Storage.Streams.DataReader.fromBuffer(n.report.data),i=[];r.unconsumedBufferLength;)i.push(r.readByte());65==i.length&&0===i[0]&&i.shift(),t.onData(new Uint8Array(i))}),Promise.resolve()):(e.debug("can't connect to hid device"),Promise.reject(new Error("can't connect to hid device")))}).catch(function(n){var t=new Error(e.U.lf("Device not found"));return t.notifyUser=!0,Promise.reject(t)})},n.prototype.initUf2Selectors=function(){var t=Windows.Devices.HumanInterfaceDevice.HidDevice;n.uf2Selectors=[],e.appTarget&&e.appTarget.compile&&e.appTarget.compile.hidSelectors&&e.appTarget.compile.hidSelectors.forEach(function(e){var r=t.getDeviceSelector(parseInt(e.usagePage),parseInt(e.usageId),parseInt(e.vid),parseInt(e.pid));n.uf2Selectors.push(r)})},n}();n.mkPacketIOAsync=function(){var e=new t;return e.initAsync().then(function(){return e})}}(e.winrt||(e.winrt={}))}(pxt||(pxt={}));var pxt;!function(e){!function(n){function t(n){var r=i[n];if(r)if(r.device){r.device.baudRate=115200;var o=r.device.inputStream,a=new Windows.Storage.Streams.DataReader(o),c={},u=function(){return a.loadAsync(32).done(function(t){var r=a.readString(4*Math.floor(t/4));e.Util.bufferSerial(c,r,n),u()},function(e){setTimeout(function(){return t(n)},1e3)})};u()}else{var s=Windows.Devices.Enumeration.DeviceAccessInformation.createFromId(n).currentStatus;e.debug("device issue: "+s)}}var r,i={};n.initSerial=function(){if(e.appTarget.serial&&e.appTarget.serial.log&&e.appTarget.serial.nameFilter){var o=new RegExp(e.appTarget.serial.nameFilter),a=Windows.Devices.SerialCommunication.SerialDevice.getDeviceSelector();(r=Windows.Devices.Enumeration.DeviceInformation.createWatcher(a,[])).addEventListener("added",function(r){n.toArray(r.detail).forEach(function(n){o.test(n.name)&&(e.debug("serial port added "+n.name+" - "+n.id),i[n.id]={info:n},Windows.Devices.SerialCommunication.SerialDevice.fromIdAsync(n.id).done(function(e){i[n.id].device=e,t(n.id)}))})}),r.addEventListener("removed",function(e){n.toArray(e.detail).forEach(function(e){return delete i[e.id]})}),r.addEventListener("updated",function(e){n.toArray(e.detail).forEach(function(e){return i[e.id]?i[e.id].info.update(e.info):null})}),r.start()}}}(e.winrt||(e.winrt={}))}(pxt||(pxt={}));var pxt;!function(e){!function(n){function t(){return"undefined"!=typeof Windows}function r(){return t()?(a.resolve(null),a.promise.then(function(e){return Promise.resolve(e&&e.kind===Windows.ApplicationModel.Activation.ActivationKind.file)})):Promise.resolve(!1)}function i(e){Windows.UI.WebUI.WebUIApplication.removeEventListener("activated",i),a.resolve(e)}function o(n,t){if(void 0===t&&(t=!1),n.kind===Windows.ApplicationModel.Activation.ActivationKind.file){var r=n.files.getAt(0);if(r&&r.isOfType(Windows.Storage.StorageItemTypes.file)){var i=r;Windows.Storage.FileIO.readBufferAsync(i).then(function(n){for(var t=[],r=Windows.Storage.Streams.DataReader.fromBuffer(n);r.unconsumedBufferLength;)t.push(r.readByte());return r.close(),e.cpp.unpackSourceFromHexAsync(new Uint8Array(t))}).then(function(e){return c(e,t)})}}}n.promisify=function(e){return new Promise(function(n,t){e.done(function(e){return n(e)},function(e){return t(e)})})},n.toArray=function(e){for(var n=[],t=e.length,r=0;r<t;++r)n.push(e[r]);return n},n.isWindows=function(){return!!navigator&&/Win32/i.test(navigator.platform)},n.isWinRT=t,n.initAsync=function(e){if(!t())return Promise.resolve();var a=Windows.UI.Core,u=a.SystemNavigationManager.getForCurrentView();return u.onbackrequested=function(e){console.log("BACK NAVIGATION"),u.appViewBackButtonVisibility=a.AppViewBackButtonVisibility.collapsed,e.handled=!0},n.initSerial(),r().then(function(){if(e){c=e;var n=Windows.UI.WebUI.WebUIApplication;n.removeEventListener("activated",i),n.addEventListener("activated",o)}})},n.captureInitialActivation=function(){t()&&(a=Promise.defer(),Windows.UI.WebUI.WebUIApplication.addEventListener("activated",i))},n.loadActivationProject=function(){return a.promise.then(function(e){return o(e,!0)})},n.hasActivationProjectAsync=r;var a,c}(e.winrt||(e.winrt={}))}(pxt||(pxt={}));var pxt;!function(e){!function(n){!function(t){function r(e){return w.filter(function(n){return n.id==e})[0]}function i(n){var t=r(n.path);t||(t={id:n.path,header:null,text:null,fsText:null},w.push(t));var i=n.files.map(function(e){return e.mtime});i.sort(function(e,n){return n-e});var o=Math.round(i[0]/1e3)||h.nowSeconds(),a={target:g,name:n.config.name,meta:{},editor:e.JAVASCRIPT_PROJECT_NAME,pubId:n.config.installedVersion,pubCurrent:!1,_rev:null,id:n.path,recentUse:o,modificationTime:o,blobId:null,blobCurrent:!1,isDeleted:!1,icon:n.icon};if(t.header){var c=t.header;c.name=a.name,c.pubId=a.pubId,c.modificationTime=a.modificationTime,c.isDeleted=a.isDeleted,c.icon=a.icon}else t.header=a}function o(n){return e.debug("winrt: fetch "+n.id),p(n.id,!0).then(function(e){if(!n.text){n.text={},n.mtime=0;for(var t=0,r=e.files;t<r.length;t++){var i=r[t];n.text[i.name]=i.content,n.mtime=Math.max(n.mtime,i.mtime)}n.fsText=h.flatClone(n.text)}return n.text})}function a(e,n){if(e.temporary)return Promise.resolve();var t=r(e.id);return h.assert(t.header===e),n?(e.saveId=null,t.textNeedsSave=!0,t.text=n,y.enqueue(e.id,function(){h.assert(!!t.fsText);for(var r={files:[],config:null,path:e.id},o=0,a=Object.keys(t.text);o<a.length;o++){var c=a[o];t.text[c]!==t.fsText[c]&&r.files.push({name:c,mtime:null,content:t.text[c],prevContent:t.fsText[c]})}var u=h.flatClone(t.text);return 0==r.files.length?Promise.resolve():l(e.id,r).then(function(r){t.fsText=u,i(r),n&&(e.saveId=null)})})):Promise.resolve()}function c(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];return e.join("\\")}function u(t){var r=c(m.path,t);return e.debug("winrt: reading "+r),n.promisify(Windows.Storage.StorageFile.getFileFromPathAsync(r).then(function(e){return Windows.Storage.FileIO.readTextAsync(e)}))}function s(t,r,i){var o=c(m.path,t);return e.debug("winrt: writing "+c(o,r)),n.promisify(Windows.Storage.StorageFolder.getFolderFromPathAsync(o)).then(function(e){return e.createFileAsync(r,Windows.Storage.CreationCollisionOption.replaceExisting)}).then(function(e){return Windows.Storage.FileIO.writeTextAsync(e,i)}).then(function(){})}function d(t){var r=c(m.path,t);return e.debug("winrt: "+r),n.promisify(Windows.Storage.StorageFile.getFileFromPathAsync(r).then(function(e){return e.getBasicPropertiesAsync().then(function(e){return{name:t,mtime:e.dateModified.getTime()}})}))}function f(e,n){void 0===n&&(n=null);var t=new Error(n||"Error "+e);throw t.statusCode=e,t}function l(t,r){return e.debug("winrt: writing package at "+t),n.promisify(m.createFolderAsync(t,Windows.Storage.CreationCollisionOption.openIfExists)).then(function(){return Promise.map(r.files,function(n){return u(c(t,n.name)).then(function(t){if(n.name==e.CONFIG_NAME)try{JSON.parse(n.content).name||(e.log("Trying to save invalid JSON config"),f(410))}catch(n){e.log("Trying to save invalid format JSON config"),f(410)}t!==n.prevContent&&(e.log("merge error for "+n.name+": previous content changed..."),f(409))},function(e){})})}).then(function(){return Promise.map(r.files,function(e){return s(t,e.name,e.content)})}).then(function(){return p(t,!1)})}function p(n,t){return e.debug("winrt: reading package under "+n),u(c(n,e.CONFIG_NAME)).then(function(r){var i=JSON.parse(r),o=[e.CONFIG_NAME].concat(i.files||[]).concat(i.testFiles||[]);return Promise.map(o,function(e){return d(c(n,e)).then(function(r){var i={name:e,mtime:r?r.mtime:null};return null!=r&&t?u(c(n,e)).then(function(e){return i.content=e,i}):i})}).then(function(e){return{path:n,config:i,files:e}})})}function v(){return n.promisify(m.getFoldersAsync()).then(function(e){return Promise.all(e.map(function(e){return p(e.name,!1)}))}).then(function(e){e.forEach(i)})}var m,g,h=e.Util,w=(h.lf,[]),y=new h.PromiseQueue;t.provider={getHeaders:function(){return w.map(function(e){return e.header})},getHeader:function(e){var n=r(e);return n&&!n.header.isDeleted?n.header:null},getTextAsync:function(n){e.debug("winrt: get text "+n);var t=r(n);return t?t.text?Promise.resolve(t.text):y.enqueue(n,function(){return o(t)}):Promise.resolve(null)},initAsync:function(t){w=[],g=t;var r=Windows.Storage.ApplicationData.current.localFolder;return e.debug("winrt: initializing workspace"),n.promisify(r.createFolderAsync(g,Windows.Storage.CreationCollisionOption.openIfExists)).then(function(n){return m=n,e.debug("winrt: initialized workspace at "+m.path),v()}).then(function(){})},saveAsync:function(e,n){return a(e,n)},installAsync:function(e,n){var t=e,i=t.name.replace(/[^a-zA-Z0-9]+/g," ").trim().replace(/ /g,"-");if(r(i)){for(var o=2;r(i+"-"+o);)o++;i+="-"+o,t.name+=" "+o}t.id=i,t.recentUse=h.nowSeconds(),t.modificationTime=t.recentUse,t.target=g;var c={id:t.id,header:t,text:n,fsText:{}};return w.push(c),a(t,n).then(function(){return t})},saveToCloudAsync:function(e){return Promise.resolve()},syncAsync:v,resetAsync:function(){return n.promisify(m.deleteAsync(Windows.Storage.StorageDeleteOption.default).then(function(){m=void 0,w=[],e.storage.clearLocal()}))}}}(n.workspace||(n.workspace={}))}(e.winrt||(e.winrt={}))}(pxt||(pxt={}));