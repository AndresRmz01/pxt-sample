var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},pxt;!function(e){e.simshim=function(t){function r(e){var t;return ts.isExpression(e)&&(t=f.getContextualType(e)),t||(t=f.getTypeAtLocation(e)),t}function n(e){var t=h;h&&(h+="."),h+=e.name.text,p(e.body),h=t}function i(e){var t=f.typeToString(e,null,ts.TypeFormatFlags.UseFullyQualifiedType);switch(t){case"pxsim.RefAction":return"() => void";default:return t.replace(/^pxsim\./,"")}}function a(e){return e.flags&ts.TypeFlags.Reference&&"Promise"==e.symbol.name?e.typeArguments[0]:null}function s(e){var t=o(e);if(t){m.setNs(h),m.write(t);var r=h;h&&(h+="."),h+=e.name.text,m.write("declare class "+e.name.text+" {"),m.incrIndent();for(var n=0,i=e.members;n<i.length;n++){var a=i[n];switch(a.kind){case d.MethodDeclaration:c(a);break;case d.PropertyDeclaration:l(a);break;case d.Constructor:u(a)}}h=r,m.decrIndent(),m.write("}")}}function o(e){var t=pxtc.getComments(e);return/^\s*\/\/%/m.test(t)?t:null}function l(e){var t=o(e);if(t){var r=e.name.getText(),n="//% shim=."+r,a=f.getTypeAtLocation(e);m.write(t),m.write(n),m.write("public "+r+": "+i(a)+";"),m.write("")}}function u(e){var t=o(e);if(t){f.getTypeAtLocation(e);var n=e.parameters.map(function(e){return e.name.getText()+": "+i(r(e))});m.write(t),m.write('//% shim="new '+h+'"'),m.write("constructor("+n.join(", ")+");"),m.write("")}}function c(t){var n=o(t);if(n){var s=t.name.getText(),l=t.kind==d.MethodDeclaration,u="//% shim="+(l?"."+s:h+"::"+s),c=f.getSignatureFromDeclaration(t),p=f.getReturnTypeOfSignature(c),g=/Async$/.test(s),b=a(p);b?(u+=" promise",p=b,g||e.U.userError(h+"::"+s+" should be called "+s+"Async")):g&&e.U.userError(h+"::"+s+" doesn't return a promise");var v=t.parameters.map(function(e){return e.name.getText()+(e.questionToken?"?":"")+": "+i(r(e))}),y=s.replace(/Async$/,""),k=l?"public":"function";l||m.setNs(h),m.write(n),m.write(u),m.write(k+" "+y+"("+v.join(", ")+"): "+i(p)+";"),m.write("")}}function p(e){switch(e.kind){case d.ModuleDeclaration:return n(e);case d.ModuleBlock:return e.statements.forEach(p);case d.FunctionDeclaration:return c(e);case d.ClassDeclaration:return s(e)}}for(var d=ts.SyntaxKind,f=t.getTypeChecker(),m=e.cpp.nsWriter("declare namespace"),h="",g=0,b=t.getSourceFiles();g<b.length;g++){var v=b[g];if(e.U.startsWith(v.fileName,"sim/"))for(var y=0,k=v.statements;y<k.length;y++){var x=k[y],S=x;x.kind==d.ModuleDeclaration&&"pxsim"==S.name.text&&p(S.body)}}var T={};return T[e.appTarget.corepkg]=m.finish(),T}}(pxt||(pxt={}));var ts;!function(e){!function(e){!function(t){var r=function(t){function r(){var e=this;t.call(this),this.addEnc("$r0","R0-31",function(t){return e.inrange(31,t,t<<4)}),this.addEnc("$r1","R0-31",function(t){return e.inrange(31,t,15&t|(16&t)<<5)}),this.addEnc("$r2","R0-4",function(t){var r=e.inseq([24,26,28,30],t);return null==r?null:r<<4}),this.addEnc("$r3","R0-16-31",function(t){return e.inminmax(16,31,t,t-16<<4)}),this.addEnc("$r4","R0-7",function(t){return e.inrange(7,t,t<<4)}),this.addEnc("$r6","R0-31",function(t){return e.inrange(31,t,t<<4|15&t|(16&t)<<5)}),this.addEnc("$r7","R0-31",function(t){return e.inrange(31,t,t<<3)}),this.addEnc("$r8","Reven",function(e){return 1&e?null:e>>1<<4}),this.addEnc("$r9","Reven",function(e){return 1&e?null:e>>1}),this.addEnc("$r10","R0-16-23",function(t){return e.inminmax(16,23,t,t-16<<4)}),this.addEnc("$r11","R0-16-23",function(t){return e.inminmax(16,23,t,t-16)}),this.addEnc("$r12","R0-16-31",function(t){return e.inminmax(16,31,t,t-16)}),this.addEnc("$i0","#0-63",function(t){return e.inrange(63,t,15&t|(48&t)<<2)}),this.addEnc("$i1","#0-255",function(t){return e.inrange(255,t,15&t|(240&t)<<4)}),this.addEnc("$i2","#0-127",function(t){return e.inrange(127,t,t<<3)}),this.addEnc("$i3","#0-255",function(t){return e.inrange(255,t,15&~t|(240&~t)<<4)}),this.addEnc("$i4","#0-15",function(t){return e.inrange(15,t,t<<4)}),this.addEnc("$i5","#0-63",function(t){return e.inrange(63,t,15&t|(48&t)<<5)}),this.addEnc("$i6","#0-127",function(t){return e.inrange(127,t,15&t|(112&t)<<4)}),this.addEnc("$i7","#0-4095",function(t){return e.inrange(4095,t,t)}),this.addEnc("$i8","#0-63",function(t){return e.inrange(63,t,7&t|(24&t)<<7)|(32&t)<<7}),this.addEnc("$i9","#0-7",function(t){return e.inrange(7,t,t)}),this.addEnc("$la","LABEL",function(t){return e.inrange(65535,t,t)}),this.addEnc("$lb","LABEL",function(t){return e.inrangeSigned(127,t>>1,t>>1)<<3}),this.addEnc("$lc","LABEL",function(t){return e.inrange(65535,t>>1,t>>1)}),this.addEnc("$ld","LABEL",function(t){return e.inrangeSigned(2047,t>>1,t>>1)}),this.addInst("adc   $r0, $r1",7168,64512),this.addInst("add   $r0, $r1",3072,64512),this.addInst("adiw  $r2, $i0",38400,65280),this.addInst("and   $r0, $r1",8192,64512),this.addInst("andi  $r3, $i1",28672,61440),this.addInst("asr   $r0",37893,65039),this.addInst("bclr  $r4",38024,65423),this.addInst("bld   $r0, $i9",63488,65032),this.addInst("brbc  $i9, $lb",62464,64512),this.addInst("brbs  $i9, $lb",61440,64512),this.addInst("brcc  $lb",62464,64519),this.addInst("brcs  $lb",61440,64519),this.addInst("break",38296,65535),this.addInst("breq  $lb",61441,64519),this.addInst("brge  $lb",62468,64519),this.addInst("brhc  $lb",62469,64519),this.addInst("brhs  $lb",61445,64519),this.addInst("brid  $lb",62471,64519),this.addInst("brie  $lb",61447,64519),this.addInst("brlo  $lb",61440,64519),this.addInst("brlt  $lb",61444,64519),this.addInst("brmi  $lb",61442,64519),this.addInst("brne  $lb",62465,64519),this.addInst("brpl  $lb",62466,64519),this.addInst("brsh  $lb",62464,64519),this.addInst("brtc  $lb",62470,64519),this.addInst("brts  $lb",61446,64519),this.addInst("brvc  $lb",62467,64519),this.addInst("brvs  $lb",61443,64519),this.addInst("bset  $r4",37896,65423),this.addInst("bst   $r0, $i9",64e3,65032),this.addInst("call  $lc",37902,65535,!0),this.addInst("cbi   $r7, $i9",38912,65280),this.addInst("cbr   $r3, $i3",28672,61440),this.addInst("clc",38024,65535),this.addInst("clh",38104,65535),this.addInst("cli",38136,65535),this.addInst("cln",38056,65535),this.addInst("clr $r6",9216,64512),this.addInst("cls",38088,65535),this.addInst("clt",38120,65535),this.addInst("clv",38072,65535),this.addInst("clz",38040,65535),this.addInst("com   $r0",37888,65039),this.addInst("cp    $r0, $r1",5120,64512),this.addInst("cpc   $r0, $r1",1024,64512),this.addInst("cpi   $r3, $i1",12288,61440),this.addInst("cpse  $r0, $r1",4096,64512),this.addInst("dec   $r0",37898,65039),this.addInst("des   $i4",37899,65295),this.addInst("eicall",38169,65535),this.addInst("eijmp",37913,65535),this.addInst("elpm",38360,65535),this.addInst("elpm  $r0, Z0",36870,65039),this.addInst("elpm  $r0, Z+0",36871,65039),this.addInst("eor   $r0, $r1",9216,64512),this.addInst("fmul   $r10, $r11",776,65416),this.addInst("fmuls  $r10, $r11",896,65416),this.addInst("fmulsu $r10, $r11",904,65416),this.addInst("icall",38153,65535),this.addInst("ijmp",37897,65535),this.addInst("in    $r0, $i5",45056,63488),this.addInst("inc   $r0",37891,65039),this.addInst("jmp  $lc",37900,65535,!0),this.addInst("lac   Z, $r0",37382,65039),this.addInst("las   Z, $r0",37381,65039),this.addInst("lat   Z, $r0",37383,65039),this.addInst("ld    $r0, X",36876,65039),this.addInst("ld    $r0, X+",36877,65039),this.addInst("ld    $r0, -X",36878,65039),this.addInst("ld    $r0, Y",32776,65039),this.addInst("ld    $r0, Y+",36873,65039),this.addInst("ld    $r0, -Y",36874,65039),this.addInst("ldd   $r0, Y, $i8",32776,53768),this.addInst("ld    $r0, Z",32768,65039),this.addInst("ld    $r0, Z+",36865,65039),this.addInst("ld    $r0, -Z",36866,65039),this.addInst("ldd   $r0, Z, $i8",32768,53768),this.addInst("ldi   $r3, $i1",57344,61440),this.addInst("lds   $r0, $la",36864,65039,!0),this.addInst("lds   $r3, $i6",40960,63488),this.addInst("lpm",38312,65535),this.addInst("lpm   $r0, Z",36868,65039),this.addInst("lpm   $r0, Z+",36869,65039),this.addInst("lsl   $r6",3072,64512),this.addInst("lsr   $r0",37894,65039),this.addInst("mov   $r0, $r1",11264,64512),this.addInst("movw  $r8, $r9",256,65280),this.addInst("mul   $r0, $r1",39936,64512),this.addInst("muls  $r3, $r12",512,65280),this.addInst("mulsu $r10, $r11",768,65416),this.addInst("neg $r0",37889,65039),this.addInst("nop",0,65535),this.addInst("or    $r0, $r1",10240,64512),this.addInst("ori   $r3, $i1",24576,61440),this.addInst("out   $i5, $r0",47104,63488),this.addInst("pop $r0",36879,65039),this.addInst("push $r0",37391,65039),this.addInst("rcall $ld",53248,61440),this.addInst("ret",38152,65535),this.addInst("reti",38168,65535),this.addInst("rjmp $ld",49152,61440),this.addInst("rol $r6",7168,64512),this.addInst("ror $r0",37895,65039),this.addInst("sbc   $r0, $r1",2048,64512),this.addInst("sbci  $r3, $i1",16384,61440),this.addInst("sbi   $r7, $i9",39424,65280),this.addInst("sbic  $r7, $i9",39168,65280),this.addInst("sbis  $r7, $i9",39680,65280),this.addInst("sbiw  $r2, $i0",38656,65280),this.addInst("sbr   $r3, $i1",24576,61440),this.addInst("sbrc  $r0, $i9",64512,65032),this.addInst("sbrs  $r0, $i9",65024,65032),this.addInst("sec",37896,65535),this.addInst("seh",37976,65535),this.addInst("sei",38008,65535),this.addInst("sen",37928,65535),this.addInst("sec",37896,65535),this.addInst("ser $r3",61199,65295),this.addInst("ses",37960,65535),this.addInst("set",37992,65535),this.addInst("sev",37944,65535),this.addInst("sez",37912,65535),this.addInst("sleep",38280,65535),this.addInst("spm",38376,65535),this.addInst("st    X, $r0",37388,65039),this.addInst("st    X+, $r0",37389,65039),this.addInst("st    -X, $r0",37390,65039),this.addInst("st    Y, $r0",33288,65039),this.addInst("st    Y+, $r0",37385,65039),this.addInst("st    -Y, $r0",37386,65039),this.addInst("std   Y, $i8, $r0",33288,53768),this.addInst("st    Z, $r0",33280,65039),this.addInst("st    Z+, $r0",37377,65039),this.addInst("st    -Z, $r0",37378,65039),this.addInst("std   Z, $i8, $r0",33280,53768),this.addInst("sts   $la, $r0",37376,65039,!0),this.addInst("sts   $i6, $r3",43008,63488),this.addInst("sub   $r0, $r1",6144,64512),this.addInst("subi  $r3, $i1",20480,61440),this.addInst("swap  $r0",37890,65039),this.addInst("tst   $r6",8192,64512),this.addInst("wdr",38312,65535),this.addInst("xch   Z, $r0",37380,65039)}return __extends(r,t),r.prototype.wordSize=function(){return 2},r.prototype.computeStackOffset=function(e,t){return"args"==e?t+2:t+1},r.prototype.is32bit=function(e){return e.is32bit},r.prototype.emit32=function(t,r,n){var i=r>>1;return e.assert(null!=i,"off null"),(0|i)==i&&-65536<=i&&i<=65536?{opcode:t,opcode2:65535&i,stack:0,numArgs:[r],labelName:n}:e.assembler.emitErr("jump out of range",n)},r.prototype.registerNo=function(e){if(!e)return null;e=e.toLowerCase();var t=/^r(\d+)$/.exec(e);if(t){var r=parseInt(t[1],10);if(0<=r&&r<32)return r}return null},r.prototype.postProcessRelAddress=function(e,t){return t+e.baseOffset},r.prototype.postProcessAbsAddress=function(e,t){return t<<1},r.prototype.getAddressFromLabel=function(e,t,r,n){void 0===n&&(n=!1);var i=e.lookupLabel(r);return null==i?null:t.is32bit?i:i-(e.pc()+2)},r.prototype.peephole=function(e,t,r){},r.prototype.toFnPtr=function(e,t){return e>>1},r.prototype.testAssembler=function(){e.assembler.expect(this,"2411       eor\tr1, r1 \nbe1f       out\t0x3f, r1 \nefcf       ldi\tr28, 0xFF \ne0da       ldi\tr29, 0x0A \nbfde       out\t0x3e, r29 \nbfcd      \tout\t0x3d, r28 \n"),e.assembler.expect(this,"0c00      lsl     r0\n920f      push    r0\ne604      ldi     r16, #100        ; 0x64\n903f      pop     r3\n"),e.assembler.expect(this,"1412      cp      r1, r2\nf409      brne    l6\nc001      rjmp    l8\n0e01  l6: add     r0, r17\n0000  l8: nop     \n")},r}(e.assembler.AbstractProcessor);t.AVRProcessor=r}(e.avr||(e.avr={}))}(e.pxtc||(e.pxtc={}))}(ts||(ts={}));var ts;!function(e){!function(e){function t(e){for(var t='"',r=0;r<e.length;++r){var n=255&e.charCodeAt(r),i=String.fromCharCode(n);t+="\\"==i||'"'==i?"\\"+i:"\n"==i?"\\n":n<=15?"\\x0"+n.toString(16):n<32||n>127?"\\x"+n.toString(16):i}return t+'"'}e.decodeBase64=function(e){return atob(e)},e.asmStringLiteral=t;var r=function(){function r(){}return r.prototype.hasCommonalize=function(){return!1},r.prototype.nop=function(){return"TBD(nop)"},r.prototype.reg_gets_imm=function(e,t){return"TBD(reg_gets_imm)"},r.prototype.proc_setup=function(e,t){return"TBD(proc_setup)"},r.prototype.push_fixed=function(e){return"TBD(push_fixed)"},r.prototype.push_local=function(e){return"TBD(push_local)"},r.prototype.push_locals=function(e){return"TBD(push_locals)"},r.prototype.pop_fixed=function(e){return"TBD(pop_fixed)"},r.prototype.pop_locals=function(e){return"TBD(pop_locals)"},r.prototype.proc_return=function(){return"TBD(proc_return)"},r.prototype.debugger_stmt=function(e){return""},r.prototype.debugger_bkpt=function(e){return""},r.prototype.debugger_proc=function(e){return""},r.prototype.unconditional_branch=function(e){return"TBD(unconditional_branch)"},r.prototype.beq=function(e){return"TBD(beq)"},r.prototype.bne=function(e){return"TBD(bne)"},r.prototype.cmp=function(e,t){return"TBD(cmp)"},r.prototype.cmp_zero=function(e){return"TBD(cmp_zero)"},r.prototype.arithmetic=function(){return""},r.prototype.load_reg_src_off=function(e,t,r,n,i,a){return"TBD(load_reg_src_off)"},r.prototype.rt_call=function(e,t,r){return"TBD(rt_call)"},r.prototype.call_lbl=function(e){return"TBD(call_lbl)"},r.prototype.call_reg=function(e){return"TBD(call_reg)"},r.prototype.vcall=function(e,t,r){return"TBD(vcall)"},r.prototype.prologue_vtable=function(e,t){return"TBD(prologue_vtable"},r.prototype.helper_prologue=function(){return"TBD(lambda_prologue)"},r.prototype.helper_epilogue=function(){return"TBD(lambda_epilogue)"},r.prototype.load_ptr=function(e,t){return"TBD(load_ptr)"},r.prototype.load_ptr_full=function(e,t){return"TBD(load_ptr_full)"},r.prototype.emit_int=function(e,t){return"TBD(emit_int)"},r.prototype.string_literal=function(r,n){return"\n.balign 4\n"+r+"meta: .short 0xffff, "+(e.target.taggedInts?pxt.REF_TAG_STRING+",":"")+" "+n.length+"\n"+r+": .string "+t(n)+"\n"},r.prototype.hex_literal=function(t,r){return"\n.balign 4\n"+t+": .short 0xffff, "+(e.target.taggedInts?pxt.REF_TAG_BUFFER+",":"")+" "+(r.length>>1)+"\n        .hex "+r+(r.length%4==0?"":"00")+"\n"},r.prototype.method_call=function(e,t){return""},r}();e.AssemblerSnippets=r,e.numBytes=function(e){for(var t=0,r=e;r>0;r>>>=8)t++;return t||1};var n=function(){function t(t,r,n){var i=this;this.resText="",this.exprStack=[],this.calls=[],this.proc=null,this.baseStackSize=0,this.write=function(t){i.resText+=e.asmline(t)},this.t=t,this.bin=r,this.proc=n,this.work()}return t.prototype.stackSize=function(){return this.baseStackSize+this.exprStack.length},t.prototype.stackAlignmentNeeded=function(t){if(void 0===t&&(t=0),!e.target.stackAlign)return 0;var r=e.target.stackAlign-(this.stackSize()+t&e.target.stackAlign-1);return r==e.target.stackAlign?0:r},t.prototype.alignStack=function(e){void 0===e&&(e=0);var t=this.stackAlignmentNeeded(e);return t?(this.write(this.t.push_locals(t)),this.t.pop_locals(t)):""},t.prototype.getAssembly=function(){return this.resText},t.prototype.work=function(){var t=this;this.write("\n;\n; Function "+this.proc.getName()+"\n;\n"),this.proc.args.length<=3&&this.emitLambdaWrapper(this.proc.isRoot);var r=this.proc.label(),n=r+"_bkpt",i=r+"_locals",a=r+"_end";this.write(".section code"),this.write("\n"+r+":\n    @stackmark func\n    @stackmark args\n"),this.proc.fillDebugInfo=function(r){var s=r.getLabels();t.proc.debugInfo={locals:(1==t.proc.seqNo?t.bin.globals:t.proc.locals).map(function(e){return e.getDebugInfo()}),args:t.proc.args.map(function(e){return e.getDebugInfo()}),name:t.proc.getName(),codeStartLoc:e.U.lookup(s,i),codeEndLoc:e.U.lookup(s,a),bkptLoc:e.U.lookup(s,n),localsMark:e.U.lookup(r.stackAtLabel,i),idx:t.proc.seqNo,calls:t.calls};for(var o=0,l=t.calls;o<l.length;o++){var u=l[o];u.addr=e.U.lookup(s,u.callLabel),u.stack=e.U.lookup(r.stackAtLabel,u.callLabel),u.callLabel=void 0}for(var c=0;c<t.proc.body.length;++c){var p=t.proc.body[c].breakpointInfo;if(p){var d=e.U.lookup(r.stackAtLabel,"__brkp_"+p.id);d!==t.proc.debugInfo.localsMark&&(console.log(p),console.log(r.stackAtLabel),e.U.oops("offset doesn't match: "+d+" != "+t.proc.debugInfo.localsMark))}}},this.bin.options.breakpoints&&this.write(this.t.debugger_proc(n)),this.baseStackSize=1;var s=this.proc.locals.length;this.write(this.t.proc_setup(s)),this.baseStackSize+=s,this.write("@stackmark locals"),this.write(i+":"),this.proc.resolve();for(var o=0;o<this.proc.body.length;++o){var l=this.proc.body[o];switch(l.stmtKind){case e.ir.SK.Expr:this.emitExpr(l.expr);break;case e.ir.SK.StackEmpty:if(this.exprStack.length>0){for(var u=0,c=this.proc.body.slice(o-4,o+1);u<c.length;u++){var p=c[u];console.log("PREVSTMT "+p.toString().trim())}for(var d=0,f=this.exprStack;d<f.length;d++){var m=f[d];console.log("EXPRSTACK "+m.currUses+"/"+m.totalUses+" E: "+m.toString())}e.oops("stack should be empty")}this.write("@stackempty locals");break;case e.ir.SK.Jmp:this.emitJmp(l);break;case e.ir.SK.Label:this.write(l.lblName+":");break;case e.ir.SK.Breakpoint:if(this.bin.options.breakpoints){var h="__brkp_"+l.breakpointInfo.id;l.breakpointInfo.isDebuggerStmt?this.write(this.t.debugger_stmt(h)):this.write(this.t.debugger_bkpt(h))}break;default:e.oops()}}e.assert(0<=s&&s<127),s>0&&this.write(this.t.pop_locals(s)),this.write(a+":"),this.write(this.t.proc_return()),this.write("@stackempty func"),this.write("@stackempty args")},t.prototype.mkLbl=function(e){var t=e+this.bin.lblNo++;return"_"!=t[0]&&(t="."+t),t},t.prototype.terminate=function(t){e.assert(t.exprKind==e.ir.EK.SharedRef);var r=t.args[0];if(r.currUses!=r.totalUses){for(var n=0;n<this.exprStack.length;){var i=this.exprStack[n];if(i!=r&&i.currUses!=i.totalUses)break;n++}e.assert(n>0),this.write("@dummystack "+n),this.write(this.t.pop_locals(n))}},t.prototype.emitJmp=function(t){if(t.jmpMode==e.ir.JmpMode.Always)t.expr&&this.emitExpr(t.expr),t.terminateExpr&&this.terminate(t.terminateExpr),this.write(this.t.unconditional_branch(t.lblName)+" ; with expression");else{var r=this.mkLbl("jmpz");t.jmpMode==e.ir.JmpMode.IfJmpValEq?(this.emitExprInto(t.expr,"r1"),this.write(this.t.cmp("r0","r1"))):(this.emitExpr(t.expr),(t.expr.exprKind!=e.ir.EK.RuntimeCall||"thumb::subs"!==t.expr.data&&!e.U.startsWith(t.expr.data,"_cmp_"))&&this.write(this.t.cmp_zero("r0"))),t.jmpMode==e.ir.JmpMode.IfNotZero?this.write(this.t.beq(r)):this.write(this.t.bne(r)),t.terminateExpr&&this.terminate(t.terminateExpr),this.write(this.t.unconditional_branch(t.lblName)),this.write(r+":")}},t.prototype.clearStack=function(){for(var e=0;this.exprStack.length>0&&this.exprStack[0].currUses==this.exprStack[0].totalUses;)e++,this.exprStack.shift();e&&this.write(this.t.pop_locals(e))},t.prototype.withRef=function(e,t){return e+(t?"Ref":"")},t.prototype.emitExprInto=function(t,r){switch(t.exprKind){case e.ir.EK.NumberLiteral:!0===t.data?this.write(this.t.emit_int(1,r)):!1===t.data?this.write(this.t.emit_int(0,r)):null===t.data?this.write(this.t.emit_int(0,r)):"number"==typeof t.data?this.write(this.t.emit_int(t.data,r)):e.oops();break;case e.ir.EK.PointerLiteral:t.args?this.write(this.t.load_ptr_full(t.data,r)):this.write(this.t.load_ptr(t.data,r));break;case e.ir.EK.SharedRef:var n=t.args[0];e.U.assert(!!n.currUses),e.U.assert(n.currUses<n.totalUses),n.currUses++;var i=this.exprStack.indexOf(n);if(e.U.assert(i>=0),0==i&&n.totalUses==n.currUses)this.write(this.t.pop_fixed([r])+" ; tmpref @"+this.exprStack.length),this.exprStack.shift(),this.clearStack();else{var a=i.toString()+":"+this.exprStack.length;this.write(this.t.load_reg_src_off(r,"sp",a,!0)+" ; tmpref @"+(this.exprStack.length-i))}break;case e.ir.EK.CellRef:var s=t.data;if(s.isGlobal()){var o=this.bitSizeInfo(s.bitSize),l="#"+s.index;(o.needsSignExt||s.index>=o.immLimit)&&(this.write(this.t.emit_int(s.index,r)),l=r),this.write(this.t.load_reg_src_off(r,"r6",l,!1,!1,o))}else{var u=this.cellref(s),c=u[0],p=u[1],d=u[2];this.write(this.t.load_reg_src_off(r,c,p,d))}break;default:e.oops()}},t.prototype.bitSizeInfo=function(t){var r={size:e.sizeOfBitSize(t),immLimit:128};return 1==r.size?r.immLimit=32:2==r.size&&(r.immLimit=64),1!=t&&3!=t||(r.needsSignExt=!0),r},t.prototype.emitExpr=function(t){var r=this;switch(t.exprKind){case e.ir.EK.JmpValue:this.write("; jmp value (already in r0)");break;case e.ir.EK.Nop:this.write(this.t.nop());break;case e.ir.EK.Incr:this.emitExpr(t.args[0]),this.emitCallRaw("pxt::incr");break;case e.ir.EK.Decr:this.emitExpr(t.args[0]),this.emitCallRaw("pxt::decr");break;case e.ir.EK.FieldAccess:var n=t.data;return this.emitExpr(e.ir.rtcall(this.withRef("pxtrt::ldfld",n.isRef),[t.args[0],e.ir.numlit(n.idx)]));case e.ir.EK.Store:return this.emitStore(t.args[0],t.args[1]);case e.ir.EK.RuntimeCall:return this.emitRtCall(t);case e.ir.EK.ProcCall:return this.emitProcCall(t);case e.ir.EK.SharedDef:return this.emitSharedDef(t);case e.ir.EK.Sequence:return t.args.forEach(function(e){return r.emitExpr(e)}),this.clearStack();default:return this.emitExprInto(t,"r0")}},t.prototype.emitSharedDef=function(t){var r=t.args[0];if(e.U.assert(r.totalUses>=1),e.U.assert(0===r.currUses),r.currUses=1,1==r.totalUses)return this.emitExpr(r);this.emitExpr(r),this.exprStack.unshift(r),this.write(this.t.push_local("r0")+"; tmpstore @"+this.exprStack.length)},t.prototype.emitSharedTerminate=function(e){this.emitExpr(e);e.data},t.prototype.emitRtCall=function(t){var r=this,n=e.ir.flattenArgs(t);n.precomp.forEach(function(e){return r.emitExpr(e)}),n.flattened.forEach(function(t,n){e.U.assert(n<=3),r.emitExprInto(t,"r"+n)}),this.clearStack();var i=t.data;"langsupp::ignore"!=i&&(e.U.startsWith(i,"thumb::")?this.write(this.t.rt_call(i.slice(7),"r0","r1")):this.alignedCall(i))},t.prototype.alignedCall=function(e,t){void 0===t&&(t="");var r=this.alignStack();this.write(this.t.call_lbl(e)+t),this.write(r)},t.prototype.emitHelper=function(e){if(!this.bin.codeHelpers[e]){var t=Object.keys(this.bin.codeHelpers).length;this.bin.codeHelpers[e]="_hlp_"+t}this.write(this.t.call_lbl(this.bin.codeHelpers[e]))},t.prototype.emitProcCall=function(t){var r=this,n=0,i=!1,a=t.args.map(function(e,t){return r.emitExpr(e),r.write(r.t.push_local("r0")+" ; proc-arg"),e.totalUses=1,e.currUses=0,r.exprStack.unshift(e),0==t&&(n=r.exprStack.length),r.exprStack.length-n!=t&&(i=!0),e});if(this.stackAlignmentNeeded()&&(i=!0),i){var s=this.stackAlignmentNeeded(a.length);if(s){this.write(this.t.push_locals(s));for(var o=0;o<s;++o){var l=e.ir.numlit(0);l.totalUses=1,l.currUses=1,this.exprStack.unshift(l)}}for(var u=0,c=a;u<c.length;u++){var p=c[u],d=this.exprStack.indexOf(p);e.assert(d>=0),this.write(this.t.load_reg_src_off("r0","sp",d.toString(),!0)+" ; repush"),this.write(this.t.push_local("r0")+" ; repush"),this.exprStack.unshift(p)}}var f=this.mkLbl("_proccall"),m=t.data,h=-1;if(null!=m.virtualIndex||null!=m.ifaceIndex){var g=this.t.method_call(m,t);if(g)this.write(g),this.write(f+":");else if(m.mapMethod){var b=/Set/.test(m.mapMethod);e.assert(b==(2==t.args.length)),e.assert(!b==(1==t.args.length)),this.write(this.t.emit_int(m.mapIdx,"r1")),b&&this.write(this.t.emit_int(m.ifaceIndex,"r2")),this.emitHelper(this.t.vcall(m.mapMethod,b,e.vtableShift)),this.write(f+":")}else{this.write(this.t.prologue_vtable(t.args.length-1,e.vtableShift));var v=m.virtualIndex+4;null!=m.ifaceIndex&&(this.write(this.t.load_reg_src_off("r0","r0","#4")+" ; iface table"),v=m.ifaceIndex),v<=31?this.write(this.t.load_reg_src_off("r0","r0",v.toString(),!0)+" ; ld-method"):(this.write(this.t.emit_int(4*v,"r1")),this.write(this.t.load_reg_src_off("r0","r0","r1")+" ; ld-method")),this.write(this.t.call_reg("r0")),this.write(f+":")}}else{var y=m.proc;h=y.seqNo,this.write(this.t.call_lbl(y.label())),this.write(f+":")}this.calls.push({procIndex:h,stack:0,addr:0,callLabel:f});for(var k=0,x=a;k<x.length;k++)(p=x[k]).currUses=1;this.clearStack()},t.prototype.emitStore=function(t,r){switch(t.exprKind){case e.ir.EK.CellRef:var n=t.data;if(this.emitExpr(r),n.isGlobal()){var i=this.bitSizeInfo(n.bitSize),a="#"+n.index;n.index>=i.immLimit&&(this.write(this.t.emit_int(n.index,"r1")),a="r1"),this.write(this.t.load_reg_src_off("r0","r6",a,!1,!0,i))}else{var s=this.cellref(n),o=s[0],l=s[1],a=s[2];this.write(this.t.load_reg_src_off("r0",o,l,a,!0))}break;case e.ir.EK.FieldAccess:var u=t.data;this.emitExpr(e.ir.rtcall(this.withRef("pxtrt::stfld",u.isRef),[t.args[0],e.ir.numlit(u.idx),r]));break;default:e.oops()}},t.prototype.cellref=function(t){if(t.isGlobal())throw e.oops();return t.iscap?(e.assert(0<=t.index&&t.index<32),["r5",t.index.toString(),!0]):t.isarg?["sp","args@"+(this.proc.args.length-t.index-1).toString()+":"+this.baseStackSize,!1]:["sp","locals@"+t.index,!1]},t.prototype.emitLambdaWrapper=function(t){var r=this;this.proc.action;this.write(""),this.write(".section code"),e.isAVR()?this.write(this.proc.label()+"_Lit:"):(t&&this.write(this.t.unconditional_branch(".themain")),this.write(".balign 4"),this.write(this.proc.label()+"_Lit:"),this.write(".short 0xffff, "+pxt.REF_TAG_ACTION+"   ; action literal"),t&&this.write(".themain:")),this.write("@stackmark litfunc");var n=this.proc.args.map(function(e){return e.def});this.write(this.t.proc_setup(0,!0)),this.t.hasCommonalize()?this.write(this.t.push_fixed(["r5","r6","r7"])):this.write(this.t.push_fixed(["r5","r6"])),this.baseStackSize=4;var i=n.length,a=this.stackAlignmentNeeded(n.length);a&&(this.write(this.t.push_locals(a)),i+=a),n.forEach(function(t,n){n>=3&&e.U.userError(e.U.lf("only up to three parameters supported in lambdas")),r.write(r.t.push_local("r"+(n+1)))});var s=this.t.helper_prologue();this.proc.args.forEach(function(e,t){if(e.isRef()){var n=r.cellref(e),i=n[0],a=n[1],o=n[2];s+=r.t.load_reg_src_off("r0",i,a,o)+"\n",s+=r.t.call_lbl("pxt::incr")+"\n"}}),s+=this.t.helper_epilogue(),this.emitHelper(s),this.write(this.t.call_lbl(this.proc.label())),i&&this.write(this.t.pop_locals(i)),this.t.hasCommonalize()?this.write(this.t.pop_fixed(["r6","r5","r7"])):this.write(this.t.pop_fixed(["r6","r5"])),this.write(this.t.proc_return()),this.write("@stackempty litfunc")},t.prototype.emitCallRaw=function(t){var r=e.hex.lookupFunc(t);e.assert(!!r,"unimplemented raw function: "+t),this.alignedCall(t)},t}();e.ProctoAssembler=n}(e.pxtc||(e.pxtc={}))}(ts||(ts={}));var ts;!function(e){!function(e){var t=function(t){function r(){t.apply(this,arguments),this.rmap_lo={r0:"r24",r1:"r22",r2:"r20",r3:"r18",r5:"r4",r6:"r2"},this.rmap_hi={r0:"r25",r1:"r23",r2:"r21",r3:"r19",r5:"r5",r6:"r3"},this.inst_lo={adds:"add",subs:"sub",ands:"and",orrs:"or",eors:"eor",muls:"Number_::",lsls:"Number_::",asrs:"Number_::",lsrs:"Number_::"},this.inst_hi={adds:"adc",subs:"sbc",ands:"and",orrs:"or",eors:"eor"}}return __extends(r,t),r.prototype.nop=function(){return"nop"},r.prototype.reg_gets_imm=function(e,t){var r=255&t,n=(65280&t)>>8;return"\n    ldi "+this.rmap_lo[e]+", #"+r+"\n    ldi "+this.rmap_hi[e]+", #"+n},r.prototype.push_fixed=function(e){var t=this,r="";return e.forEach(function(e){r=r+"\npush "+t.rmap_hi[e]+"\npush "+t.rmap_lo[e]}),r+="\n    @dummystack "+e.length},r.prototype.pop_fixed=function(e){var t=this,r="";return e.forEach(function(e){r=r+"\npop "+t.rmap_lo[e]+"\npop "+t.rmap_hi[e]}),r+="\n    @dummystack -"+e.length},r.prototype.proc_setup=function(e,t){var r=t?"clr r1":"";r+="\n    push r29\n    push r28";for(var n=0;n<e;++n)r+="\n    push r1\n    push r1";return r+="\n    @dummystack "+(e+1)+"\n    in r28, 0x3d\n    in r29, 0x3e\n    subi r28, #5\n    sbci r29, #0"},r.prototype.proc_return=function(){return"\n    pop r28\n    pop r29\n    @dummystack -1\n    ret"},r.prototype.debugger_hook=function(e){return"eor r1, r1"},r.prototype.debugger_bkpt=function(e){return"eor r1, r1"},r.prototype.breakpoint=function(){return"eor r1, r1"},r.prototype.push_local=function(e){return"\n    push "+this.rmap_hi[e]+"\n    push "+this.rmap_lo[e]+"\n    @dummystack 1"},r.prototype.push_locals=function(e){return"no stack alignment on AVR"},r.prototype.pop_locals=function(t){if(2*t<=5)return e.Util.range(2*t).map(function(e){return"pop r0"}).join("\n    ")+"\n    @dummystack -"+t;for(var r=t,n="\n    in\tr30, 0x3d\n    in\tr31, 0x3e\n";t>0;){var i=Math.min(t,31);n+="    adiw\tr30, #2*"+i+"\n",t-=i}return n+="\n    out\t0x3d, r30\n    out\t0x3e, r31\n    @dummystack -"+r},r.prototype.unconditional_branch=function(e){return"jmp "+e},r.prototype.beq=function(e){return"breq "+e},r.prototype.bne=function(e){return"brne "+e},r.prototype.cmp=function(e,t){var r=this.rmap_lo[e],n=this.rmap_hi[e];return"\n    cp "+r+", "+this.rmap_lo[t]+"\n    cpc "+n+", "+this.rmap_hi[t]},r.prototype.cmp_zero=function(e){return"\n    cp "+this.rmap_lo[e]+", r1\n    cpc "+this.rmap_hi[e]+", r1"},r.prototype.load_reg_src_off=function(t,r,n,i,a,s){function o(t){if(e.assert(!isNaN(t)),0<=t&&t<=62)n=t.toString();else{for("Y"==l&&(u+="\n    movw r30, r28\n"),u+="\n    ; += "+t;t>0;){var r=Math.min(t,63);u+="\n    adiw r30, #"+r,t-=r}n="0",l="Z"}}var l="",u="",c=/^(\d+):(\d+)/.exec(n);if(c){var p=parseInt(c[1]),d=parseInt(c[2])-p;d<=3&&(n="locals@-"+d,i=!1)}if("sp"!=r?(u="\n    movw r30, "+this.rmap_lo[r],l="Z"):l="Y",i||"#"==n[0]){f=0;f=i?2*parseInt(n):parseInt(n.slice(1)),e.assert(!isNaN(f),"off="+n+"/"+i),"sp"==r&&(f+=1,u+="\n    in  r30, 0x3d\n    in  r31, 0x3e",l="Z"),o(f)}else if("r"==n[0])"Y"==l&&(u+="\n    movw r30, r28"),u+="\n    add r30, "+this.rmap_lo[n]+"\n    adc r31, "+this.rmap_hi[n],n="0";else{e.assert("Y"==l);var f=-1e5,m=/^args@(\d+):(\d+)$/.exec(n);m&&(f=2*(parseInt(m[1])+(parseInt(m[2])+1))),(m=/^locals@([\-\d]+)$/.exec(n))&&(f=2*parseInt(m[1])),u+="\n; "+n,f+=6,e.assert(f>=0),o(f)}return s&&1==s.size?a?"\n    "+u+"\n    std "+l+", "+n+", "+this.rmap_lo[t]:s.needsSignExt?"\n    "+u+"\n    ldd "+this.rmap_lo[t]+", "+l+", "+n+"\n    clr "+this.rmap_hi[t]+"\n    sbrc "+this.rmap_lo[t]+", 7\n    com "+this.rmap_hi[t]:"\n    "+u+"\n    ldd "+this.rmap_lo[t]+", "+l+", "+n+"\n    clr "+this.rmap_hi[t]+"\n    ":a?"\n    "+u+"\n    std "+l+", "+n+", "+this.rmap_lo[t]+"\n    std "+l+", "+n+"+1, "+this.rmap_hi[t]:"\n    "+u+"\n    ldd "+this.rmap_lo[t]+", "+l+", "+n+"\n    ldd "+this.rmap_hi[t]+", "+l+", "+n+"+1"},r.prototype.rt_call=function(t,r,n){return e.assert("r0"==r&&"r1"==n),"Number_::"==this.inst_lo[t]?this.call_lbl("Number_::"+t):"\n    "+this.inst_lo[t]+" r24, r22\n    "+this.inst_hi[t]+" r25, r23"},r.prototype.call_lbl=function(e){return"call "+e},r.prototype.call_reg=function(e){return"\n    movw r30, "+this.rmap_lo[e]+"\n    icall"},r.prototype.vcall=function(t,r,n){return e.assert(!1),""},r.prototype.prologue_vtable=function(t,r){return e.assert(!1),""},r.prototype.method_call=function(e,t){var r=this.load_reg_src_off("r0","sp","#"+2*(t.args.length-1))+"\n",n=!1,i=0;return e.mapMethod?(n=!0,i=/Set/.test(e.mapMethod)?e.ifaceIndex:e.mapIdx):(i=e.virtualIndex+2,null!=e.ifaceIndex&&(n=!0,i=e.ifaceIndex)),r+=this.emit_int(i,"r1")+"\n",r+=this.call_lbl("pxtrt::fetchMethod"+(n?"Iface":""))+"\n",r+=this.call_reg("r0")+"\n"},r.prototype.helper_prologue=function(){return"\n    @stackmark args\n    movw r4, r24"},r.prototype.helper_epilogue=function(){return"\n    call pxtrt::getGlobalsPtr\n    movw r2, r24\n    ret\n    @stackempty args"},r.prototype.load_ptr=function(t,r){return e.assert(!!t),"\n    ldi "+this.rmap_lo[r]+", "+t+"@lo\n    ldi "+this.rmap_hi[r]+", "+t+"@hi"},r.prototype.emit_int=function(e,t){return this.reg_gets_imm(t,e)},r.prototype.string_literal=function(t,r){return"\n.balign 2\n"+t+"meta: .short "+r.length+"\n"+t+": .string "+e.asmStringLiteral(r)+"\n"},r.prototype.hex_literal=function(e,t){return"\n.balign 2\n"+e+": .short "+(t.length>>1)+"\n        .hex "+t+(t.length%4==0?"":"00")+"\n"},r}(e.AssemblerSnippets);e.AVRSnippets=t}(e.pxtc||(e.pxtc={}))}(ts||(ts={}));var ts;!function(e){!function(e){function t(e){return"PXT."+(e=e.replace(/::/g,"."))}function r(e){return JSON.stringify(e)}function n(t){for(var n="static readonly VTable "+t.id+"_VT = new VTable("+r(e.getName(t.decl))+",   "+t.refmask.length+", new FnPtr[] {\n",i=0,a=t.vtable;i<a.length;i++)n+="    "+(u=a[i]).label()+",\n";n+="  },\n",n+="  new FnPtr[] {\n";for(var s=0,o=0,l=t.itable;o<l.length;o++){var u=l[o];n+="    "+(u?u.label():"null")+",  // "+(t.itableInfo[s]||".")+"\n",s++}return n+="});\n"}function i(r,n){function i(e){return e.isGlobal()?"g_"+e.uniqueName():e.iscap?"s.mycaps["+e.index+"]":"s."+e.uniqueName()}function s(e,t){return e+(t?"Ref":"")}function o(t){switch(t.exprKind){case b.NumberLiteral:if(!0===t.data)return"TValue.True";if(!1===t.data)return"TValue.False";if(null===t.data)return"TValue.Null";if(void 0===t.data)return"TValue.Undefined";if("number"==typeof t.data)return"(double)("+t.data+")";throw e.oops("invalid data: "+typeof t.data);case b.PointerLiteral:return t.jsInfo;case b.SharedRef:var r=t.args[0];e.U.assert(!!r.currUses),e.U.assert(r.currUses<r.totalUses),r.currUses++;var n=x.indexOf(r);return e.U.assert(n>=0),"s.tmp_"+n;case b.CellRef:return i(t.data);default:throw e.oops()}}function l(t){switch(t.exprKind){case b.JmpValue:g("// jmp value (already in r0)");break;case b.Nop:g("// nop");break;case b.Incr:case b.Decr:l(t.args[0]);break;case b.FieldAccess:var r=t.data;return r.shimName?(l(t.args[0]),void g("r0 = r0"+r.shimName+";")):l(e.ir.rtcall(s("pxtrt::ldfld",r.isRef),[t.args[0],e.ir.numlit(r.idx)]));case b.Store:return f(t.args[0],t.args[1]);case b.RuntimeCall:return c(t);case b.ProcCall:return p(t);case b.SharedDef:return u(t);case b.Sequence:return t.args.forEach(l);default:g("r0 = "+o(t)+";")}}function u(t){var r=t.args[0];if(e.U.assert(r.totalUses>=1),e.U.assert(0===r.currUses),r.currUses=1,1==r.totalUses)return l(r);l(r);var n=x.length;x.push(r),v=Math.max(v,x.length),g("s.tmp_"+n+" = r0;")}function c(r){var i=e.ir.flattenArgs(r);i.precomp.forEach(l);var s=r.data;s=e.U.lookup(a,s)||s;var u=i.flattened.map(o);if("langsupp::ignore"!=s){var c=r.callingConvention!=e.ir.CallingConvention.Plain,p=e.hex.lookupFunc(s),d=p?p.argsFmt:"";p||pxt.log("warning, missing //%: "+s);var f="object",m=!1;if(d){var v=d.split(";").filter(function(e){return!!e});"async"==v[0]&&(c=!0,v.shift()),f=v.shift(),"CTX"==v[0]&&(m=!0,v.shift()),u=u.map(function(e,t){var r=v[t];if("#"==r[0]){r=r.slice(1);var n=i.flattened[t].data;if(i.flattened[t].exprKind==b.NumberLiteral&&"number"==typeof n){if("double"==r||"float"==r)return n.toString();if((0|n)==n&&("int"==r||"uint"==r&&n>=0))return n.toString()}e="numops.toDouble("+e+")"}return"object"!=r&&(e="(("+r+")("+e+"))"),e})}m&&u.unshift("s");var y="";if(y="."==s[0]?""+u[0]+s+"("+u.slice(1).join(", ")+")":e.U.startsWith(s,"new ")?"new "+t(s.slice(4))+"("+u.join(", ")+")":t(s)+"("+u.join(", ")+")",c){var k=++E;I.push(k),g("s.pc = "+k+";"),g(y+".ContinueWith("+n.label()+"_delegate, (object)s);"),g("return;"),h("  case "+k+":\n"),y="void"==f?"/* void */":"((Task<"+f+">)prevTask).Result"}"#"==f[0]&&(y="(double)("+y+")"),g("void"==f?y+";":"r0 = "+y+";")}}function p(r){var i=r.data,a=i.proc,s=++E,o="s.callArgs_"+S;g(o+" = new object["+r.args.length+"];"),++S>T&&(T=S),r.args.forEach(function(e,t){l(e),g(o+"["+t+"] = r0;")}),g("s.pc = "+s+";");var u="(s, "+o+").ContinueWith("+n.label()+"_delegate, s)";if(null!=i.ifaceIndex){if(i.mapMethod){g("if ("+o+"[0] is PXT.RefMap) {");var c=r.args.map(function(e,t){return o+"["+t+"]"});c[0]="(PXT.RefMap)"+c[0],c.splice(1,0,i.mapIdx.toString()),g("  s.retval = "+t(i.mapMethod).replace("Ref","")+"("+c.join(", ")+");"),g("  goto case "+s+";"),g("} else {")}g("PXT.pxtrt.getVT("+o+"[0]).iface["+i.ifaceIndex+"]"+u+";"),i.mapMethod&&g("}")}else null!=i.virtualIndex?(e.assert(i.virtualIndex>=0),g("PXT.pxtrt.getVT("+o+"[0]).methods["+i.virtualIndex+"]"+u+";")):g(""+a.label()+u+";");g("return;"),h("  case "+s+":"),g("r0 = s.retval;"),S--}function d(t){switch(t){case 0:return"";case 1:return"PXT.pxtrt.toInt8";case 3:return"PXT.pxtrt.toInt16";case 5:return"PXT.pxtrt.toInt32";case 2:return"PXT.pxtrt.toUInt8";case 4:return"PXT.pxtrt.toUInt16";case 6:return"PXT.pxtrt.toUInt32";default:throw e.oops()}}function f(t,r){switch(t.exprKind){case b.CellRef:var n=t.data;l(r);var a=d(n.bitSize);g(a?i(n)+" = "+a+"(PXT.numops.toDouble(r0));":i(n)+" = r0;");break;case b.FieldAccess:var o=t.data;l(e.ir.rtcall(s("pxtrt::stfld",o.isRef),[t.args[0],e.ir.numlit(o.idx),r]));break;default:e.oops()}}var m="",h=function(e){m+=e+"\n"},g=function(e){m+="    "+e+"\n"},b=e.ir.EK,v=0,y=n.label()+"_CTX";n.resolve(),r.procs[0]==n&&h("\n\npublic static void Main() { "+n.label()+"(new CTX(0), null).GetAwaiter().GetResult(); }\n");var k=n.args.map(function(e,t){return"    "+i(e)+" = "+t+" >= args.Length ? TValue.Undefined : args["+t+"];\n"}).join("");h("\nstatic Action<Task, object> "+n.label()+"_delegate;\nstatic Task "+n.label()+"(CTX parent, object[] args) {\n    var s = new "+y+"(parent);\n    if ("+n.label()+"_delegate == null) {\n        "+n.label()+"_delegate = "+n.label()+"_task;\n    }\n"+k+"\n    "+n.label()+"_task(null, s);\n    return s.completion.Task;\n}\n\nstatic void "+n.label()+"_task(Task prevTask, object s_) {\n    var s = ("+y+")s_;\n    var r0 = TValue.Undefined;\n    var step = s.pc;\n    s.pc = -1;\n\n    while (true) {\n    switch (step) {\n    case 0:\n");for(var x=[],S=0,T=-1,E=0,I=[],w=0,_=n.body;w<_.length;w++)(L=_[w]).stmtKind==e.ir.SK.Label&&(L.lblId=++E);for(var K=0,N=n.body;K<N.length;K++){var L=N[K];switch(L.stmtKind){case e.ir.SK.Expr:l(L.expr);break;case e.ir.SK.StackEmpty:for(var C=0,U=x;C<U.length;C++){var A=U[C];A.totalUses!==A.currUses&&e.oops()}x=[];break;case e.ir.SK.Jmp:!function(t){var r="goto case "+t.lbl.lblId+";";t.jmpMode==e.ir.JmpMode.Always?(t.expr&&l(t.expr),g(r)):t.jmpMode==e.ir.JmpMode.IfJmpValEq?g("if (r0.Eq("+o(t.expr)+")) "+r):(l(t.expr),g(t.jmpMode==e.ir.JmpMode.IfNotZero?"if (numops.toBool(r0)) "+r:"if (!numops.toBool(r0)) "+r))}(L);break;case e.ir.SK.Label:g("goto case "+L.lblId+";"),h("case "+L.lblId+":");break;case e.ir.SK.Breakpoint:!function(e){var t,i=e.breakpointInfo.id;if(g("s.lastBrkId = "+i+";"),r.options.trace)t=++E,g("s.Trace("+i+", "+t+", "+n.label()+"_info);");else{if(!r.options.breakpoints)return;var a="s.Breakpoint("+(t=++E)+", "+i+", r0);";g(e.breakpointInfo.isDebuggerStmt?a:"if ((breakAlways && s.IsBreakFrame()) || breakpoints["+i+"]) "+a)}h("case "+t+": // BRK")}(L);break;default:e.oops()}}g("s.Leave(r0);"),g("return;"),h('  default: PXT.Util.check(false, "invalid pc: " + step); return;\n} } }');var $=e.nodeLocationInfo(n.action);$.functionName=n.getName(),h("// "+n.label()+".info = "+JSON.stringify($)),h("\nclass "+y+" : CTX {\n    public "+y+"(CTX parent) : base(parent) {}");for(var F=0,P=n.locals.concat(n.args);F<P.length;F++){var D=P[F];g("public object "+D.uniqueName()+";")}for(R=0;R<v;++R)g("public object tmp_"+R+";");for(var R=0;R<T;++R)g("public object[] callArgs_"+R+";");return h("}\n"),m}var a={"numops::toBoolDecr":"numops::toBool","pxtrt::ldfldRef":"pxtrt::ldfld","pxtrt::stfldRef":"pxtrt::stfld","pxtrt::ldlocRef":"pxtrt::ldloc","pxtrt::stlocRef":"pxtrt::stloc","pxtrt::mklocRef":"pxtrt::mkloc","pxtrt::mapSetRef":"pxtrt::mapSet","pxtrt::mapGetRef":"pxtrt::mapGet"};e.csEmit=function(t,r){var a=r.hexinfo.hex[0];a+="\n// User code starts\n\n#pragma warning disable CS0164, CS1998, CS0219, CS0414, CS0162\n\nnamespace PXT {\npublic static class UserCode {\n",t.globals.forEach(function(e){a+="static object g_"+e.uniqueName()+";\n"}),t.procs.forEach(function(e){a+="\n"+i(t,e)+"\n"}),t.usedClassInfos.forEach(function(e){a+=n(e)}),e.U.iterMap(t.hexlits,function(e,t){a+="static readonly Buffer "+t+' = PXT.BufferMethods.createBufferFromHex("'+e+'");\n'}),a+="\n} } // end UserCode\n",t.writeFile(e.BINARY_CS,a)}}(e.pxtc||(e.pxtc={}))}(ts||(ts={}));var ts;!function(e){!function(e){function t(t){return"pxt."==(t=t.replace(/::/g,".")).slice(0,4)&&(t="pxtcore."+t.slice(4)),e.target.shortPointers&&(t=t.replace(/^thumb\./,"avr.")),"pxsim."+t}function r(t){for(var r="var "+t.id+"_VT = {\n  name: "+JSON.stringify(e.getName(t.decl))+",\n  refmask: "+JSON.stringify(t.refmask)+",\n  methods: [\n",n=0,i=t.vtable;n<i.length;n++)r+="    "+(l=i[n]).label()+",\n";r+="  ],\n",r+="  iface: [\n";for(var a=0,s=0,o=t.itable;s<o.length;s++){var l=o[s];r+="    "+(l?l.label():"null")+",  // "+(t.itableInfo[a]||".")+"\n",a++}return r+="  ],\n",r+="};\n"}function n(r,n){function a(e){return e.isGlobal()?"globals."+e.uniqueName():e.iscap?"s.caps["+e.index+"]":"s."+e.uniqueName()}function s(e,t){return e+(t?"Ref":"")}function o(t){switch(t.exprKind){case b.NumberLiteral:if(!0===t.data)return"true";if(!1===t.data)return"false";if(null===t.data)return"null";if(void 0===t.data)return"undefined";if("number"==typeof t.data)return t.data+"";throw e.oops("invalid data: "+typeof t.data);case b.PointerLiteral:return t.jsInfo;case b.SharedRef:var r=t.args[0];e.U.assert(!!r.currUses),e.U.assert(r.currUses<r.totalUses),r.currUses++;var n=y.indexOf(r);return e.U.assert(n>=0),"s.tmp_"+n;case b.CellRef:return a(t.data);default:throw e.oops()}}function l(t){switch(t.exprKind){case b.JmpValue:g("// jmp value (already in r0)");break;case b.Nop:g("// nop");break;case b.Incr:l(t.args[0]),v&&g("pxtrt.incr(r0);");break;case b.Decr:l(t.args[0]),v&&g("pxtrt.decr(r0);");break;case b.FieldAccess:var r=t.data;return r.shimName?(e.assert(!v),l(t.args[0]),void g("r0 = r0"+r.shimName+";")):l(e.ir.rtcall(s("pxtrt::ldfld",r.isRef),[t.args[0],e.ir.numlit(r.idx)]));case b.Store:return f(t.args[0],t.args[1]);case b.RuntimeCall:return c(t);case b.ProcCall:return p(t);case b.SharedDef:return u(t);case b.Sequence:return t.args.forEach(l);default:g("r0 = "+o(t)+";")}}function u(t){var r=t.args[0];if(e.U.assert(r.totalUses>=1),e.U.assert(0===r.currUses),r.currUses=1,1==r.totalUses)return l(r);l(r);var n=y.length;y.push(r),g("s.tmp_"+n+" = r0;")}function c(n){var a=e.ir.flattenArgs(n);a.precomp.forEach(l);var s=n.data,u=a.flattened.map(o),c="";if(c="."==s[0]?""+u[0]+s+"("+u.slice(1).join(", ")+")":e.U.startsWith(s,"new ")?"new "+t(s.slice(4))+"("+u.join(", ")+")":2==u.length&&r.target.floatingPoint&&e.U.lookup(i,s)?"("+u[0]+" "+e.U.lookup(i,s)+" "+u[1]+")":t(s)+"("+u.join(", ")+")",n.callingConvention==e.ir.CallingConvention.Plain)g("r0 = "+c+";");else{var p=++k;x.push(p),n.callingConvention==e.ir.CallingConvention.Promise?g("(function(cb) { "+c+".done(cb) })(buildResume(s, "+p+"));"):(g("setupResume(s, "+p+");"),g(c+";")),g("checkResumeConsumed();"),g("return;"),h("  case "+p+":"),g("r0 = s.retval;")}}function p(r){var n=e.ir.rtcall("<frame>",[]);n.totalUses=1,n.currUses=0;var i=y.length;y.push(n);var a=r.data,s=a.proc,o="s.tmp_"+i,u=++k;if(g(o+" = { fn: "+(s?s.label():null)+", parent: s };"),r.args.forEach(function(e,t){l(e),g(o+".arg"+t+" = r0;")}),g("s.pc = "+u+";"),null!=a.ifaceIndex){if(a.mapMethod){g("if ("+o+".arg0.vtable === 42) {");var c=r.args.map(function(e,t){return o+".arg"+t});c.splice(1,0,a.mapIdx.toString()),g("  s.retval = "+t(a.mapMethod)+"("+c.join(", ")+");"),g("  "+o+".fn = doNothing;"),g("} else {")}g("pxsim.check(typeof "+o+'.arg0  != "number", "Can\'t access property of null/undefined.")'),g(o+".fn = "+o+".arg0.vtable.iface["+a.ifaceIndex+"];"),a.mapMethod&&g("}")}else null!=a.virtualIndex&&(e.assert(a.virtualIndex>=0),g("pxsim.check(typeof "+o+'.arg0  != "number", "Can\'t access property of null/undefined.")'),g(o+".fn = "+o+".arg0.vtable.methods["+a.virtualIndex+"];"));g("return actionCall("+o+")"),h("  case "+u+":"),g("r0 = s.retval;"),n.currUses=1}function d(t){switch(t){case 0:return"";case 1:return"pxsim.pxtrt.toInt8";case 3:return"pxsim.pxtrt.toInt16";case 5:return"pxsim.pxtrt.toInt32";case 2:return"pxsim.pxtrt.toUInt8";case 4:return"pxsim.pxtrt.toUInt16";case 6:return"pxsim.pxtrt.toUInt32";default:throw e.oops()}}function f(t,r){switch(t.exprKind){case b.CellRef:var n=t.data;l(r),g(a(n)+" = "+d(n.bitSize)+"(r0);");break;case b.FieldAccess:var i=t.data;l(e.ir.rtcall(s("pxtrt::stfld",i.isRef),[t.args[0],e.ir.numlit(i.idx),r]));break;default:e.oops()}}var m="",h=function(e){m+=e+"\n"},g=function(e){m+="    "+e+"\n"},b=e.ir.EK,v=!!r.target.jsRefCounting;h("\nvar "+n.label()+" "+(r.procs[0]==n?"= entryPoint":"")+" = function (s) {\nvar r0 = s.r0, step = s.pc;\ns.pc = -1;\nwhile (true) {\nif (yieldSteps-- < 0 && maybeYield(s, step, r0)) return null;\nswitch (step) {\n  case 0:\n"),n.resolve(),n.locals.forEach(function(t){g(a(t)+" = "+(e.target.floatingPoint?"undefined":"0")+";")}),n.args.length&&(g("if (s.lambdaArgs) {"),n.args.forEach(function(e,t){g("  "+a(e)+" = "+(e.isRef()?"pxtrt.incr":"")+"(s.lambdaArgs["+t+"]);")}),g("  s.lambdaArgs = null;"),g("}"));for(var y=[],k=0,x=[],S=0,T=n.body;S<T.length;S++)(w=T[S]).stmtKind==e.ir.SK.Label&&(w.lblId=++k);for(var E=0,I=n.body;E<I.length;E++){var w=I[E];switch(w.stmtKind){case e.ir.SK.Expr:l(w.expr);break;case e.ir.SK.StackEmpty:for(var _=0,K=y;_<K.length;_++){var N=K[_];N.totalUses!==N.currUses&&e.oops()}y=[];break;case e.ir.SK.Jmp:!function(t){var r="{ step = "+t.lbl.lblId+"; continue; }";t.jmpMode==e.ir.JmpMode.Always?(t.expr&&l(t.expr),g(r)):t.jmpMode==e.ir.JmpMode.IfJmpValEq?g("if (r0 == ("+o(t.expr)+")) "+r):(l(t.expr),g(t.jmpMode==e.ir.JmpMode.IfNotZero?"if (r0) "+r:"if (!r0) "+r))}(w);break;case e.ir.SK.Label:h("  case "+w.lblId+":");break;case e.ir.SK.Breakpoint:!function(e){var t,i=e.breakpointInfo.id;if(g("s.lastBrkId = "+i+";"),r.options.trace)t=++k,g("return trace("+i+", s, "+t+", "+n.label()+".info);");else{if(!r.options.breakpoints)return;var a="return breakpoint(s, "+(t=++k)+", "+i+", r0);";g(e.breakpointInfo.isDebuggerStmt?a:"if ((breakAlways && isBreakFrame(s)) || breakpoints["+i+"]) "+a)}h("  case "+t+":")}(w);break;default:e.oops()}}g("return leave(s, r0)"),h("  default: oops()"),h("} } }");var L=e.nodeLocationInfo(n.action);return L.functionName=n.getName(),h(n.label()+".info = "+JSON.stringify(L)),n.isRoot&&h(n.label()+".continuations = [ "+x.join(",")+" ]"),m}var i={"numops::adds":"+","numops::subs":"-","numops::div":"/","numops::mod":"%","numops::muls":"*","numops::ands":"&","numops::orrs":"|","numops::eors":"^","numops::lsls":"<<","numops::asrs":">>","numops::lsrs":">>>","numops::le":"<=","numops::lt":"<","numops::lt_bool":"<","numops::ge":">=","numops::gt":">","numops::eq":"==","pxt::eq_bool":"==","pxt::eqq_bool":"===","numops::eqq":"===","numops::neqq":"!==","numops::neq":"!=","langsupp::ptreq":"==","langsupp::ptreqq":"===","langsupp::ptrneqq":"!==","langsupp::ptrneq":"!="};e.isBuiltinSimOp=function(t){return!!e.U.lookup(i,t.replace(/\./g,"::"))},e.shimToJs=t,e.jsEmit=function(t){var i="";t.target.jsRefCounting||(i+="pxsim.noRefCounting();\n"),t.target.floatingPoint&&(i+="pxsim.enableFloatingPoint();\n");for(var a={},s={},o=0,l=t.res.configData||[];o<l.length;o++){var u=l[o];a[u.key+""]=u.value,s[u.name]=u.key}i+="pxsim.setConfigData("+JSON.stringify(a,null,1)+", "+JSON.stringify(s,null,1)+");\n",t.procs.forEach(function(e){i+="\n"+n(t,e)+"\n"}),t.usedClassInfos.forEach(function(e){i+=r(e)}),t.res.breakpoints&&(i+="\nsetupDebugger("+t.res.breakpoints.length+")\n"),e.U.iterMap(t.hexlits,function(e,t){i+="var "+t+' = pxsim.BufferMethods.createBufferFromHex("'+e+'")\n'}),t.writeFile(e.BINARY_JS,i)}}(e.pxtc||(e.pxtc={}))}(ts||(ts={}));var ts;!function(e){!function(e){e.thumbCmpMap={"numops::lt":"_cmp_lt","numops::gt":"_cmp_gt","numops::le":"_cmp_le","numops::ge":"_cmp_ge","numops::eq":"_cmp_eq","numops::eqq":"_cmp_eqq","numops::neq":"_cmp_neq","numops::neqq":"_cmp_neqq"};var t={"numops::adds":"_numops_adds","numops::subs":"_numops_subs","numops::orrs":"_numops_orrs","numops::ands":"_numops_ands","pxt::toInt":"_numops_toInt","pxt::fromInt":"_numops_fromInt","pxt::incr":"_pxt_incr","pxt::decr":"_pxt_decr"},r=function(r){function n(){r.apply(this,arguments)}return __extends(n,r),n.prototype.hasCommonalize=function(){return!!e.target.commonalize},n.prototype.stackAligned=function(){return e.target.stackAlign&&e.target.stackAlign>1},n.prototype.pushLR=function(){return this.stackAligned()?"push {lr, r3}  ; r3 for align":"push {lr}"},n.prototype.popPC=function(){return this.stackAligned()?"pop {pc, r3}  ; r3 for align":"pop {pc}"},n.prototype.nop=function(){return"nop"},n.prototype.reg_gets_imm=function(e,t){return"movs "+e+", #"+t},n.prototype.push_fixed=function(e){return"push {"+e.join(", ")+"}"},n.prototype.pop_fixed=function(e){return"pop {"+e.join(", ")+"}"},n.prototype.proc_setup=function(e,t){var r="push {lr}\n";if(e>0){r+="    movs r0, #0\n";for(var n=0;n<e;++n)r+="    push {r0} ;loc\n"}return r},n.prototype.proc_return=function(){return"pop {pc}"},n.prototype.debugger_stmt=function(e){return"\n    @stackempty locals\n    ldr r0, [r6, #0] ; debugger\n    subs r0, r0, #4  ; debugger\n"+e+":\n    ldr r0, [r0, #0] ; debugger\n"},n.prototype.debugger_bkpt=function(e){return"\n    @stackempty locals\n    ldr r0, [r6, #0] ; brk\n"+e+":\n    ldr r0, [r0, #0] ; brk\n"},n.prototype.debugger_proc=function(e){return"\n    ldr r0, [r6, #0]  ; brk-entry\n    ldr r0, [r0, #4]  ; brk-entry\n"+e+":"},n.prototype.push_local=function(e){return"push {"+e+"}"},n.prototype.push_locals=function(e){return"sub sp, #4*"+e+" ; push locals "+e+" (align)"},n.prototype.pop_locals=function(e){return"add sp, #4*"+e+" ; pop locals "+e},n.prototype.unconditional_branch=function(e){return"bb "+e},n.prototype.beq=function(e){return"beq "+e},n.prototype.bne=function(e){return"bne "+e},n.prototype.cmp=function(e,t){return"cmp "+e+", "+t},n.prototype.cmp_zero=function(e){return"cmp "+e+", #0"},n.prototype.load_reg_src_off=function(e,t,r,n,i,a){r=r.replace(/:\d+$/,""),n&&(r="#4*"+r);var s="str",o="ldr";return a&&(32==a.immLimit?s="strb":64==a.immLimit&&(s="strh"),o=a.needsSignExt?s.replace("str","ldrs"):s.replace("str","ldr")),i?s+" "+e+", ["+t+", "+r+"]":o+" "+e+", ["+t+", "+r+"]"},n.prototype.rt_call=function(e,t,r){return e+" "+t+", "+r},n.prototype.call_lbl=function(r){if(e.target.taggedInts&&!e.target.boxDebug){var n=e.U.lookup(t,r);n&&(r=n)}return"bl "+r},n.prototype.call_reg=function(e){return"blx "+e},n.prototype.vcall=function(e,t,r){return"\n    ldr r0, [sp, #"+(t?4:0)+"] ; ld-this\n    ldrh r3, [r0, #2] ; ld-vtable\n    lsls r3, r3, #"+r+"\n    ldr r3, [r3, #4] ; iface table\n    cmp r3, #43\n    beq .objlit\n.nonlit:\n    lsls r1, "+(t?"r2":"r1")+", #2\n    ldr r0, [r3, r1] ; ld-method\n    bx r0\n.objlit:\n    "+(t?"ldr r2, [sp, #0]":"")+"\n    "+this.pushLR()+"\n    bl "+e+"\n    "+this.popPC()+"\n"},n.prototype.prologue_vtable=function(e,t){return"\n    ldr r0, [sp, #4*"+e+"]  ; ld-this\n    ldrh r0, [r0, #2] ; ld-vtable\n    lsls r0, r0, #"+t+"\n    "},n.prototype.helper_prologue=function(){return"\n    @stackmark args\n    "+this.pushLR()+"\n    mov r5, r0\n"},n.prototype.helper_epilogue=function(){return"\n    bl pxtrt::getGlobalsPtr\n    mov r6, r0\n    "+this.popPC()+"\n    @stackempty args\n"},n.prototype.load_ptr_full=function(t,r){return e.assert(!!t),"\n    ldlit "+r+", "+t+"\n"},n.prototype.load_ptr=function(t,r){return e.assert(!!t),"\n    movs "+r+", "+t+"@hi  ; ldptr\n    lsls "+r+", "+r+", #8\n    adds "+r+", "+t+"@lo\n"},n.prototype.arithmetic=function(){var t="";if(!e.target.taggedInts||e.target.boxDebug)return t;for(var r=0,n=["adds","subs","ands","orrs","eors"];r<n.length;r++)t+="\n_numops_"+(l=n[r])+":\n    @scope _numops_"+l+"\n    lsls r2, r0, #31\n    beq .boxed\n    lsls r2, r1, #31\n    beq .boxed\n","adds"==l||"subs"==l?t+="\n    subs r2, r1, #1\n    "+l+" r2, r0, r2\n    bvs .boxed\n    movs r0, r2\n    blx lr\n":(t+="    "+l+" r0, r1\n","eors"==l&&(t+="    adds r0, r0, #1\n"),t+="    blx lr\n"),t+="\n.boxed:\n    push {r4, lr}\n    push {r0, r1}\n    bl numops::"+l+"\n    movs r4, r0\n    pop {r0}\n    bl _pxt_decr\n    pop {r0}\n    bl _pxt_decr\n    movs r0, r4\n    pop {r4, pc}\n";t+="\n@scope _numops_toInt\n_numops_toInt:\n    asrs r0, r0, #1\n    bcc .over\n    blx lr\n.over:\n    "+this.pushLR()+"\n    lsls r0, r0, #1\n    bl pxt::toInt\n    "+this.popPC()+"\n\n_numops_fromInt:\n    lsls r2, r0, #1\n    asrs r1, r2, #1\n    cmp r0, r1\n    bne .over2\n    adds r0, r2, #1\n    blx lr\n.over2:\n    "+this.pushLR()+"\n    bl pxt::fromInt\n    "+this.popPC()+"\n";for(var i=0,a=["incr","decr"];i<a.length;i++)t+="\n_pxt_"+(l=a[i])+":\n    @scope _pxt_"+l+"\n    lsls r3, r0, #30\n    beq .t0\n    bx lr\n.t0:\n    cmp r0, #0\n    beq .skip\n    "+this.pushLR()+"\n    bl pxt::"+l+"\n    "+this.popPC()+"\n.skip:\n    bx lr\n";for(var s=0,o=Object.keys(e.thumbCmpMap);s<o.length;s++){var l=o[s];t+="\n_cmp_"+(l=l.replace(/.*::/,""))+":\n    @scope _cmp_"+l+"\n    lsls r2, r0, #31\n    beq .boxed\n    lsls r2, r1, #31\n    beq .boxed\n    subs r0, r1\n    b"+l.replace("qq","q").replace("neq","ne")+" .true\n.false:\n    movs r0, #0\n    bx lr\n.true:\n    movs r0, #1\n    bx lr\n.boxed:\n    push {r4, lr}\n    push {r0, r1}\n    bl numops::"+l+"\n    bl numops::toBoolDecr\n    movs r4, r0\n    pop {r0}\n    bl _pxt_decr\n    pop {r0}\n    bl _pxt_decr\n    movs r0, r4\n    pop {r4, pc}\n"}return t},n.prototype.emit_int=function(t,r){function n(t){e.assert(0<=t&&t<=255);var n="";return a?t&&(n="adds "+r+", #"+t+"\n"):n="movs "+r+", #"+t+"\n",a=!0,n}function i(e){return void 0===e&&(e=8),"lsls "+r+", "+r+", #"+e+"\n"}var a=!1;e.assert(null!=t);var s=Math.floor(t),o=!1;s<0&&(o=!0,s=-s);var l=0;if(s>255){for(var u=s;0==(1&u);)u>>>=1,l++;e.numBytes(u)<e.numBytes(s)?s=u:l=0}var c="";switch(e.numBytes(s)){case 4:c+=n(s>>>24&255),c+=i();case 3:c+=n(s>>>16&255),c+=i();case 2:c+=n(s>>>8&255),c+=i();case 1:c+=n(255&s);break;default:e.oops()}return l&&(c+=i(l)),o&&(c+="negs "+r+", "+r+"\n"),c.split("\n").length>4?"ldlit "+r+", "+Math.floor(t)+"\n":c},n}(e.AssemblerSnippets);e.ThumbSnippets=r}(e.pxtc||(e.pxtc={}))}(ts||(ts={}));var ts;!function(e){!function(e){function t(t){return e.vtableToAsm(t)}function r(t,r){function a(){b(";\n; Proc: "+r.getName()+"\n;"),v(".section code"),t.procs[0]==r&&b("; main"),b(r.label()+":"),b(r.label()+"_Lit:"),I=r.locals.length+S.length,v(0==I?"locals0":"locals "+I*k+" ; incl. "+S.length+" tmps");for(var n=0,i=r.body;n<i.length;n++){var a=i[n];switch(a.stmtKind){case e.ir.SK.Expr:c(a.expr);break;case e.ir.SK.StackEmpty:f();for(var o=0,l=S;o<l.length;o++){var u=l[o];u&&e.oops("uses: "+u.currUses+"/"+u.totalUses+" "+u.toString())}break;case e.ir.SK.Jmp:s(a);break;case e.ir.SK.Label:b(a.lblName+":");break;case e.ir.SK.Breakpoint:E++;break;default:e.oops()}}var p=I*k|r.args.length<<8;v("ret 0x"+p.toString(16))}function s(t){var r=t.lbl.lblName;t.jmpMode==e.ir.JmpMode.Always?(t.expr&&c(t.expr),v("jmp "+r)):t.jmpMode==e.ir.JmpMode.IfLambda?(t.expr&&c(t.expr),v("retlmb "+I*k)):t.jmpMode==e.ir.JmpMode.IfJmpValEq?(v("push"),c(t.expr),v("eq"),v("jmpnz "+r)):(c(t.expr),t.jmpMode==e.ir.JmpMode.IfNotZero?v("jmpnz "+r):t.jmpMode==e.ir.JmpMode.IfZero?v("jmpz "+r):e.oops())}function o(e,t){return e+(t?"Ref":"")}function l(t){if(t.isGlobal())return"glb "+t.index;if(t.iscap)return"cap "+t.index*k;if(t.isarg){n=r.args.length-t.index-1;return e.assert(n>=0,"arg#"+n),"tmp "+(I+2+n)*k}var n=t.index+S.length;return e.assert(!T||n<I,"cell#"+n),e.assert(n>=0,"cell#"+n),"tmp "+n*k}function u(t){switch(t.exprKind){case y.NumberLiteral:return void v(0===t.data?"ldzero":1===t.data?"ldone":"ldconst "+(65535&t.data));case y.PointerLiteral:return void v("ldconst "+t.data);case y.SharedRef:var r=t.args[0];e.U.assert(!!r.currUses),e.U.assert(r.currUses<r.totalUses),r.currUses++;var n=S.indexOf(r);return n<0&&(console.log(S,r),e.assert(!1)),v("ldtmp "+n*k),void f();case y.CellRef:v("ld"+l(t.data));var i=t.data;return void(i.isGlobal()&&(1==i.bitSize?v("sgnext"):2==i.bitSize&&v("clrhi")));default:throw e.oops()}}function c(t){switch(t.exprKind){case y.JmpValue:v("; jmp value (already in r0)");break;case y.Nop:v("; nop");break;case y.Incr:c(t.args[0]),v("incr");break;case y.Decr:c(t.args[0]),v("decr");break;case y.FieldAccess:var r=t.data;return c(e.ir.rtcall(o("pxtrt::ldfld",r.isRef),[t.args[0],e.ir.numlit(r.idx)]));case y.Store:return h(t.args[0],t.args[1]);case y.RuntimeCall:return d(t);case y.ProcCall:return m(t);case y.SharedDef:return p(t);case y.Sequence:return t.args.forEach(c);default:return u(t)}}function p(t){var r=t.args[0];if(e.U.assert(r.totalUses>=1),e.U.assert(0===r.currUses),r.currUses=1,x.push(r),1==r.totalUses)return c(r);c(r);for(var n=-1,i=0;i<S.length;++i)if(null==S[i]){n=i;break}n<0?(T&&(console.log(r,S),e.assert(!1,"missed tmp")),n=S.length,S.push(r)):S[n]=r,v("sttmp "+n*k)}function d(t){var r=t.data,a=/^(.*)\^(\d+)$/.exec(r),s=0;a&&(r=a[1],s=parseInt(a[2])),r=e.U.lookup(i,r)||r,e.assert(s<=15);var o=e.ir.flattenArgs(t);if(e.assert(0==o.precomp.length),f(),"pxt::stringLiteral"!=r||1!=o.flattened.length||o.flattened[0].exprKind!=y.PointerLiteral){e.assert(o.flattened.length<=4);var l="0x"+(s+16*o.flattened.length).toString(16);r=r.replace(/^thumb::/,"Number_::");var u=e.U.lookup(n,r);s&&(u=null);for(var p=0;p<o.flattened.length;++p)c(o.flattened[p]),p<o.flattened.length-1&&v("push");v(u?u:"call "+l+", "+r)}else v("stringlit "+o.flattened[0].data)}function f(){for(var e=0;e<S.length;++e){var t=S[e];t&&t.currUses==t.totalUses&&(T||x.push(t),S[e]=null)}}function m(e){for(var t=e.data,r=t.proc,n=0,i=e.args;n<i.length;n++)c(i[n]),v("push");var a=-1,s="";null!=t.ifaceIndex?(a=t.ifaceIndex,s="pxtrt::fetchMethodIface"):null!=t.virtualIndex&&(a=t.virtualIndex+2,s="pxtrt::fetchMethod"),s?(v("ldstack "+(e.args.length*k-1)),v("push"),v("ldconst "+a),v("call 0x20, "+s),v("callind")):v("callproc "+r.label())}function h(t,r){switch(t.exprKind){case y.CellRef:c(r);var n=t.data,i="st"+l(n);!n.isGlobal()||1!=n.bitSize&&2!=n.bitSize||(i=i.replace("stglb","stglb1")),v(i);break;case y.FieldAccess:var a=t.data;c(e.ir.rtcall(o("pxtrt::stfld",a.isRef),[t.args[0],e.ir.numlit(a.idx),r]));break;default:e.oops()}}var g="",b=function(e){g+=e+"\n"},v=function(e){g+="    "+e+"\n"},y=e.ir.EK,k=2,x=[],S=[],T=!1,E=0,I=0;r.resolve(),a(),t.numStmts=E,g="";for(var w=0,_=x;w<_.length;w++)_[w].currUses=0;return T=!0,a(),g}var n={"Number_::eq":"eq","Number_::adds":"add","Number_::subs":"sub"},i={};e.vmEmit=function(n,i){var a="; VM start\n"+e.hex.hexPrelude()+"        \n    .hex 708E3B92C615A841C49866C975EE5197 ; magic number\n    .hex "+e.hex.hexTemplateHash()+" ; hex template hash\n    .hex 0000000000000000 ; @SRCHASH@\n    .short "+n.globalsWords+"   ; num. globals\n    .short 0 ; patched with number of words resulting from assembly\n    .word 0 ; reserved\n    .word 0 ; reserved\n    .word 0 ; reserved\n",s=new e.AVRSnippets;n.procs.forEach(function(e){a+="\n"+r(n,e)+"\n"}),n.usedClassInfos.forEach(function(e){a+=t(e)}),e.U.iterMap(n.hexlits,function(e,t){a+=s.hex_literal(t,e)}),e.U.iterMap(n.strings,function(e,t){a+=s.string_literal(t,e)}),a+="\n; The end.\n",n.writeFile(e.BINARY_ASM,a);var o=e.assemble(i.target,n,a);if(o.src&&n.writeFile(e.BINARY_ASM,o.src),o.buf){for(var l=[],u=0;u<o.buf.length;u+=2)l.push(o.buf[u]|o.buf[u+1]<<8);var c=btoa(e.hex.patchHex(n,l,!1,!0)[0]);n.writeFile(pxt.outputName(e.target),c)}}}(e.pxtc||(e.pxtc={}))}(ts||(ts={}));var ts;!function(e){!function(t){!function(r){function n(r,a,c,p){function b(e,r){var n;return e.name.kind!==g.Identifier?n=t.Util.lf("Variable declarations may not use binding patterns"):e.initializer?i(e)||(n=o(e.initializer,r)):n=t.Util.lf("Variable declarations must have an initializer"),n}switch(void 0===c&&(c=!1),void 0===p&&(p=!1),r.kind){case g.WhileStatement:case g.IfStatement:case g.Block:return;case g.ExpressionStatement:return n(r.expression,a,c,p);case g.VariableStatement:return function(e,t){for(var r=0,n=e.declarationList.declarations;r<n.length;r++){var i=b(n[r],t);if(i)return i}}(r,a);case g.CallExpression:return function(e,r,n,i){void 0===n&&(n=!1),void 0===i&&(i=!1);var a=e.callInfo;if(!a)return t.Util.lf("Function call not supported in the blocks");if(!n&&a.isExpression)return t.Util.lf("No output expressions as statements");var o=d(a);if(o&&!a.attrs.handlerStatement&&!i)return t.Util.lf("Events must be top level");if(!a.attrs.blockId||!a.attrs.block){var l=_[a.qName];if(!l)return 0===e.arguments.length&&e.expression.kind===g.Identifier?r.declaredFunctions[e.expression.text]?void 0:t.Util.lf("Call statements must have a valid declared function"):t.Util.lf("Function call not supported in the blocks");a.attrs.block=l.block,a.attrs.blockId=l.blockId}var c=m(a,r.blocks),p=a.args.length-c.length;if(a.attrs.imageLiteral){if(p>1)return t.Util.lf("Function call has more arguments than are supported by its block");var b=e.arguments[0];if(b.kind!=g.StringLiteral&&b.kind!=g.NoSubstitutionTemplateLiteral)return t.Util.lf("Only string literals supported for image literals");var v=(b.text||"").replace(/\s+/g,"");if(5*a.attrs.imageLiteral*5!=v.length)return t.Util.lf("Invalid image pattern")}else{if(p>0&&!function(){if(a.attrs.mutatePropertyEnum&&2===p&&a.args.length>=2){var e=a.args[a.args.length-2],t=a.args[a.args.length-1];if(e.kind===g.ArrayLiteralExpression&&h(t)){var r=[];if(!e.elements.some(function(e){return e.kind!==g.PropertyAccessExpression||e.expression.kind!==g.Identifier||(r.push(e.name.text),e.expression.text!==a.attrs.mutatePropertyEnum)})){var n=s(t);if(n){var i=n[0];return i.length===r.length&&!r.some(function(e){return-1===i.indexOf(e)})}}}}return!1}()&&(p>1||!o))return t.Util.lf("Function call has more arguments than are supported by its block");var y=r.blocks.apis.byQName[a.qName];if(y&&y.parameters&&y.parameters.length){var k,x=y.kind==t.SymbolKind.Method||y.kind==t.SymbolKind.Property;if(a.args.forEach(function(e,n){if(e=u(e),!x||0!==n){var i=y.parameters[x?n-1:n];if(i.isEnum){if(e.kind===g.PropertyAccessExpression){var s=e.expression;if(s.kind===g.Identifier&&s.text===i.type)return}k=t.Util.lf("Enum arguments may only be literal property access expressions")}else if(f(e)){var o=c[n];!o.paramFieldEditor||o.paramFieldEditorOptions&&o.paramFieldEditorOptions.decompileLiterals||(k=t.Util.lf("Field editor does not support literal arguments"))}else if(e.kind===g.ArrowFunction){var l=e;if(l.parameters.length)if("objectdestructuring"===a.attrs.mutate){var p=u(l.parameters[0]);p.kind===g.Parameter&&p.name.kind!==g.ObjectBindingPattern&&(k=t.Util.lf("Object destructuring mutation callbacks can only have destructuring patters as arguments"))}else l.parameters.forEach(function(e){e.name.kind!==g.Identifier&&(k=t.Util.lf("Only identifiers allowed as function arguments"))})}else if(r.blocks.apis.byQName[i.type]&&r.blocks.apis.byQName[i.type].attributes.fixedInstances){var d=e.callInfo;if(d&&d.attrs.fixedInstance)return;k=t.Util.lf("Arguments of a fixed instance type must be a reference to a fixed instance declaration")}}}),k)return k}if(y){var S=r.blocks.apis.byQName[y.namespace];if(S&&S.attributes.fixedInstances&&a.args.length){var T=a.args[0].callInfo;if(!T||!T.attrs.fixedInstance)return t.Util.lf("Fixed instance APIs can only be called directly from the fixed instance")}}}}(r,a,c,p);case g.VariableDeclaration:return b(r,a);case g.PostfixUnaryExpression:case g.PrefixUnaryExpression:return function(e){return e.operand.kind!=g.Identifier?t.Util.lf("-- and ++ may only be used on an identifier"):e.operator!==g.PlusPlusToken&&e.operator!==g.MinusMinusToken?t.Util.lf("Only ++ and -- supported as prefix or postfix unary operators in a statement"):void 0}(r);case g.FunctionExpression:case g.ArrowFunction:return function(e){var r=!1;if(e.parameters.length){var n=l(e)[0];n&&n.callInfo&&(r="objectdestructuring"===n.callInfo.attrs.mutate?e.parameters[0].name.kind!==g.ObjectBindingPattern:e.parameters.some(function(e){return e.name.kind!==g.Identifier}))}if(r)return t.Util.lf("Unsupported parameters in error function")}(r);case g.BinaryExpression:return function(e,r){if(e.left.kind!==g.Identifier&&e.left.kind!==g.ElementAccessExpression)return t.Util.lf("Only variable names may be assigned to");if(e.left.kind===g.ElementAccessExpression){if(e.operatorToken.kind!==g.EqualsToken)return t.Util.lf("Element access expressions may only be assigned to using the equals operator")}else switch(e.operatorToken.kind){case g.EqualsToken:return o(e.right,r);case g.PlusEqualsToken:case g.MinusEqualsToken:return;default:return t.Util.lf("Unsupported operator token in statement {0}",g[e.operatorToken.kind])}}(r,a);case g.ForStatement:return function(e){if(!e.initializer||!e.incrementor||!e.condition)return t.Util.lf("for loops must have an initializer, incrementor, and condition");if(e.initializer.kind!==g.VariableDeclarationList)return t.Util.lf("only variable declarations are permitted in for loop initializers");var r=e.initializer;if(!r.declarations)return t.Util.lf("for loop with out-of-scope variables not supported");if(1!=r.declarations.length)return t.Util.lf("for loop with multiple variables not supported");var n=r.declarations[0];if(n.initializer.kind!==g.NumericLiteral||"0"!==n.initializer.text)return t.Util.lf("for loop initializers must be initialized to 0");var i=n.name.text;if(!function(t){if(e.incrementor.kind===g.PostfixUnaryExpression||e.incrementor.kind===g.PrefixUnaryExpression){var r=e.incrementor;if(r.operator===g.PlusPlusToken&&r.operand.kind===g.Identifier)return r.operand.text===t}return!1}(i))return t.Util.lf("for loop incrementors may only increment the variable declared in the initializer");if(e.condition.kind!==g.BinaryExpression)return t.Util.lf("for loop conditionals must be binary comparison operations");var a=e.condition;return a.left.kind!==g.Identifier||a.left.text!==i?t.Util.lf("left side of for loop conditional must be the variable declared in the initializer"):a.operatorToken.kind!==g.LessThanToken&&a.operatorToken.kind!==g.LessThanEqualsToken?t.Util.lf("for loop conditional operator must be either < or <="):void 0}(r);case g.ForOfStatement:return function(e){if(e.initializer.kind!==g.VariableDeclarationList)return t.Util.lf("only variable declarations are permitted in for of loop initializers")}(r);case g.FunctionDeclaration:return function(r,n){if(!n)return t.Util.lf("Function declarations must be top level");if(r.parameters.length>0)return t.Util.lf("Functions with parameters not supported in blocks");var i=!1;return e.forEachReturnStatement(r.body,function(e){e.expression&&(i=!0)}),i?t.Util.lf("Function with return value not supported in blocks"):void 0}(r,p)}return t.Util.lf("Unsupported statement in block: {0}",g[r.kind])}function i(t){if(t.initializer){if(t.initializer.kind===e.SyntaxKind.NullKeyword||t.initializer.kind===e.SyntaxKind.FalseKeyword||a(t.initializer))return!0;if(e.isStringOrNumericLiteral(t.initializer.kind)){var r=t.initializer.getText();return"0"===r||c(r)}var n=t.initializer.callInfo;if(n&&n.isAutoCreate)return!0}return!1}function a(e){return e.kind===g.ArrayLiteralExpression&&0===e.elements.length}function s(e){function t(e){return!e||e.kind===g.Identifier}if(1===e.parameters.length&&e.parameters[0].name.kind===g.ObjectBindingPattern){var r={};return[e.parameters[0].name.elements.map(function(e){if(t(e.propertyName)&&t(e.name)){var n=e.name.text;if(e.propertyName){var i=e.propertyName.text;return r[i]=n,i}return n}return""}),r]}}function o(e,r){switch(e.kind){case g.NumericLiteral:case g.TrueKeyword:case g.FalseKeyword:case g.ExpressionStatement:case g.ArrayLiteralExpression:case g.ElementAccessExpression:return;case g.ParenthesizedExpression:return o(e.expression,r);case g.StringLiteral:case g.FirstTemplateToken:case g.NoSubstitutionTemplateLiteral:return function(e){var r=e.text;return k.test(r)?void 0:t.Util.lf("Only whitespace character allowed in string literals is space")}(e);case g.Identifier:return p(e)?t.Util.lf("Undefined is not supported in blocks"):void 0;case g.BinaryExpression:var i=e.operatorToken.getText();return E[i]?void 0:t.Util.lf("Could not find operator {0}",i);case g.PrefixUnaryExpression:var a=e.operator;return a===g.MinusToken||a===g.PlusToken||a===g.ExclamationToken?void 0:t.Util.lf("Unsupported prefix unary operator{0}",a);case g.PropertyAccessExpression:return function(e){var n=e.callInfo;if(n){if(n.attrs.blockIdentity||"lists_length"===n.attrs.blockId||"text_length"===n.attrs.blockId)return;if(n.decl.kind===g.EnumMember){var i=l(e),a=i[0],s=i[1],o=!0;if(a){var u=a.callInfo;if(u&&u.args){var c=r.blocks.apis.byQName[u.qName],p=c.kind==t.SymbolKind.Method||c.kind==t.SymbolKind.Property;c&&u.args.forEach(function(e,t){e===s&&c.parameters[p?t-1:t].isEnum&&(o=!1)})}}return o?t.Util.lf("Enum value without a corresponding block"):void 0}if(n.attrs.fixedInstance&&e.parent)if(e.parent.parent&&e.parent.kind===g.PropertyAccessExpression&&e.parent.parent.kind===g.CallExpression){if(e.parent.parent.expression===e.parent)return}else if(e.parent.kind===g.CallExpression&&e.parent.expression!==e)return}return t.Util.lf("No call info found")}(e);case g.CallExpression:return n(e,r,!0)}return t.Util.lf("Unsupported syntax kind for output expression block: {0}",g[e.kind])}function l(e){return e.parent?e.parent.kind===g.ParenthesizedExpression?l(e.parent):[e.parent,e]:[void 0,e]}function u(e){for(;e.kind===g.ParenthesizedExpression;)e=e.expression;return e}function c(e){return'""'===e||"''"===e||"``"===e}function p(e){return e&&e.kind===g.Identifier&&"undefined"===e.text}function d(e){e.decl.parameters;return e.args.some(function(e,t){return e&&h(e)})}function f(e){if(!e)return!1;switch(e.kind){case g.ParenthesizedExpression:return f(e.expression);case g.NumericLiteral:case g.StringLiteral:case g.NoSubstitutionTemplateLiteral:case g.TrueKeyword:case g.FalseKeyword:return!0;case g.PrefixUnaryExpression:var t=e;return(t.operator===g.PlusToken||t.operator===g.MinusToken)&&f(t.operand);default:return!1}}function m(e,t){var r=[];return e.attrs.block.replace(/%(\w+)(?:=(\w+))?/g,function(e,t,n){return r.push([t,n]),""}),e.attrs.defaultInstance&&r.unshift(["__instance__",void 0]),r.map(function(r){var n=r[0],i=r[1],a={name:n,type:i};if(n&&i){var s=t.blocksById[i];if(s){var o="";s.attributes.block.replace(/%(\w+)/g,function(e,t){return o=t,""}),a.fieldName=o;var l=s.attributes;l&&l.paramFieldEditor&&l.paramFieldEditor[o]&&(e.attrs.paramShadowOptions&&e.attrs.paramShadowOptions[n]&&(a.paramShadowOptions=e.attrs.paramShadowOptions[n]),a.decompileLiterals=!!(l.paramFieldEditorOptions&&l.paramFieldEditorOptions[o]&&l.paramFieldEditorOptions[o].decompileLiterals))}}return e.attrs.paramFieldEditorOptions&&(a.paramFieldEditorOptions=e.attrs.paramFieldEditorOptions[n]),e.attrs.paramFieldEditor&&(a.paramFieldEditor=e.attrs.paramFieldEditor[n]),a})}function h(e){return e.kind===g.ArrowFunction||e.kind===g.FunctionExpression}r.FILE_TOO_LARGE_CODE=9266;var g=e.SyntaxKind,b=1e3,v=97,y=122,k=/^[^\f\n\r\t\v\u00a0\u1680\u180e\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]*$/,x="math_number",S="text",T="logic_boolean",E={"+":{type:"math_arithmetic",op:"ADD"},"-":{type:"math_arithmetic",op:"MINUS"},"/":{type:"math_arithmetic",op:"DIVIDE"},"*":{type:"math_arithmetic",op:"MULTIPLY"},"%":{type:"math_modulo",leftName:"DIVIDEND",rightName:"DIVISOR"},"<":{type:"logic_compare",op:"LT"},"<=":{type:"logic_compare",op:"LTE"},">":{type:"logic_compare",op:"GT"},">=":{type:"logic_compare",op:"GTE"},"==":{type:"logic_compare",op:"EQ"},"===":{type:"logic_compare",op:"EQ"},"!=":{type:"logic_compare",op:"NEQ"},"!==":{type:"logic_compare",op:"NEQ"},"&&":{type:"logic_operation",op:"AND"},"||":{type:"logic_operation",op:"OR"}},I=/^\s*\/\/\s*(.*)$/,w=/^\s*(?:(?:(?:\/\*\*?)|(?:\*))(?!\/))?\s*(.*?)(?:\*?\*\/)?$/,_={"Math.abs":{blockId:"math_op3",block:"absolute of %x"},"Math.min":{blockId:"math_op2",block:"of %x|and %y"},"Math.max":{blockId:"math_op2",block:"of %x|and %y"}},K=function(){function e(e){this.renames=e,this.renames.sort(function(e,t){return e.span.start-t.span.start})}return e.prototype.getRenamesInSpan=function(e,t){for(var r=[],n=0,i=this.renames;n<i.length;n++){var a=i[n];if(a.span.start>t)break;a.span.start>=e&&r.push(a)}return r},e.prototype.getRenameForPosition=function(e){for(var t=0,r=this.renames;t<r.length;t++){var n=r[t];if(n.span.start>e)return;if(n.span.start===e)return n}},e}();r.RenameMap=K;var N=function(){function e(e){this.p=e}return e.prototype.getCompilationSettings=function(){var e=this.p.getCompilerOptions();return e.noLib=!0,e},e.prototype.getNewLine=function(){return"\n"},e.prototype.getScriptFileNames=function(){return this.p.getSourceFiles().map(function(e){return e.fileName})},e.prototype.getScriptVersion=function(e){return"0"},e.prototype.getScriptSnapshot=function(e){var t=this.p.getSourceFile(e);return{getLength:function(){return t.getFullText().length},getText:function(){return t.getFullText()},getChangeRange:function(){}}},e.prototype.getCurrentDirectory=function(){return"."},e.prototype.getDefaultLibFileName=function(e){return null},e.prototype.useCaseSensitiveFileNames=function(){return!0},e}();r.buildRenameMap=function(t,r){var n=e.createLanguageService(new N(t)),i=[];if(function(){function t(o){e.forEachChild(o,function(e){if(e.kind===g.VariableDeclaration&&e.name.kind===g.Identifier){var o=e.name.getText();if(s[o]){var l=a(o),u=n.findRenameLocations(r.fileName,e.name.pos+1,!1,!1);u&&u.forEach(function(e){i.push({name:l,diff:l.length-o.length,span:e.textSpan})})}else s[o]=!0}t(e)})}function a(e){if(1===e.length){var t=e.charCodeAt(0);if(t>=v&&t<=y)for(var r=t-v,n=1;n<26;n++){var i=String.fromCharCode(v+(r+n)%26);if(!s[i])return s[i]=!0,i}}for(n=2;;n++){var a=e+n;if(!s[a])return s[a]=!0,a}}var s={};t(r)}(),i.length)return new K(i)};var L;!function(e){e[e.None=0]="None",e[e.InBlocksOnly=1]="InBlocksOnly",e[e.InTextBlocks=2]="InTextBlocks"}(L||(L={})),r.decompileToBlocks=function(a,c,p,h){function v(e,t){void 0===t&&(t="\n"),$e+=e+t}function y(r,n){var i=n||'Language feature "'+r.getFullText().trim()+'"" not supported in blocks',a=t.patchUpDiagnostics([{file:c,start:r.getFullStart(),length:r.getFullWidth(),messageText:i,category:e.DiagnosticCategory.Error,code:1001}]);pxt.debug("decompilation error: "+i),t.U.pushRange(Ce.diagnostics,a),Ce.success=!1}function k(){if(++Ne>b){var e=new Error(t.Util.lf("Could not decompile because the script is too large"));throw e.programTooLarge=!0,e}}function K(e){return k(),{kind:"statement",type:e}}function N(e){return k(),{kind:"expr",type:e}}function C(e,t,r){return r&&"expr"===t.kind&&t.type!==r&&k(),{kind:"value",name:e,value:t,shadowType:r}}function U(e){if(e.expression.kind==g.CallExpression){var t=e.expression.callInfo;return t?t.attrs.blockId&&!t.attrs.handlerStatement&&!t.isExpression&&d(t):(y(e),!1)}return!1}function A(e){e&&(M(e.type),$(e),e.handlers&&e.handlers.forEach(D),e.next&&(v("<next>"),A(e.next),v("</next>")),void 0!==e.comment&&v('<comment pinned="false">'+t.U.htmlEscape(e.comment)+"</comment>"),O())}function $(e){if(e.mutation){v("<mutation ","");for(var t in e.mutation)v(t+'="'+e.mutation[t]+'" ',"");v("/>")}e.fields&&e.fields.forEach(P),e.inputs&&e.inputs.forEach(F)}function F(e){v('<value name="'+e.name+'">');var t=!1;if("expr"===e.value.kind){var r=e.value;if(!(t=r.type===e.shadowType))switch(r.type){case"math_number":case"logic_boolean":case"text":t=!e.shadowType}}if(t)R(e.value,!0);else{if(void 0!==e.shadowType)switch(e.shadowType){case x:v('<shadow type="math_number"><field name="NUM">0</field></shadow>');break;case T:v('<shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow>');break;case S:v('<shadow type="text"><field name="TEXT"></field></shadow>');break;default:v('<shadow type="'+e.shadowType+'"/>')}R(e.value)}v("</value>")}function P(e){v('<field name="'+t.U.htmlEscape(e.name)+'">'+t.U.htmlEscape(e.value.toString())+"</field>")}function D(e){v('<statement name="'+t.U.htmlEscape(e.name)+'">'),A(e.statement),v("</statement>")}function R(e,r){if(void 0===r&&(r=!1),"text"===e.kind)v((n=e).value);else{var n=e,i=r||n.isShadow?"shadow":"block";v("<"+i+' type="'+t.U.htmlEscape(n.type)+'">'),$(n),v("</"+i+">")}}function M(e){v('<block type="'+t.U.htmlEscape(e)+'">')}function O(){v("</block>")}function B(e){if(o(e,Ue))return j(e);switch(e.kind){case g.ExpressionStatement:case g.ParenthesizedExpression:return B(e.expression);case g.Identifier:return J(e);case g.StringLiteral:case g.FirstTemplateToken:case g.NoSubstitutionTemplateLiteral:return H(e.text);case g.NumericLiteral:return G(e.text);case g.TrueKeyword:return Z(!0);case g.FalseKeyword:return Z(!1);case g.BinaryExpression:return z(e);case g.PrefixUnaryExpression:return Q(e);case g.PropertyAccessExpression:return ee(e);case g.ArrayLiteralExpression:return te(e);case g.ElementAccessExpression:return re(e);case g.CallExpression:return ne(e,void 0,void 0,!0);default:y(e,t.Util.lf("Unsupported syntax kind for output expression block: {0}",g[e.kind]))}}function q(e,t,r){if(h){var n=h.getRenamesInSpan(t,r);if(n.length){var i=0;n.forEach(function(r){var n=r.span.start+i-t,a=n+r.span.length;i+=r.diff,e=e.slice(0,n)+r.name+e.slice(a)})}}return e}function j(e){var r=q(e.getFullText(),e.getFullStart(),e.getEnd()).trim();return Ee(e),W(t.TS_OUTPUT_TYPE,"EXPRESSION",r)}function z(e){function t(e){return e.kind===g.BinaryExpression&&"+"===e.operatorToken.getText()&&!!e.exprInfo}function r(e,n){t(e)?(r(e.left,n),r(e.right,n)):n.push(e)}var n=e.operatorToken.getText(),i=E[n];if(t(e)){var a=[];r(e,a);var s=N("text_join");s.mutation={items:a.length.toString()},s.inputs=[];for(var o=0;o<a.length;o++)s.inputs.push(V("ADD"+o,a[o],S));return s}var l=N(i.type);l.fields=[],l.inputs=[],i.op&&l.fields.push(Y("OP",i.op));var u="&&"===n||"||"===n?T:x;return l.inputs.push(V(i.leftName||"A",e.left,u)),l.inputs.push(V(i.rightName||"B",e.right,u)),l}function V(e,t,r){var n;return n="number"==typeof t?G(t.toString()):"boolean"==typeof t?Z(t):"string"==typeof t?H(t):B(t),C(e,n,r)}function J(e){var t=Ke(e);return Te(t,L.InBlocksOnly),W("variables_get","VAR",t)}function G(e){return W("math_number","NUM",e)}function H(e){return W("text","TEXT",e)}function Z(e){return W("logic_boolean","BOOL",e?"TRUE":"FALSE")}function W(e,t,r,n){var i=N(e);return i.fields=[Y(t,r)],i.isShadow=n,i}function Y(e,t){return{kind:"field",name:e,value:t}}function X(e){var t=N("math_arithmetic");return t.inputs=[V("A",0,x),V("B",e,x)],t.fields=[Y("OP","MINUS")],t}function Q(e){switch(e.operator){case g.ExclamationToken:var t=N("logic_negate");return t.inputs=[V("BOOL",e.operand,T)],t;case g.PlusToken:return B(e.operand);case g.MinusToken:return e.operand.kind==g.NumericLiteral?G("-"+e.operand.text):X(e.operand);default:y(e)}}function ee(e){var r=e.callInfo;if(r){if("lists_length"===r.attrs.blockId||"text_length"===r.attrs.blockId)return(c=N(t.U.htmlEscape(r.attrs.blockId))).inputs=[V("VALUE",e.expression)],c;var n=t.U.htmlEscape(r.attrs.blockId||r.qName),i=l(e)[0],s=i&&i.callInfo;if(!r.attrs.blockIdentity||s&&s.qName===r.attrs.blockIdentity)return{kind:"text",value:n};r.attrs.enumval&&s&&s.attrs.useEnumVal&&(n=r.attrs.enumval);var o=a.apis.byQName[r.attrs.blockIdentity],u=/%([a-zA-Z0-9_]+)/.exec(o.attributes.block),c=N(t.U.htmlEscape(o.attributes.blockId));return c.fields=[{kind:"field",name:t.U.htmlEscape(u[1]),value:n}],c}y(e)}function te(e){var t=N("lists_create_with");return t.inputs=e.elements.map(function(e,t){return V("ADD"+t,e)}),t.mutation={items:e.elements.length.toString()},t}function re(e){var t=N("lists_index_get");return t.inputs=[V("LIST",e.expression),V("INDEX",e.argumentExpression,x)],t}function ne(r,a,s,o,l){function u(){if(a&&a.length)return ne(a.shift(),a,void 0,!1,l)}void 0===o&&(o=!1),void 0===l&&(l=!1);var p,d=r;if(n(d,Ue,o,l))p=ie(d);else switch(d.kind){case g.Block:return xe(d.statements,a);case g.ExpressionStatement:return ne(d.expression,a,s||d,o,l);case g.VariableStatement:return xe(d.declarationList.declarations,a,!1,s||d);case g.FunctionExpression:case g.ArrowFunction:return ye(d,a);case g.BinaryExpression:p=se(d);break;case g.PostfixUnaryExpression:case g.PrefixUnaryExpression:p=me(d);break;case g.VariableDeclaration:var f=d;if(i(f))return we(f),u();p=fe(d);break;case g.WhileStatement:p=oe(d);break;case g.IfStatement:p=le(d);break;case g.ForStatement:p=ue(d);break;case g.ForOfStatement:p=ce(d);break;case g.FunctionDeclaration:p=he(d);break;case g.CallExpression:p=ge(d,o);break;default:return void(a?y(d,t.Util.lf("Unsupported statement in block: {0}",g[d.kind])):y(d,t.Util.lf("Statement kind unsupported in blocks: {0}",g[d.kind])))}p&&(p.next=u(),p.next&&(p.next.prev=p));var m=e.getLeadingCommentRangesOfNode(s||d,c);if(m){var h=Ie(m);h&&p&&(p.comment=h)}return p}function ie(e,r){var n=K(t.TS_STATEMENT_TYPE);n.mutation={},Ee(e);var i=e.getText();i=q(i,e.getStart(),e.getEnd()),r&&(i=r+i);var a=[];if(e.kind===g.VariableStatement)for(var s=0,o=e.declarationList.declarations;s<o.length;s++){var l=o[s];a.push(Ke(l.name))}else e.kind===g.VariableDeclaration&&a.push(Ke(e.name));a.length&&(n.mutation.declaredvars=a.join(","));var u=i.split("\n");return n.mutation.numlines=u.length.toString(),u.forEach(function(e,r){n.mutation["line"+r]=t.U.htmlEscape(e)}),n}function ae(e,r){var n=e.arguments[0];if(n.kind==g.StringLiteral||n.kind==g.NoSubstitutionTemplateLiteral){var i=K(r.attrs.blockId);i.fields=[];var a=(n.text||"").replace(/\s+/g,""),s=5*r.attrs.imageLiteral;if(5*s==a.length){for(var o=0;o<5;++o)for(var l=0;l<s;++l)i.fields.push(Y("LED"+l+o,/[#*1]/.test(a[o*s+l])?"TRUE":"FALSE"));return i}y(e,t.Util.lf("Invalid image pattern"))}else y(e)}function se(e){switch(e.left.text,e.operatorToken.kind){case g.EqualsToken:return e.left.kind===g.Identifier?pe(e.left,e.right):de(e.left,e.right);case g.PlusEqualsToken:return pe(e.left,e.right,!0);case g.MinusEqualsToken:var r=K("variables_change");return k(),r.inputs=[C("VALUE",X(e.right),x)],r.fields=[Y("VAR",Ke(e.left))],r;default:return void y(e,t.Util.lf("Unsupported operator token in statement {0}",g[e.operatorToken.kind]))}}function oe(e){var t=K("device_while");return t.inputs=[V("COND",e.expression,T)],t.handlers=[{name:"DO",statement:ne(e.statement)}],t}function le(e){var t=ke(e),r=K("controls_if");return r.mutation={elseif:(t.ifStatements.length-1).toString(),else:t.elseStatement?"1":"0"},r.inputs=[],r.handlers=[],t.ifStatements.forEach(function(e,t){r.inputs.push(V("IF"+t,e.expression,T)),r.handlers.push({name:"DO"+t,statement:ne(e.thenStatement)})}),t.elseStatement&&r.handlers.push({name:"ELSE",statement:ne(t.elseStatement)}),r}function ue(t){function r(t){return t.kind===g.Identifier&&Ke(t)===s||e.forEachChild(t,r)}var n,i=t.initializer,a=(i.declarations[0].name.text,t.condition),s=Ke(i.declarations[0].name);if(a.operatorToken.kind!==g.LessThanToken||r(t.statement))if(n=K("controls_simple_for"),n.fields=[Y("VAR",s)],n.inputs=[],n.handlers=[],a.operatorToken.kind===g.LessThanToken){var o=N("math_arithmetic");o.fields=[Y("OP","MINUS")],o.inputs=[V("A",a.right,x),V("B",1,x)],k(),n.inputs.push(C("TO",o,x))}else a.operatorToken.kind===g.LessThanEqualsToken&&n.inputs.push(V("TO",a.right,x));else(n=K("controls_repeat_ext")).fields=[],n.inputs=[V("TIMES",a.right,x)],n.handlers=[];return n.handlers.push({name:"DO",statement:ne(t.statement)}),n}function ce(e){var t=e.initializer,r=(t.declarations[0].name.text,Ke(t.declarations[0].name)),n=K("controls_for_of");return n.inputs=[V("LIST",e.expression)],n.fields=[Y("VAR",r)],n.handlers=[{name:"DO",statement:ne(e.statement)}],n}function pe(e,t,r,n){void 0===r&&(r=!1),void 0===n&&(n=!1);var i=Ke(e);Te(i,L.InBlocksOnly);var a=K(r?"variables_change":"variables_set");return a.inputs=[V("VALUE",t,x)],a.fields=[Y("VAR",i)],a}function de(e,t){var r=K("lists_index_set");return r.inputs=[V("LIST",e.expression),V("INDEX",e.argumentExpression,x),V("VALUE",t)],r}function fe(e){if(_e(e))return pe(e.name,e.initializer)}function me(e){var t=e.operator===g.PlusPlusToken;if(t||e.operator===g.MinusMinusToken)return pe(e.operand,t?1:-1,!0);y(e)}function he(e){var t=Ke(e.name),r=ne(e.body),n=K("procedures_defnoreturn");return n.fields=[Y("NAME",t)],n.handlers=[{name:"STACK",statement:r}],n}function ge(r,n){var i=r.callInfo;if(!i.attrs.blockId||!i.attrs.block){var s=_[i.qName];if(!s){var o=Ke(r.expression);if(Ue.declaredFunctions[o]){var l=K("procedures_callnoreturn");return l.mutation={name:o},l}return ie(r)}i.attrs.block=s.block,i.attrs.blockId=s.blockId}if(i.attrs.imageLiteral)return ae(r,i);e.isFunctionLike(i.decl);var c=m(i,a),p={kind:n?"expr":"statement",type:i.attrs.blockId};return"Math.max"==i.qName&&(p.fields||(p.fields=[])).push({kind:"field",name:"op",value:"max"}),i.args.forEach(function(e,r){if(e=u(e),0===r&&i.attrs.defaultInstance){if(e.getText()===i.attrs.defaultInstance)return;p.mutation={showing:"true"}}if(!i.attrs.mutatePropertyEnum||r!==i.args.length-2)switch(e.kind){case g.FunctionExpression:case g.ArrowFunction:var n=be(e);if(n)p.mutation=n;else{var s=e;if(s.parameters.length)if(i.attrs.optionalVariableArgs)p.mutation={numargs:s.parameters.length.toString()},s.parameters.forEach(function(e,t){p.mutation["arg"+t]=e.name.text});else{var o=a.blocksById[i.attrs.blockId].parameters[r];s.parameters.forEach(function(e,t){var r=o.handlerParameters[t];(p.fields||(p.fields=[])).push(Y("HANDLER_"+r.name,e.name.text))})}}(p.handlers||(p.handlers=[])).push({name:"HANDLER",statement:ne(e)});break;case g.PropertyAccessExpression:var l=e.callInfo,d=l&&!!l.attrs.blockIdentity,m=t.U.htmlEscape(c[r].name);if(d&&l.attrs.blockIdentity!==i.qName)(p.inputs||(p.inputs=[])).push(V(m,e,c[r].type));else{var h=B(e);"text"===h.kind?(p.fields||(p.fields=[])).push(Y(m,h.value)):(c[r].type&&h.type!==c[r].type&&k(),(p.inputs||(p.inputs=[])).push(C(m,h,c[r].type)))}break;default:var b=void 0,v=t.U.htmlEscape(c[r].name),y=!0;if("Math.random"==i.qName)b=C(v,ve(e),x),y=!1;else if(f(e)){var S=c[r],T="text"==S.paramFieldEditor?e.text:e.getText();if(S.decompileLiterals){var E=W(S.type,S.fieldName,T,!0);S.paramShadowOptions&&(E.mutation={customfield:t.Util.htmlEscape(JSON.stringify(S.paramShadowOptions))}),b=C(v,E,S.type),y=!1}else if(S.paramFieldEditorOptions&&S.paramFieldEditorOptions.onParentBlock)return void(p.fields||(p.fields=[])).push(Y(v,T))}y&&(b=V(v,e,c[r].type)),(p.inputs||(p.inputs=[])).push(b)}}),p}function be(e){var r=s(e);if(r)return{callbackproperties:r[0].join(","),renamemap:t.Util.htmlEscape(JSON.stringify(r[1]))}}function ve(e){switch(e.kind){case g.NumericLiteral:var t=e;return G((parseInt(t.text)-1).toString());case g.BinaryExpression:var r=e;if(r.operatorToken.kind==g.PlusToken&&"1"==r.right.text)return k(),B(r.left);default:return B(e)}}function ye(e,t){return ne(e.body,t)}function ke(e){var t={ifStatements:[{expression:e.expression,thenStatement:e.thenStatement}],elseStatement:e.elseStatement};if(e.elseStatement&&e.elseStatement.kind==g.IfStatement){var r=ke(e.elseStatement);t.ifStatements=t.ifStatements.concat(r.ifStatements),t.elseStatement=r.elseStatement}return t}function xe(t,r,i,a){void 0===i&&(i=!1);var s=[],o=r||[];t.reverse().forEach(function(e){(e.kind===g.FunctionDeclaration||e.kind==g.ExpressionStatement&&U(e))&&!n(e,Ue,!1,i)?s.unshift(e):o.unshift(e)}),s.map(function(e){return ne(e,void 0,void 0,!1,i)}).forEach(A);var l=i&&!p.snippetMode;if(o.length){var u=ne(o.shift(),o,a,!1,i);if(l){var c=u;if(Pe.forEach(function(e){var t=e[0],r=e[1];if(Fe[t]!==L.InBlocksOnly){var n;r.initializer,(n=Fe[t]===L.InTextBlocks?ie(r,"let "):pe(r.name,r.initializer,!1,!0)).next=c,c=n}}),c){var d=K(e.pxtc.ON_START_TYPE);return d.handlers=[{name:"HANDLER",statement:c}],d}Se()}return u}l&&Se()}function Se(){p.alwaysEmitOnStart&&v('<block type="'+e.pxtc.ON_START_TYPE+'"></block>')}function Te(e,t){Fe[e]!==L.InTextBlocks&&(Fe[e]=t)}function Ee(t){e.forEachChild(t,function(e){e.kind===g.Identifier&&Te(Ke(e),L.InTextBlocks),Ee(e)})}function Ie(r){function n(e,r){var n=r.exec(e);if(n){var s=n[1].trim();if(s===t.ON_START_COMMENT||s===t.HANDLER_COMMENT)return;s?a+=a?" "+s:s:(i+=a+"\n",a="")}}for(var i="",a="",s=0,o=r;s<o.length;s++){var l=o[s],u=Ae.substr(l.pos,l.end-l.pos);if(l.kind===e.SyntaxKind.SingleLineCommentTrivia)n(u,I);else for(var c=0,p=u.split("\n");c<p.length;c++)n(p[c],w)}return(i+=a).trim()}function we(e){Pe.push([Ke(e.name),e])}function _e(e){return e.name.kind!==g.Identifier?(y(e,t.Util.lf("Variable declarations may not use binding patterns")),!1):!!e.initializer||(y(e,t.Util.lf("Variable declarations must have an initializer")),!1)}function Ke(e){if(h){var t=h.getRenameForPosition(e.getStart());if(t)return t.name}return e.text}var Ne=0,Le=c.statements,Ce={blocksInfo:a,outfiles:{},diagnostics:[],success:!0,times:{}},Ue={blocks:a,declaredFunctions:{}},Ae=c.getFullText(),$e="",Fe={},Pe=[];e.forEachChild(c,function(e){e.kind!==g.FunctionDeclaration||n(e,Ue,!1,!0)||(Ue.declaredFunctions[Ke(e.name)]=!0)});var De;try{De=xe(Le,void 0,!0)}catch(n){if(!n.programTooLarge)throw n;Ce.success=!1,Ce.diagnostics=t.patchUpDiagnostics([{file:c,start:c.getFullStart(),length:c.getFullWidth(),messageText:n.message,category:e.DiagnosticCategory.Error,code:r.FILE_TOO_LARGE_CODE}])}return De&&A(De),Ce.outfiles[c.fileName.replace(/(\.blocks)?\.\w*$/i,"")+".blocks"]='<xml xmlns="http://www.w3.org/1999/xhtml">\n'+$e+"</xml>",Ce}}(t.decompiler||(t.decompiler={}))}(e.pxtc||(e.pxtc={}))}(ts||(ts={}));var ts;!function(e){!function(e){!function(t){function r(e,t){return"movs $r5, $i0"==e.getOpExt()&&e.numArgs[0]!=t}function n(e,t){return!!("pop"==e.getOp()&&e.numArgs[0]&1<<t)}function i(t){e.assert("push"==t.getOp()||"pop"==t.getOp());for(var r=0,n=-1,i=t.numArgs[0];i>0;)1&i&&(n=-1==n?r:-2),i>>=1,r++;return n>=0?n:-1}var a=function(t){function a(){var e=this;t.call(this),this.addEnc("$r0","R0-7",function(t){return e.inrange(7,t,t)}),this.addEnc("$r1","R0-7",function(t){return e.inrange(7,t,t<<3)}),this.addEnc("$r2","R0-15",function(t){return e.inrange(15,t,7&t|(8&t)<<4)}),this.addEnc("$r3","R0-15",function(t){return e.inrange(15,t,t<<3)}),this.addEnc("$r4","R0-7",function(t){return e.inrange(7,t,t<<6)}),this.addEnc("$r5","R0-7",function(t){return e.inrange(7,t,t<<8)}),this.addEnc("$r01","R0-7",function(t){return e.inrange(7,t,t|t<<3)}),this.addEnc("$i0","#0-255",function(t){return e.inrange(255,t,t)}),this.addEnc("$i1","#0-1020",function(t){return e.inrange(255,t/4,t>>2)}),this.addEnc("$i2","#0-510",function(t){return e.inrange(127,t/4,t>>2)}),this.addEnc("$i3","#0-7",function(t){return e.inrange(7,t,t<<6)}),this.addEnc("$i4","#0-31",function(t){return e.inrange(31,t,t<<6)}),this.addEnc("$i5","#0-124",function(t){return e.inrange(31,t/4,t>>2<<6)}),this.addEnc("$i6","#1-32",function(t){return 0==t?null:32==t?0:e.inrange(31,t,t<<6)}),this.addEnc("$i7","#0-62",function(t){return e.inrange(31,t/2,t>>1<<6)}),this.addEnc("$i32","#0-2^32",function(e){return 1}),this.addEnc("$rl0","{R0-7,...}",function(t){return e.inrange(255,t,t)}),this.addEnc("$rl1","{LR,R0-7,...}",function(t){return 16384&t?e.inrange(255,-16385&t,256|255&t):e.inrange(255,t,t)}),this.addEnc("$rl2","{PC,R0-7,...}",function(t){return 32768&t?e.inrange(255,-32769&t,256|255&t):e.inrange(255,t,t)}),this.addEnc("$la","LABEL",function(t){return e.inrange(255,t/4,t>>2)}).isWordAligned=!0,this.addEnc("$lb","LABEL",function(t){return e.inrangeSigned(127,t/2,t>>1)}),this.addEnc("$lb11","LABEL",function(t){return e.inrangeSigned(1023,t/2,t>>1)}),this.addInst("adcs  $r0, $r1",16704,65472),this.addInst("add   $r2, $r3",17408,65280),this.addInst("add   $r5, pc, $i1",40960,63488),this.addInst("add   $r5, sp, $i1",43008,63488),this.addInst("add   sp, $i2",45056,65408).canBeShared=!0,this.addInst("adds  $r0, $r1, $i3",7168,65024),this.addInst("adds  $r0, $r1, $r4",6144,65024),this.addInst("adds  $r01, $r4",6144,65024),this.addInst("adds  $r5, $i0",12288,63488),this.addInst("adr   $r5, $la",40960,63488),this.addInst("ands  $r0, $r1",16384,65472),this.addInst("asrs  $r0, $r1",16640,65472),this.addInst("asrs  $r0, $r1, $i6",4096,63488),this.addInst("bics  $r0, $r1",17280,65472),this.addInst("bkpt  $i0",48640,65280),this.addInst("blx   $r3",18304,65415),this.addInst("bx    $r3",18176,65408),this.addInst("cmn   $r0, $r1",17088,65472),this.addInst("cmp   $r0, $r1",17024,65472),this.addInst("cmp   $r2, $r3",17664,65280),this.addInst("cmp   $r5, $i0",10240,63488),this.addInst("eors  $r0, $r1",16448,65472),this.addInst("ldmia $r5!, $rl0",51200,63488),this.addInst("ldmia $r5, $rl0",51200,63488),this.addInst("ldr   $r0, [$r1, $i5]",26624,63488),this.addInst("ldr   $r0, [$r1, $r4]",22528,65024),this.addInst("ldr   $r5, [pc, $i1]",18432,63488),this.addInst("ldr   $r5, $la",18432,63488),this.addInst("ldr   $r5, [sp, $i1]",38912,63488).canBeShared=!0,this.addInst("ldrb  $r0, [$r1, $i4]",30720,63488),this.addInst("ldrb  $r0, [$r1, $r4]",23552,65024),this.addInst("ldrh  $r0, [$r1, $i7]",34816,63488),this.addInst("ldrh  $r0, [$r1, $r4]",23040,65024),this.addInst("ldrsb $r0, [$r1, $r4]",22016,65024),this.addInst("ldrsh $r0, [$r1, $r4]",24064,65024),this.addInst("lsls  $r0, $r1",16512,65472),this.addInst("lsls  $r0, $r1, $i4",0,63488),this.addInst("lsrs  $r0, $r1",16576,65472),this.addInst("lsrs  $r0, $r1, $i6",2048,63488),this.addInst("mov   $r2, $r3",17920,65280),this.addInst("movs  $r0, $r1",0,65472),this.addInst("movs  $r5, $i0",8192,63488),this.addInst("muls  $r0, $r1",17216,65472),this.addInst("mvns  $r0, $r1",17344,65472),this.addInst("negs  $r0, $r1",16960,65472),this.addInst("nop",18112,65535),this.addInst("orrs  $r0, $r1",17152,65472),this.addInst("pop   $rl2",48128,65024),this.addInst("push  $rl1",46080,65024),this.addInst("rev   $r0, $r1",47616,65472),this.addInst("rev16 $r0, $r1",47680,65472),this.addInst("revsh $r0, $r1",47808,65472),this.addInst("rors  $r0, $r1",16832,65472),this.addInst("sbcs  $r0, $r1",16768,65472),this.addInst("sev",48960,65535),this.addInst("stmia $r5!, $rl0",49152,63488),this.addInst("str   $r0, [$r1, $i5]",24576,63488).canBeShared=!0,this.addInst("str   $r0, [$r1, $r4]",20480,65024),this.addInst("str   $r5, [sp, $i1]",36864,63488).canBeShared=!0,this.addInst("strb  $r0, [$r1, $i4]",28672,63488),this.addInst("strb  $r0, [$r1, $r4]",21504,65024),this.addInst("strh  $r0, [$r1, $i7]",32768,63488),this.addInst("strh  $r0, [$r1, $r4]",20992,65024),this.addInst("sub   sp, $i2",45184,65408),this.addInst("subs  $r0, $r1, $i3",7680,65024),this.addInst("subs  $r0, $r1, $r4",6656,65024),this.addInst("subs  $r01, $r4",6656,65024),this.addInst("subs  $r5, $i0",14336,63488),this.addInst("svc   $i0",57088,65280),this.addInst("sxtb  $r0, $r1",45632,65472),this.addInst("sxth  $r0, $r1",45568,65472),this.addInst("tst   $r0, $r1",16896,65472),this.addInst("udf   $i0",56832,65280),this.addInst("uxtb  $r0, $r1",45760,65472),this.addInst("uxth  $r0, $r1",45696,65472),this.addInst("wfe",48928,65535),this.addInst("wfi",48944,65535),this.addInst("yield",48912,65535),this.addInst("cpsid i",46706,65535),this.addInst("cpsie i",46690,65535),this.addInst("beq   $lb",53248,65280),this.addInst("bne   $lb",53504,65280),this.addInst("bcs   $lb",53760,65280),this.addInst("bcc   $lb",54016,65280),this.addInst("bmi   $lb",54272,65280),this.addInst("bpl   $lb",54528,65280),this.addInst("bvs   $lb",54784,65280),this.addInst("bvc   $lb",55040,65280),this.addInst("bhi   $lb",55296,65280),this.addInst("bls   $lb",55552,65280),this.addInst("bge   $lb",55808,65280),this.addInst("blt   $lb",56064,65280),this.addInst("bgt   $lb",56320,65280),this.addInst("ble   $lb",56576,65280),this.addInst("bhs   $lb",53760,65280),this.addInst("blo   $lb",54016,65280),this.addInst("b     $lb11",57344,63488),this.addInst("bal   $lb11",57344,63488),this.addInst("bl    $lb",61440,63488,!0),this.addInst("bb    $lb",57344,63488,!0),this.addInst("ldlit   $r5, $i32",18432,63488)}return __extends(a,t),a.prototype.toFnPtr=function(e,t){return e+t|1},a.prototype.wordSize=function(){return 4},a.prototype.is32bit=function(e){return"bl"==e.name||"bb"==e.name},a.prototype.postProcessAbsAddress=function(e,t){return t&=4294967294,t-=e.baseOffset},a.prototype.emit32=function(t,r,n){if(r%2)return e.assembler.emitErr("uneven BL?",n);var i=r/2;if(e.assert(null!=i),(0|i)!=i||!(-2097152<i&&i<2097152))return e.assembler.emitErr("jump out of range",n);var a=2047&i,s=i>>11&1023;return{opcode:4026531840&i?62464|s:61440|s,opcode2:63488|a,stack:0,numArgs:[r],labelName:n}},a.prototype.commonalize=function(t){if(e.target.commonalize){for(var r=[],n={},i=-1,a=0;a<t.lines.length;++a)if("empty"!=(L=t.lines[a]).type)if(function(e){if("empty"==e.type)return!0;if("instruction"==e.type){var t=e.instruction;if(t&&t.canBeShared)return!0;switch(e.words[0]){case"pop":case"push":return!(-16&e.numArgs[0]);case"bl":switch(e.words[1]){case"_numops_fromInt":case"_pxt_incr":case"_pxt_decr":case"pxt::incr":case"pxt::decr":case"pxt::fromInt":return!0;default:return!1}default:return!1}}return!1}(L))r.push(L);else{if("_js_end"==L.words[0]&&(i=a),r.length>2){for(var s="",o=0,l=r;o<l.length;o++){var u=l[o];"empty"!=u.type&&(e.assert(!!u.instruction),e.assert(!!u.opcode),s&&(s+=","),"bl"==u.words[0]?s+="BL "+u.words[1]:s+=u.opcode)}n[s]?n[s].push(r):n[s]=[r]}r=[]}if(!(i<0)){for(var c=0,p=Object.keys(n);c<p.length;c++)if(1==(E=n[T=p[c]]).length&&E[0].length>3){for(var d=T.split(","),f=d.slice(),m=E[0].slice(),h=E[0].slice(),g=null,b="";m.length>=3;){d.pop(),m.pop(),h.shift(),f.shift();var v=n[b=d.join(",")];if(v&&v.length){g=m;break}if(b=f.join(","),(v=n[b])&&v.length){g=h;break}}g&&(n[T]=[],n[b].push(g))}for(var y=[],k=0,x=0,S=Object.keys(n);x<S.length;x++){var T=S[x],E=n[T];if(!(E.length<=1)){0==y.length&&(t.buildLine("; shared assembly fragments",y),t.buildLine("@nostackcheck",y),t.buildLine("_frag_start:",y));var I=T.indexOf("BL")>=0,w="_frag_"+ ++k;t.buildLine("; num.uses: "+E.length,y),t.buildLine(w+":",y),I&&t.buildLine("mov r7, lr",y);for(var _=0,K=0,N=E[0];K<N.length;K++){var L=N[K],C=L.text.replace(/;.*/,"");/@\d/.test(C)&&(C=".short "+L.opcode+" ; "+C),t.buildLine(C,y),_+=L.stack}t.buildLine(I?"bx r7":"bx lr",y);for(var U=0,A=E;U<A.length;U++){var $=A[U];$[0].update("bl "+w),$[1].update("@dummystack "+_);for(var F=2;F<$.length;++F)$[F].update("")}}}y.length>0&&(t.lines=t.lines.slice(0,i).concat(y).concat(t.lines.slice(i)))}}},a.prototype.expandLdlit=function(t){for(var r,n=!1,i=[],a={},s=1,o=0;o<t.lines.length;++o){var l=t.lines[o];if(i.push(l),"instruction"==l.type&&l.instruction&&"ldlit"==l.instruction.name){if(!r){for(var u=l.location+900,c=o+1;c<t.lines.length&&!(t.lines[c].location>u);++c){var p=t.lines[c].getOp();("b"==p||"bb"==p||"pop"==p&&"pc"==t.lines[c].words[2])&&(r=t.lines[c])}if(r)n=!1;else for(n=!0;--c>o;)if("instruction"==t.lines[c].type){r=t.lines[c];break}}var d=l.words[1],f=l.words[3];(v=e.U.lookup(a,f))||(v="_ldlit_"+ ++s,a[f]=v),l.update("ldr "+d+", "+v)}if(l===r){r=null;var m=[],h="_jmpwords_"+ ++s;n&&m.push("bb "+h),m.push(".balign 4");for(var g=0,b=Object.keys(a);g<b.length;g++){var v=a[f=b[g]];m.push(v+": .word "+f)}n&&m.push(h+":");for(var y=0,k=m;y<k.length;y++){var x=k[y];t.buildLine(x,i);var S=i[i.length-1];S.scope=l.scope,S.lineNo=l.lineNo}a={}}}t.lines=i},a.prototype.getAddressFromLabel=function(e,t,r,n){void 0===n&&(n=!1);var i=e.lookupLabel(r);if(null==i)return null;var a=e.location()+4;return n&&(a&=4294967292),i-a},a.prototype.isPop=function(e){return 48128==e},a.prototype.isPush=function(e){return 46080==e},a.prototype.isAddSP=function(e){return 45056==e},a.prototype.isSubSP=function(e){return 45184==e},a.prototype.peephole=function(t,a,s){var o=this.encoders.$lb11,l=this.encoders.$lb,u=t.getOp(),c=!1;"bne"!=u&&"beq"!=u||("b"==a.getOp()&&0==t.numArgs[0]&&(c=!0),"bb"==a.getOp()&&2==t.numArgs[0]&&(c=!0)),"bb"==u&&null!=o.encode(t.numArgs[0])?t.update("b "+t.words[1]):"b"==u&&-2==t.numArgs[0]?t.update(""):"bne"==u&&c&&null!=l.encode(a.numArgs[0])?(t.update("beq "+a.words[1]),a.update("")):"beq"==u&&c&&null!=l.encode(a.numArgs[0])?(t.update("bne "+a.words[1]),a.update("")):"push"==u&&"pop"==a.getOp()&&t.numArgs[0]==a.numArgs[0]?(e.assert(t.numArgs[0]>0),t.update(""),a.update("")):"push"==u&&"pop"==a.getOp()&&4==t.words.length&&4==a.words.length?(e.assert("{"==t.words[1]),t.update("mov "+a.words[2]+", "+t.words[2]),a.update("")):s&&"movs $r5, $i0"==t.getOpExt()&&"mov $r0, $r1"==a.getOpExt()&&t.numArgs[0]==a.numArgs[1]&&n(s,t.numArgs[0])?(t.update("movs r"+a.numArgs[0]+", #"+t.numArgs[1]),a.update("")):"pop"==u&&i(t)>=0&&"push"==a.getOp()&&i(t)==i(a)?(t.update("ldr r"+i(t)+", [sp, #0]"),a.update("")):s&&"push"==u&&i(t)>=0&&r(a,i(t))&&"pop"==s.getOp()&&i(t)==i(s)&&(t.update(""),s.update(""))},a.prototype.registerNo=function(e){if(!e)return null;switch(e=e.toLowerCase()){case"pc":e="r15";break;case"lr":e="r14";break;case"sp":e="r13"}var t=/^r(\d+)$/.exec(e);if(t){var r=parseInt(t[1],10);if(0<=r&&r<16)return r}return null},a.prototype.testAssembler=function(){e.assembler.expectError(this,"lsl r0, r0, #8"),e.assembler.expectError(this,"push {pc,lr}"),e.assembler.expectError(this,"push {r17}"),e.assembler.expectError(this,"mov r0, r1 foo"),e.assembler.expectError(this,"movs r14, #100"),e.assembler.expectError(this,"push {r0"),e.assembler.expectError(this,"push lr,r0}"),e.assembler.expectError(this,"pop {lr,r0}"),e.assembler.expectError(this,"b #+11"),e.assembler.expectError(this,"b #+102400"),e.assembler.expectError(this,"bne undefined_label"),e.assembler.expectError(this,".foobar"),e.assembler.expect(this,"0200      lsls    r0, r0, #8\nb500      push    {lr}\n2064      movs    r0, #100        ; 0x64\nb401      push    {r0}\nbc08      pop     {r3}\nb501      push    {r0, lr}\nbd20      pop {r5, pc}\nbc01      pop {r0}\n4770      bx      lr\n0000      .balign 4\ne6c0      .word   -72000\nfffe\n"),e.assembler.expect(this,"4291      cmp     r1, r2\nd100      bne     l6\ne000      b       l8\n1840  l6: adds    r0, r0, r1\n4718  l8: bx      r3\n"),e.assembler.expect(this,"          @stackmark base\nb403      push    {r0, r1}\n          @stackmark locals\n9801      ldr     r0, [sp, locals@1]\nb401      push    {r0}\n9802      ldr     r0, [sp, locals@1]\nbc01      pop     {r0}\n          @stackempty locals\n9901      ldr     r1, [sp, locals@1]\n9102      str     r1, [sp, base@0]\n          @stackempty locals\nb002      add     sp, #8\n          @stackempty base\n"),e.assembler.expect(this,"b090      sub sp, #4*16\nb010      add sp, #4*16\n"),e.assembler.expect(this,'6261      .string "abc"\n0063      \n'),e.assembler.expect(this,'6261      .string "abcde"\n6463      \n0065      \n'),e.assembler.expect(this,"3042      adds r0, 0x42\n1c0d      adds r5, r1, #0\nd100      bne #0\n2800      cmp r0, #0\n6b28      ldr r0, [r5, #48]\n0200      lsls r0, r0, #8\n2063      movs r0, 0x63\n4240      negs r0, r0\n46c0      nop\nb500      push {lr}\nb401      push {r0}\nb402      push {r1}\nb404      push {r2}\nb408      push {r3}\nb520      push {r5, lr}\nbd00      pop {pc}\nbc01      pop {r0}\nbc02      pop {r1}\nbc04      pop {r2}\nbc08      pop {r3}\nbd20      pop {r5, pc}\n9003      str r0, [sp, #4*3]\n")},a}(e.assembler.AbstractProcessor);t.ThumbProcessor=a}(e.thumb||(e.thumb={}))}(e.pxtc||(e.pxtc={}))}(ts||(ts={}));var ts;!function(e){!function(e){!function(t){function r(r){function n(r){if(r.isExpr()){var i=r,a=i.args?i.args[0]:null;switch(i.exprKind){case p.NumberLiteral:case p.PointerLiteral:return i.data+"";case p.CellRef:return i.data.toString();case p.JmpValue:return"JMPVALUE";case p.Nop:return"NOP";case p.SharedRef:return"SHARED_REF(#"+a.getId()+")";case p.SharedDef:return"SHARED_DEF(#"+a.getId()+": "+n(a)+")";case p.Incr:return"INCR("+n(a)+")";case p.Decr:return"DECR("+n(a)+")";case p.FieldAccess:return n(a)+"."+i.data.name;case p.RuntimeCall:return i.data+"("+i.args.map(n).join(", ")+")";case p.ProcCall:var s=i.data;return(null!=s.ifaceIndex?"IFACE@"+s.ifaceIndex:null!=s.virtualIndex?"VTABLE@"+s.virtualIndex:e.getDeclName(s.proc.action))+"("+i.args.map(n).join(", ")+")";case p.Sequence:return"("+i.args.map(n).join("; ")+")";case p.Store:return"{ "+n(i.args[0])+" := "+n(i.args[1])+" }";default:throw e.oops()}}else{var o=r,l=o.expr?n(o.expr):"{null}";switch(o.stmtKind){case t.SK.Expr:return"    "+l+"\n";case t.SK.Jmp:var u="goto "+o.lblName+"\n";switch(o.jmpMode){case g.Always:return o.expr?"    { JMPVALUE := "+l+" } "+u:"    "+u;case g.IfZero:return"    if (! "+l+") "+u;case g.IfNotZero:return"    if ("+l+") "+u;case g.IfJmpValEq:return"    if (r0 == "+l+") "+u;case g.IfLambda:return"    if (LAMBDA) return "+l;default:throw e.oops()}case t.SK.StackEmpty:return"    ;\n";case t.SK.Breakpoint:return"    // brk "+o.breakpointInfo.id+"\n";case t.SK.Label:return o.lblName+":\n";default:throw e.oops()}}}return n(r)}function n(e){switch(e.exprKind){case t.EK.Sequence:return n(e.args[e.args.length-1]);case t.EK.NumberLiteral:return!0;case t.EK.RuntimeCall:switch(e.data){case"String_::mkEmpty":case"pxt::ptrOfLiteral":return!0;default:return!1}case t.EK.SharedDef:case t.EK.SharedRef:return n(e.args[0]);default:return!1}}function i(e,t){if(t(e),e.args)for(var r=0,n=e.args;r<n.length;r++)i(n[r],t)}function a(e,t){return new b(e,t)}function s(e,t,r){return new m(e,t,r)}function o(e){switch(e.exprKind){case p.NumberLiteral:case p.SharedRef:return e}return s(p.SharedRef,[e])}function l(e,t){return s(p.RuntimeCall,t,e)}var u=e.Util,c=u.assert;!function(e){e[e.None=0]="None",e[e.NumberLiteral=1]="NumberLiteral",e[e.PointerLiteral=2]="PointerLiteral",e[e.RuntimeCall=3]="RuntimeCall",e[e.ProcCall=4]="ProcCall",e[e.SharedRef=5]="SharedRef",e[e.SharedDef=6]="SharedDef",e[e.FieldAccess=7]="FieldAccess",e[e.Store=8]="Store",e[e.CellRef=9]="CellRef",e[e.Incr=10]="Incr",e[e.Decr=11]="Decr",e[e.Sequence=12]="Sequence",e[e.JmpValue=13]="JmpValue",e[e.Nop=14]="Nop"}(t.EK||(t.EK={}));var p=t.EK,d=0,f=function(){function e(){}return e.prototype.isExpr=function(){return!1},e.prototype.isStmt=function(){return!1},e.prototype.getId=function(){return this._id||(this._id=++d),this._id},e}();t.Node=f;var m=function(n){function i(e,r,i){n.call(this),this.exprKind=e,this.args=r,this.data=i,this.callingConvention=t.CallingConvention.Plain}return __extends(i,n),i.clone=function(e){var t=new i(e.exprKind,e.args.slice(0),e.data);return e.jsInfo&&(t.jsInfo=e.jsInfo),e.totalUses&&(t.totalUses=e.totalUses,t.currUses=e.currUses),t.callingConvention=e.callingConvention,t},i.prototype.isExpr=function(){return!0},i.prototype.isPure=function(){return this.isStateless()||this.exprKind==p.CellRef},i.prototype.isStateless=function(){switch(this.exprKind){case p.NumberLiteral:case p.PointerLiteral:case p.SharedRef:return!0;default:return!1}},i.prototype.sharingInfo=function(){var e=this;return this.exprKind!=p.SharedRef&&this.exprKind!=p.SharedDef||(e=this.args[0])||(e={currUses:"",totalUses:""}),e.currUses+"/"+e.totalUses},i.prototype.toString=function(){return r(this)},i.prototype.canUpdateCells=function(){switch(this.exprKind){case p.NumberLiteral:case p.PointerLiteral:case p.CellRef:case p.JmpValue:case p.SharedRef:case p.Nop:return!1;case p.SharedDef:case p.Incr:case p.Decr:case p.FieldAccess:return this.args[0].canUpdateCells();case p.RuntimeCall:case p.ProcCall:case p.Sequence:case p.Store:return!0;default:throw e.oops()}},i}(f);t.Expr=m,function(e){e[e.None=0]="None",e[e.Expr=1]="Expr",e[e.Label=2]="Label",e[e.Jmp=3]="Jmp",e[e.StackEmpty=4]="StackEmpty",e[e.Breakpoint=5]="Breakpoint"}(t.SK||(t.SK={}));var h=t.SK;!function(e){e[e.Always=1]="Always",e[e.IfZero=2]="IfZero",e[e.IfNotZero=3]="IfNotZero",e[e.IfJmpValEq=4]="IfJmpValEq",e[e.IfLambda=5]="IfLambda"}(t.JmpMode||(t.JmpMode={}));var g=t.JmpMode,b=function(e){function t(t,r){e.call(this),this.stmtKind=t,this.expr=r}return __extends(t,e),t.prototype.isStmt=function(){return!0},t.prototype.toString=function(){return r(this)},t}(f);t.Stmt=b;var v=function(){function t(t,r,n){this.index=t,this.def=r,this.info=n,this.isarg=!1,this.iscap=!1,this._isRef=!1,this._isLocal=!1,this._isGlobal=!1,this._debugType="?",this.bitSize=0,r&&n&&e.setCellProps(this)}return t.prototype.getName=function(){return e.getDeclName(this.def)},t.prototype.getDebugInfo=function(){return{name:this.getName(),type:this._debugType,index:this.index}},t.prototype.toString=function(){var e="";return this.def&&(e+=this.getName()||"?"),this.isarg&&(e="ARG "+e),this.isRef()&&(e="REF "+e),"["+e+"]"},t.prototype.uniqueName=function(){return this.isarg?"arg"+this.index:this.getName().replace(/[^\w]/g,"_")+"___"+e.getNodeId(this.def)},t.prototype.refSuffix=function(){return this.isRef()?"Ref":""},t.prototype.isRef=function(){return this._isRef},t.prototype.isLocal=function(){return this._isLocal},t.prototype.isGlobal=function(){return this._isGlobal},t.prototype.loadCore=function(){return s(p.CellRef,null,this)},t.prototype.load=function(){var t=this.loadCore();return e.target.taggedInts&&0!=this.bitSize?6==this.bitSize?l("pxt::fromUInt",[t]):l("pxt::fromInt",[t]):this.isByRefLocal()?l("pxtrt::ldloc"+this.refSuffix(),[t]):this.refCountingHandledHere()?s(p.Incr,[t]):t},t.prototype.refCountingHandledHere=function(){return this.isRef()&&!this.isByRefLocal()},t.prototype.isByRefLocal=function(){return this.isLocal()&&this.info.captured&&this.info.written},t.prototype.storeDirect=function(e){return s(p.Store,[this.loadCore(),e])},t.prototype.storeByRef=function(t){if(this.isByRefLocal())return l("pxtrt::stloc"+this.refSuffix(),[this.loadCore(),t]);if(e.target.taggedInts&&0!=this.bitSize){t=o(t);var r=o(l(6==this.bitSize?"pxt::toUInt":"pxt::toInt",[t]));return s(p.Sequence,[r,s(p.Decr,[t]),this.storeDirect(r)])}if(this.refCountingHandledHere()){var n=o(t);return s(p.Sequence,[n,s(p.Decr,[this.loadCore()]),this.storeDirect(n)])}return this.storeDirect(t)},Object.defineProperty(t.prototype,"isTemporary",{get:function(){return!1},enumerable:!0,configurable:!0}),t}();t.Cell=v;var y=function(e){function t(r,n){e.call(this,r,null,null),this.index=r,this.owningProc=n,this.uid=t.unnamedCellCounter++}return __extends(t,e),t.prototype.getName=function(){return"unnamed"+this.uid},t.prototype.uniqueName=function(){return this.getName()+"___U"+this.index},t.prototype.isByRefLocal=function(){return!1},Object.defineProperty(t.prototype,"isTemporary",{get:function(){return!0},enumerable:!0,configurable:!0}),t.unnamedCellCounter=0,t}(v);t.UnnamedCell=y;var k=function(r){function i(){r.apply(this,arguments),this.numArgs=0,this.isRoot=!1,this.locals=[],this.captured=[],this.args=[],this.body=[],this.lblNo=0}return __extends(i,r),i.prototype.reset=function(){this.body=[],this.lblNo=0,this.locals=[],this.captured=[],this.args=[]},i.prototype.label=function(){return e.getFunctionLabel(this.action,this.bindings)},i.prototype.matches=function(e){if(this.action==e.action){u.assert(this.bindings.length==e.bindings.length,"this.bindings.length == id.bindings.length");for(var t=0;t<this.bindings.length;++t)if(this.bindings[t].isRef!=e.bindings[t].isRef)return!1;return!0}return!1},i.prototype.toString=function(){return"\nPROC "+e.getDeclName(this.action)+"\n"+this.body.map(function(e){return e.toString()}).join("")+"\n"},i.prototype.emit=function(e){this.body.push(e)},i.prototype.emitExpr=function(e){this.emit(a(h.Expr,e))},i.prototype.mkLabel=function(e){var t=a(h.Label,null);return t.lblName="."+e+"_"+this.lblNo+++"_"+this.seqNo,t.lbl=t,t},i.prototype.emitLbl=function(e){this.emit(e)},i.prototype.emitLblDirect=function(e){var t=a(h.Label,null);t.lblName=e,t.lbl=t,this.emit(t)},i.prototype.getName=function(){return(this.action&&this.action.name?this.action.name.text:null)||"inline"},i.prototype.mkLocal=function(e,t){var r=new v(this.locals.length,e,t);return this.locals.push(r),r},i.prototype.mkLocalUnnamed=function(e){void 0===e&&(e=!1);var t=new y(this.locals.length,this);return t._isRef=e,this.locals.push(t),t},i.prototype.localIndex=function(e,t){return void 0===t&&(t=!1),this.captured.filter(function(t){return t.def==e})[0]||this.locals.filter(function(t){return t.def==e})[0]||(t?null:this.args.filter(function(t){return t.def==e})[0])},i.prototype.stackEmpty=function(){this.emit(a(h.StackEmpty,null))},i.prototype.emitClrIfRef=function(e){c(!e.isGlobal()&&!e.iscap,"!p.isGlobal() && !p.iscap"),(e.isRef()||e.isByRefLocal())&&this.emitExpr(s(p.Decr,[e.loadCore()]))},i.prototype.emitClrs=function(r,n){var i=this;this.isRoot||(this.locals.forEach(function(e){return i.emitClrIfRef(e)}),e.isStackMachine()&&this.args.some(function(e){return e.isRef()||e.isByRefLocal()})&&this.emitJmp(r,n,t.JmpMode.IfLambda),this.args.forEach(function(e){return i.emitClrIfRef(e)}))},i.prototype.emitJmpZ=function(e,t){this.emitJmp(e,t,g.IfZero)},i.prototype.emitJmp=function(e,t,r,n){void 0===r&&(r=g.Always),void 0===n&&(n=null);var i=a(h.Jmp,t);i.jmpMode=r,n&&n.exprKind==p.NumberLiteral&&(n=null),i.terminateExpr=n,"string"==typeof e?i.lblName=e:(i.lbl=e,i.lblName=i.lbl.lblName),this.emit(i)},i.prototype.resolve=function(){var r=function(e,t){if(e.args)for(var r=0;r<e.args.length;++r)e.args[r]=t(e.args[r])},i=function(e){switch(e.exprKind){case p.SharedDef:throw u.oops();case p.SharedRef:var t=e.args[0];if(t.totalUses)return t.totalUses--,e;t.totalUses=-1,t.currUses=0;var n=m.clone(e);return n.exprKind=p.SharedDef,n.args[0]=i(n.args[0]),n}return r(e,i),e},a=function(e){if(e.exprKind==p.SharedRef)return e;if(r(e,a),(e.exprKind==p.Decr||e.exprKind==p.Incr)&&n(e.args[0]))return e.args[0];switch(e.exprKind){case p.Decr:if(e.args[0].exprKind==p.Incr)return e.args[0].args[0];break;case p.Sequence:e.args=e.args.filter(function(t,r){return r==e.args.length-1||!t.isPure()})}return e},s=function(e){switch(e.exprKind){case p.SharedDef:var t=e.args[0];if(u.assert(t.totalUses<0,"arg.totalUses < 0"),u.assert(0===t.currUses,"arg.currUses === 0"),-1==t.totalUses)return s(t);t.totalUses=1;break;case p.SharedRef:return u.assert(e.args[0].totalUses>0,"e.args[0].totalUses > 0"),e.args[0].totalUses++,e}return r(e,s),e};this.body=this.body.filter(function(e){return!e.expr||(e.expr=a(i(e.expr)),e.stmtKind!=t.SK.Expr||!e.expr.isPure())});for(var o=u.toDictionary(this.body.filter(function(e){return e.stmtKind==t.SK.Label}),function(e){return e.lblName}),l=0;l<this.body.length;++l)this.body[l].stmtNo=l;for(var c=0,d=this.body;c<d.length;c++)switch((b=d[c]).expr&&(b.expr=s(b.expr)),b.stmtKind){case t.SK.Expr:break;case t.SK.Jmp:b.lbl=u.lookup(o,b.lblName),b.lbl||e.oops("missing label: "+b.lblName),b.lbl.lblNumUses++;break;case t.SK.StackEmpty:case t.SK.Label:case t.SK.Breakpoint:break;default:e.oops()}for(var f=[],h=0,g=this.body;h<g.length;h++)(b=g[h]).stmtKind==t.SK.Breakpoint&&(f[b.breakpointInfo.id]=b.breakpointInfo);var b},i}(f);t.Procedure=k,t.iterExpr=i,t.stmt=a,t.op=s,t.numlit=function(e){return s(p.NumberLiteral,null,e)},t.shared=o,t.ptrlit=function(t,r,n){void 0===n&&(n=!1);var i=s(p.PointerLiteral,null,t);if(i.jsInfo=r,n){if(e.target.isNative&&e.isAVR())return l("pxt::stringLiteral",[i]);i.args=[]}return i},t.rtcall=l,t.rtcallMask=function(t,r,n,i){var a=[];u.startsWith(t,"@nomask@")&&(t=t.slice(8),r=0),e.isStackMachine()?t+="^"+r:i=i.map(function(e,t){return r&1<<t?(e=o(e),a.push(s(p.Decr,[e])),e):e});var l=s(p.RuntimeCall,i,t);return l.callingConvention=n,a.length>0&&(l=o(l),a.unshift(l),a.push(l),l=s(p.Sequence,a)),l},t.flattenArgs=function(r){for(var n=!1,i=[],a=0,s=u.reversed(r.args);a<s.length;a++){var o=s[a];o.isStateless()||(o.exprKind!=p.CellRef||n)&&(o.canUpdateCells()&&(n=!0),i.push(o))}i.reverse(),e.isStackMachine()&&(i=[]);var l=[],c=r.args.map(function(e){if(i.indexOf(e)>=0){var r=e,n=e;return e.exprKind==p.SharedDef?(e.args[0].totalUses++,r=t.op(p.SharedRef,[e.args[0]])):(r=t.op(p.SharedRef,[e]),n=t.op(p.SharedDef,[e]),e.totalUses=2,e.currUses=0),l.push(n),r}return e});return{precomp:l,flattened:c}}}(e.ir||(e.ir={}))}(e.pxtc||(e.pxtc={}))}(ts||(ts={}));var ts;!function(e){!function(t){function r(e){return e<<2|2}function n(e){return!t.target.boxDebug&&((0|e)==e&&-1073741824<=e&&e<=1073741823)}function i(e){var t=e;return t.pxtNodeWave!==he&&(t.pxtNodeId=++me,t.pxtNodeWave=he),t.pxtNodeId}function a(t){return t?e.SyntaxKind[t.kind]:"<null>"}function s(e,t,r){void 0===r&&(r=!1);var n=new Error(t);if(n.ksEmitterUserError=!0,n.ksErrorCode=e,r&&ke)return be||(be=t,ye=e),n;throw n}function o(){return t.target.nativeType==t.NATIVE_TYPE_CS||!t.target.jsRefCounting&&!t.target.isNative}function l(){return t.target.isNative&&t.target.nativeType==t.NATIVE_TYPE_AVRVM}function u(){return t.target.isNative&&(t.target.nativeType==t.NATIVE_TYPE_AVRVM||t.target.nativeType==t.NATIVE_TYPE_AVR)}function c(){return t.target.isNative&&t.target.nativeType==t.NATIVE_TYPE_THUMB}function p(r){if(H(r),o())return!1;if(r.flags&e.TypeFlags.ThisType)return!0;if(r.flags&e.TypeFlags.Null)return!1;if(r.flags&e.TypeFlags.Undefined)return!1;if(r.flags&e.TypeFlags.TypeParameter){var n=G(r);if(n)return n.isRef;t.U.oops("unbound type parameter: "+ge.typeToString(r))}if(r.flags&(e.TypeFlags.NumberLike|e.TypeFlags.Boolean))return!!t.target.taggedInts;var i=r.getSymbol();if(i){var a=i.valueDeclaration||i.declarations[0];if(a&&F(a).noRefCounting)return!1}return!0}function d(e){return!!e.isThisParameter}function f(e){return!!d(e)||p(Z(e))}function m(e){return t.target.taggedInts?t.ir.rtcall("pxt::fromInt",[e]):e}function h(e){return t.target.taggedInts?t.ir.rtcall("pxt::fromBool",[e]):e}function g(e){return t.target.taggedInts?t.ir.rtcall("pxt::fromFloat",[e]):e}function b(e){return t.target.taggedInts?t.ir.rtcall("pxt::fromDouble",[e]):e}function v(r){if(!r||!r.type)return 0;if(!(Z(r).flags&e.TypeFlags.Number))return 0;if(r.type.kind!=t.SK.TypeReference)return 0;switch(r.type.typeName.getText()){case"int8":return 1;case"int16":return 3;case"int32":return 5;case"uint8":return 2;case"uint16":return 4;case"uint32":return 6;default:return 0}}function y(e){switch(e){case 0:return t.target.shortPointers?2:4;case 1:return 1;case 3:return 2;case 5:return 4;case 2:return 1;case 4:return 2;case 6:return 4;default:throw t.oops()}}function k(e){switch(e){case 1:case 3:case 5:return!0;case 2:case 4:case 6:return!1;default:throw t.oops()}}function x(e){switch(e.kind){case t.SK.TemplateHead:case t.SK.TemplateMiddle:case t.SK.TemplateTail:case t.SK.StringLiteral:case t.SK.NoSubstitutionTemplateLiteral:return!0;default:return!1}}function S(e){return x(e)&&""==e.text}function T(e){return e.modifiers&&e.modifiers.some(function(e){return e.kind==t.SK.StaticKeyword})}function E(e){if(!e)return null;switch(e.kind){case t.SK.MethodDeclaration:return"";case t.SK.Constructor:return"new/";case t.SK.GetAccessor:return"get/";case t.SK.SetAccessor:return"set/";default:return null}}function I(e){return E(e)+P(e)}function w(e){return null!=E(e)}function _(e){return e?w(e)?e:_(e.parent):null}function K(e){for(var r=e;;)switch((r=r.parent)||s(9229,ve("cannot determine parent of {0}",a(e))),r.kind){case t.SK.MethodDeclaration:case t.SK.Constructor:case t.SK.GetAccessor:case t.SK.SetAccessor:case t.SK.FunctionDeclaration:case t.SK.ArrowFunction:case t.SK.FunctionExpression:return r;case t.SK.SourceFile:return null}}function N(e){return!!e&&(e.kind==t.SK.VariableDeclaration&&!K(e)||e.kind==t.SK.PropertyDeclaration&&T(e))}function L(e){return e.kind==t.SK.VariableDeclaration&&!N(e)}function C(e){return e.kind==t.SK.Parameter}function U(e){return e.kind==t.SK.FunctionDeclaration&&!K(e)||w(e)}function A(r){r.kind==t.SK.VariableDeclaration&&(r=r.parent.parent);var n=function(t){var r=e.getSourceFileOfNode(t),n=e.getLeadingCommentRangesOfNodeFromText(t,r.text);return n?n.map(function(e){return r.text.slice(e.pos,e.end)}).join("\n"):""};return r.symbol&&r.symbol.declarations.length>1?r.symbol.declarations.map(n).join("\n"):n(r)}function $(e){for(var r="",n=0,i=e.declarations;n<i.length;n++)r+=A(i[n]);return t.parseCommentString(r)}function F(e){if(!e||e.isBogusFunction)return t.parseCommentString("");var r=e,n=r.pxtCommentAttrs;if(n)return n;var i=t.parseCommentString(A(r));if(i._name=P(r),e.kind==t.SK.FunctionDeclaration&&"true"===i.block&&!i.blockId){var a=e;a.symbol.parent&&(i.blockId=a.symbol.parent.name+"_"+ie(a),i.block=t.U.uncapitalize(r.symbol.name)+(a.parameters.length?"|"+a.parameters.filter(function(e){return!e.questionToken}).map(function(e){return t.U.uncapitalize(e.name.text)+" %"+e.name.text}).join("|"):""))}return r.pxtCommentAttrs=i,i}function P(e){return e.name&&e.name.kind==t.SK.Identifier?e.name.text:"???"}function D(t){if(t.flags&e.TypeFlags.Reference){var r=t;if(r.typeArguments&&r.typeArguments.length)return r.target}return null}function R(t){return t.flags&e.TypeFlags.Reference&&"Array"==t.symbol.name}function M(t){return!!(t.flags&e.TypeFlags.Interface)||!!(t.flags&e.TypeFlags.Anonymous)}function O(t){return!!(t.flags&e.TypeFlags.Class)||!!(t.flags&e.TypeFlags.ThisType)}function B(t){return t.symbol&&0!=(t.symbol.flags&(e.SymbolFlags.ObjectLiteral|e.SymbolFlags.TypeLiteral))}function q(e){return null==J(e)&&(O(e)||M(e)||B(e))}function j(t){return q(t)||t.flags&(e.TypeFlags.Null|e.TypeFlags.Undefined)}function z(e){var t=D(e);return O(t?t:e)}function V(e){return R(e)?H(e.typeArguments[0]):null}function J(t){if(t.getApparentProperties().length>0||t.getConstructSignatures().length>0)return null;var r=ge.getSignaturesOfType(t,e.SignatureKind.Call);return r&&1==r.length?r[0]:null}function G(t){if(!(t.flags&e.TypeFlags.TypeParameter))return null;for(var r=xe.length-1;r>=0;--r)if(xe[r].tp==t)return xe[r];return null}function H(t){var r=e.TypeFlags.String|e.TypeFlags.Number|e.TypeFlags.Boolean|e.TypeFlags.Void|e.TypeFlags.Enum|e.TypeFlags.Null|e.TypeFlags.Undefined;if(0==(t.flags&r)){if(R(t))return t;if(O(t))return t;if(M(t))return t;if(J(t))return t;if(G(t))return t;var n=D(t);if(n)return H(n),t.typeArguments.forEach(H),t;s(9201,ve("unsupported type: {0} 0x{1}",ge.typeToString(t),t.flags.toString(16)),!0)}return t}function Z(t){var r;if(t.typeOverride)return t.typeOverride;if(e.isExpression(t)&&(r=ge.getContextualType(t)),!r)try{r=ge.getTypeAtLocation(t)}catch(e){s(9203,ve("Unknown type for expression"))}return r?H(r):r}function W(e,r){if(e==r)return!0;if(e.heritageClauses)for(var n=0,i=e.heritageClauses;n<i.length;n++){var a=i[n];switch(a.token){case t.SK.ExtendsKeyword:var s=Z(a.types[0]);if(O(s))return W(s.symbol.valueDeclaration,r)}}return!1}function Y(e,r){for(var n in r)r[n].decl.symbol==e.symbol&&s(9261,ve("Interface with same name as a class not supported"));if(e.heritageClauses)for(var i=0,a=e.heritageClauses;i<a.length;i++){var o=a[i];switch(o.token){case t.SK.ExtendsKeyword:O(Z(o.types[0]))&&s(9262,ve("Extending a class by an interface not supported."))}}}function X(t,r){var n=r.kind?ge.getTypeAtLocation(r):r,i=t.kind?ge.getTypeAtLocation(t):t,a=e.isExpression(r)?ge.getContextualType(r):n;a||(a=n);var o=e.isExpression(t)?ge.getContextualType(t):i;if(o||(o=i),a&&o){a==o&&o!=i&&(o=i),Se=[];var l=ee(o,a),u=l[0],c=l[1];u||s(9263,ve(c))}}function Q(e,t){return Te[e]=t,Se.pop(),t}function ee(r,n){function i(){var t=ge.getPropertiesOfType(n),i=ge.getPropertiesOfType(r),s=[!0,""],o=s[0],l=s[1];return t.forEach(function(t){var n=t.valueDeclaration,a=i.filter(function(e){return e.name==t.name});if(1==a.length){var s=a[0].valueDeclaration,u=ee(ge.getTypeAtLocation(s),ge.getTypeAtLocation(n)),c=u[0],p=u[1];o&&!c&&(d=[c,p],o=d[0],l=d[1])}else 0==a.length&&(t.flags&e.SymbolFlags.Optional||(f=[!1,"Property "+t.name+" not present in "+r.getSymbol().name],o=f[0],l=f[1]));var d,f}),Q(a,[o,l])}var a=r.id+","+n.id;if(Te[a])return Te[a];if(-1!=Se.indexOf(a))return[!0,""];if(Se.push(a),n.flags&e.TypeFlags.Any)return Q(a,[!1,"Unsupported type: any."]);if(q(n)&&!j(r))return Q(a,[!1,"Cast to class/interface not supported."]);if(O(n)){if(O(r)){var s=n.symbol.valueDeclaration,o=r.symbol.valueDeclaration;return W(o,s)?i():W(s,o)?Q(a,[!1,"Downcasts not supported."]):Q(a,[!1,"Classes "+o.name.getText()+" and "+s.name.getText()+" are not related by inheritance."])}if(!(r.flags&(e.TypeFlags.Undefined|e.TypeFlags.Null)))return Q(a,[!1,"Cast to class not supported."])}else if(J(n)){var l=J(n);if(J(r)){var u=J(r);t.U.assert(l.parameters.length>=u.parameters.length,"sup should have at least params of sub");for(var c=[!0,""],p=c[0],d=c[1],f=0;f<u.parameters.length;f++){var m=ee(ge.getTypeAtLocation(l.parameters[f].valueDeclaration),ge.getTypeAtLocation(u.parameters[f].valueDeclaration)),h=m[0],g=m[1];p&&!h&&(S=[h,g],p=S[0],d=S[1])}var b=l.getReturnType(),v=ee(l.getReturnType(),b),y=v[0],k=v[1];return p&&!y&&(T=[y,k],p=T[0],d=T[1]),Q(a,[p,d])}}else if(M(n)){if(q(r))return i()}else if(R(n)){if(R(r)){var x=V(n);return ee(V(r),x)}}else G(n);return Q(a,[!0,""]);var S,T}function te(e){return re(e).length>0}function re(e){return e.typeParameters&&e.typeParameters.length?e.typeParameters:!w(e)&&e.kind!=t.SK.MethodSignature||e.parent.kind!=t.SK.ClassDeclaration&&e.parent.kind!=t.SK.InterfaceDeclaration?[]:e.parent.typeParameters||[]}function ne(t){var r=ge.getSignatureFromDeclaration(t);return!(ge.getReturnTypeOfSignature(r).flags&e.TypeFlags.Void)}function ie(e){var r=e&&e.name?e.name.text:null;return r||e.kind!=t.SK.Constructor||(r="constructor"),e&&e.parent&&e.parent.kind==t.SK.ClassDeclaration&&(r=e.parent.name.text+"."+r),r=r||"inline"}function ae(e){var t=D(e);return t?se(t.typeParameters,e.typeArguments):[]}function se(e,r){return t.U.assert(e.length==r.length,"typeParameters.length == args.length"),e.map(function(e,t){return{tp:e,isRef:p(r[t])}})}function oe(e){var t=[];return le(t,e),t}function le(e,r){if(r)for(var n=K(r);n;n=K(n))for(var i=0,a=re(n);i<a.length;i++)!function(r){var n=ge.getTypeAtLocation(r),i=xe.filter(function(e){return e.tp==n})[0];i||t.U.oops("cannot find binding for: "+ge.typeToString(n)),e.push(i)}(a[i])}function ue(e){return e&&e.length?"_"+e.map(function(e){return e.isRef?"R":"P"}).join(""):""}function ce(e,t){return ie(e).replace(/[^\w]+/g,"_")+"__P"+i(e)+ue(t)}function pe(e,r){return{kind:t.SK.MethodDeclaration,parameters:[],name:{kind:t.SK.Identifier,text:r,pos:0,end:0},body:{kind:t.SK.Block,statements:[]},parent:e.decl,pos:0,end:0,isBogusFunction:!0}}function de(e){var r=new Float64Array(1);return r[0]=e,t.U.toHex(new Uint8Array(r.buffer))}t.taggedUndefined=0,t.taggedNull=r(1),t.taggedFalse=r(2),t.taggedTrue=r(16),t.thumbArithmeticInstr={adds:!0,subs:!0,muls:!0,ands:!0,orrs:!0,eors:!0,lsls:!0,asrs:!0,lsrs:!0},t.numberArithmeticInstr={div:!0,mod:!0,le:!0,lt:!0,ge:!0,gt:!0,eq:!0,neq:!0};var fe=t.ir.EK;t.SK=e.SyntaxKind,t.numReservedGlobals=1;var me=0,he=1;t.getNodeId=i,t.stringKind=a,t.isStackMachine=l,t.isAVR=u,t.isThumb=c,t.sizeOfBitSize=y,t.isBitSizeSigned=k,t.setCellProps=function(r){if(r._isRef=f(r.def),r._isLocal=L(r.def)||C(r.def),r._isGlobal=N(r.def),!d(r.def)){var n=Z(r.def);n.flags&e.TypeFlags.Void&&t.oops("void-typed variable, "+r.toString()),r.bitSize=v(r.def),0!=r.bitSize?r._debugType=(k(r.bitSize)?"int":"uint")+8*y(r.bitSize):n.flags&e.TypeFlags.String?r._debugType="string":n.flags&e.TypeFlags.NumberLike&&(r._debugType="number")}r.isLocal()&&0!=r.bitSize&&(r.bitSize=0,s(9256,ve("bit sizes are not supported for locals and parameters")))};var ge,be,ve=t.assembler.lf,ye=0,ke=0,xe=[];t.getComments=A,t.parseCommentsOnSymbol=$,t.parseComments=F,t.getName=P;var Se=[],Te={};t.getDeclName=ie,t.getFunctionLabel=ce,t.compileBinary=function(r,o,d,v){function k(){Dr.reset(),Pr=null,v.breakpoints=[{id:0,isDebuggerStmt:!1,fileName:"bogus",start:0,length:0,line:0,column:0}]}function E(r,n,i,a,s,o){Er.add(e.createDiagnosticForNode(r,{code:n,message:i,key:i.replace(/^[a-zA-Z]+/g,"_"),category:t.DiagnosticCategory.Error},a,s,o))}function L(t,r,n){if(void 0===n&&(n=9202),r)return s(n,r);t||s(n,ve("Sorry, this language feature is not supported"));var i=a(t),o=!1,l=null;switch(t.kind){case e.SyntaxKind.ForInStatement:i=ve("for in loops");break;case e.SyntaxKind.ForOfStatement:i=ve("for of loops"),o=!0;break;case e.SyntaxKind.PropertyAccessExpression:i=ve("property access");break;case e.SyntaxKind.DeleteExpression:i=ve("delete");break;case e.SyntaxKind.GetAccessor:i=ve("get accessor method"),o=!0;break;case e.SyntaxKind.SetAccessor:i=ve("set accessor method"),o=!0;break;case e.SyntaxKind.TaggedTemplateExpression:i=ve("tagged templates");break;case e.SyntaxKind.TypeOfExpression:i=ve("typeof");break;case e.SyntaxKind.SpreadElementExpression:i=ve("spread");break;case e.SyntaxKind.TryStatement:case e.SyntaxKind.CatchClause:case e.SyntaxKind.FinallyKeyword:case e.SyntaxKind.ThrowStatement:i=ve("throwing and catching exceptions");break;case e.SyntaxKind.ClassExpression:i=ve("class expressions"),l=ve("declare a class as class C {} not let C = class {}")}var u="";return u=o?ve("{0} not currently supported",i):ve("{0} not supported",i),l&&(u+=" - "+l),s(n,u)}function C(e){return i(e)+""}function A(e){var t=C(e),r=Nr[t];return r||(Nr[t]=r={decl:e,capturedVars:[]}),r}function D(e){var t=i(e)+"",r=Kr[t];return r||(Kr[t]=r={}),r}function B(e,t){void 0===t&&(t=!1);var r=D(e);t&&(r.written=!0);var n=K(e);if(null==n||n==Pr.action);else{for(var i=Pr.action;i&&i!=n;){var a=A(i);a.capturedVars.indexOf(e)<0&&a.capturedVars.push(e),i=K(i)}r.captured=!0}}function q(e){var t=Pr,r=xe.slice();try{e()}finally{Pr=t,xe=r}}function j(e){var r=t.U.lookup(Cr,e);if(null!=r)return r;for(var n=0,i=Dr.usedClassInfos;n<i.length;n++)for(var a=i[n],s=0,o=a.methods;s<o.length;s++){var l=o[s];P(l)==e&&qe(l,a.bindings)}return r=Cr[e]=Ur++}function J(t){t||s(9203,ve("variable has unknown type")),Z(t).flags&e.TypeFlags.Void&&s(9203,ve("void-typed variables not supported"))}function G(e){if(N(e)){je(e),J(e);var r=Dr.globals.filter(function(t){return t.def==e})[0];return r||(r=new t.ir.Cell(null,e,D(e)),Dr.globals.push(r)),r}var n=Pr.localIndex(e);return n||(Dr.finalPass?s(9204,ve("cannot locate identifer")):n=Pr.mkLocal(e,D(e))),n}function H(e){if(e.heritageClauses)for(var r=0,n=e.heritageClauses;r<n.length;r++){var i=n[r];switch(i.token){case t.SK.ExtendsKeyword:if(!i.types||1!=i.types.length)throw s(9228,ve("invalid extends clause"));var a=Z(i.types[0]);if(a&&O(a))return X(ge.getTypeAtLocation(e),a),ee(a);throw s(9228,ve("cannot inherit from this type"));case t.SK.ImplementsKeyword:break;default:throw s(9228,ve("invalid heritage clause"))}}return null}function W(e){if(t.assert(e.isUsed,"inf.isUsed"),e.vtable)return e.vtable;var r=e.baseClassInfo?W(e.baseClassInfo).slice(0):[];return q(function(){t.U.pushRange(xe,e.bindings);for(var n=0,i=e.methods;n<i.length;n++){var a=A(b=i[n]);if(a.virtualParent){for(var s=I(b),o=!1,l=Qe(b,e.bindings),u=0;u<r.length;++u)I(r[u].action)==s&&(r[u]=l,a.virtualIndex=u,o=!0);o||(a.virtualIndex=r.length,r.push(l))}}e.vtable=r,e.itable=[],e.itableInfo=[];for(var c=function(r,n){var i=j(r);e.itable[i]=n,e.itableInfo[i]=r,t.assert(!!n,"!!proc")},p=function(r,n){var i=Qe(r,e.bindings);i||q(function(){dt(r,e.bindings),(i=Qe(r,e.bindings)).body=[],n(i)}),t.assert(!!i,"!!proc"),c(P(r),i)},d=0,f=e.allfields;d<f.length;d++)!function(r){var n=f[d],i=P(n),a="set/"+i;if(rt(i)){n.irGetter||(n.irGetter=pe(e,i));var s=St(e,n,Z(n));p(n.irGetter,function(e){Dt(t.ir.op(fe.FieldAccess,[e.args[0].loadCore()],s))})}if(rt(a)){n.irSetter||(n.irSetter=pe(e,a),n.irSetter.parameters.unshift({kind:t.SK.Parameter,name:{text:"v"},parent:n.irSetter,typeOverride:Z(n)}));var o=St(e,n,Z(n));p(n.irSetter,function(e){var r=t.ir.op(fe.FieldAccess,[e.args[0].loadCore()],o);e.emitExpr(t.ir.op(fe.Store,[r,e.args[1].loadCore()]))})}}();for(var m=e;m;m=m.baseClassInfo)for(var h=0,g=m.methods;h<g.length;h++){var b=g[h],v=P(b);if(rt(v)){var y=j(v);e.itable[y]||c(v,Qe(b,m.bindings))}}for(u=0;u<e.itable.length;++u)e.itable[u]||(e.itable[u]=null);for(var k=0,x=Object.keys(Cr);k<x.length;k++){var S=x[k];e.itableInfo[Cr[S]]=S}}),e.vtable}function Q(e){for(var r={},n=e.baseClassInfo;n;n=n.baseClassInfo)for(var i=0,a=n.methods;i<a.length;i++)r[I(l=a[i])]=l;for(var s=0,o=e.methods;s<o.length;s++){var l=o[s],u=t.U.lookup(r,I(l));if(u){var c=A(l),p=A(u);u.parameters.length!=l.parameters.length&&E(l,9255,ve("the overriding method is currently required to have the same number of arguments as the base one")),c.virtualParent=p,p.virtualParent||(p.virtualParent=p),t.assert(p.virtualParent==p,"pinf.virtualParent == pinf"),p.virtualInstances||(p.virtualInstances=[]),p.virtualInstances.push(c)}}}function ee(e,r,n){void 0===r&&(r=null),void 0===n&&(n=null),r||(r=e.symbol.valueDeclaration),n||(n=e?ae(e):r.typeParameters?r.typeParameters.map(function(e){return{isRef:!0,tp:ge.getTypeAtLocation(e),arg:ge.getTypeAtLocation(e)}}):[]);var a="C"+i(r)+ue(n),s=Ir[a];if(!s){var o=[],l=[];(s={id:a,numRefFields:0,allfields:[],attrs:F(r),decl:r,refmask:null,baseClassInfo:null,methods:[],bindings:n}).attrs.autoCreate&&(Ar[s.attrs.autoCreate]=!0),Ir[a]=s,s.baseClassInfo=H(r),q(function(){t.U.pushRange(xe,n);for(var e=0,i=r.members;e<i.length;e++){var a=i[e];if(a.kind==t.SK.PropertyDeclaration){var u=a;p(Z(u))?o.push(u):l.push(u),s.allfields.push(u)}else w(a)&&a.kind!=t.SK.Constructor&&(A(a).parentClassInfo=s,s.methods.push(a))}s.baseClassInfo?(s.allfields=s.baseClassInfo.allfields.concat(s.allfields),s.numRefFields=-1,Q(s)):(s.allfields=o.concat(l),s.numRefFields=o.length),s.refmask=s.allfields.map(function(e){return p(Z(e))})})}return s}function de(e){e||(e="0 0 0 0 0\n0 0 0 0 0\n0 0 0 0 0\n0 0 0 0 0\n0 0 0 0 0\n");var r=0,n=0,i=0,a="";e+="\n";for(var o=0;o<e.length;++o)switch(e[o]){case".":case"_":case"0":a+="0,",r++;break;case"#":case"*":case"1":a+="1,",r++;break;case"\t":case"\r":case" ":break;case"\n":r&&(0==n?n=r:r!=n&&s(9205,ve("lines in image literal have to have the same width (got {0} and then {1} pixels)",n,r)),r=0,i++);break;default:s(9206,ve("Only 0 . _ (off) and 1 # * (on) are allowed in image literals"))}var l="_img"+Dr.lblNo++;a.length%4!=0&&(a+="42"),Dr.otherLiterals.push("\n.balign 4\n"+l+": .short 0xffff\n        .short "+n+", "+i+"\n        .byte "+a+"\n");var u="new pxsim.Image("+n+", ["+a+"])";return{kind:t.SK.NumericLiteral,imageLiteral:l,jsLit:u}}function Se(r){if(N(r)&&r.parent.flags&e.NodeFlags.Const){var n=r.initializer;return!!n&&n.kind!=t.SK.ArrayLiteralExpression&&!Ie(n)}return!1}function Ie(e){if(!e)return!1;if(x(e))return!1;switch(e.kind){case t.SK.NullKeyword:case t.SK.NumericLiteral:case t.SK.TrueKeyword:case t.SK.FalseKeyword:return!1;case t.SK.Identifier:return!Se(ze(e));case t.SK.PropertyAccessExpression:var r=ze(e);return!r||r.kind!=t.SK.EnumMember;case t.SK.ArrayLiteralExpression:return e.elements.some(Ie);default:return!0}}function we(e){if(N(e)){if(F(e).shim)return Ge(e,e,[]);if(Se(e))return yr(e.initializer)}var t=G(e);return B(e),t.load()}function _e(e){F(e).shim&&s(9207,ve("built-in functions cannot be yet used as values; did you forget ()?")),te(e)&&s(9232,ve("generic functions cannot be yet used as values; did you forget ()?"));var r=A(e);return r.location?r.location.load():(t.assert(!Dr.finalPass||0==r.capturedVars.length,"!bin.finalPass || info.capturedVars.length == 0"),pt(e))}function Ke(e){var r=ze(e);if(!r||r.kind!=t.SK.VariableDeclaration&&r.kind!=t.SK.Parameter&&r.kind!==t.SK.BindingElement){if(r&&r.kind==t.SK.FunctionDeclaration)return _e(r);if("undefined"==e.text)return $t(void 0);throw L(e,ve("Unknown or undeclared identifier"),9235)}return we(r)}function Ne(e){mt(e)}function Le(e){var r=_(e);r||s(9208,ve("'this' used outside of a method"));var n=A(r);return n.thisParameter||t.oops("no this"),we(n.thisParameter)}function Ce(e){if(""==e)return t.ir.rtcall("String_::mkEmpty",[]);var r=Dr.emitString(e);return t.ir.ptrlit(r+"meta",JSON.stringify(e),!0)}function Ue(e){if(e.kind==t.SK.NumericLiteral){if(e.imageLiteral)return t.ir.ptrlit(e.imageLiteral,e.jsLit);var r=parseFloat(e.text);return d.target.floatingPoint||(Math.floor(r)!==r?s(9257,ve("Decimal numbers are not supported")):r<<0!==r&&s(9258,ve("Number is either too big or too small"))),$t(r)}if(x(e))return Ce(e.text);throw t.oops()}function Ae(e){for(var r=function(e,r){return S(r)?e:t.ir.rtcallMask("String_::concat",3,t.ir.CallingConvention.Plain,[e,jt(r)])},n=jt(e.head),i=0,a=e.templateSpans;i<a.length;i++){var s=a[i];n=r(n=r(n,s.expression),s.literal)}return n}function $e(r){var n=V(Z(r)),i=p(n),a=0;n.flags&e.TypeFlags.String?a=3:i&&(a=1);for(var s=t.ir.shared(t.ir.rtcall("Array_::mk",d.target.floatingPoint?[]:[t.ir.numlit(a)])),o=0,l=r.elements;o<l.length;o++){var u=l[o],c=t.ir.shared(yr(u));Pr.emitExpr(t.ir.rtcall("Array_::push",[s,c])),i&&Pr.emitExpr(t.ir.op(fe.Decr,[c]))}return s}function Fe(e){var r=t.ir.shared(t.ir.rtcall("pxtrt::mkMap",[]));return e.properties.forEach(function(e){e.kind==t.SK.ShorthandPropertyAssignment&&s(9264,"Shorthand properties not supported.");var n="";Ve(e.initializer)&&(n="Ref"),Pr.emitExpr(t.ir.rtcall("pxtrt::mapSet"+n,[t.ir.op(fe.Incr,[r]),t.ir.numlit(j(e.name.getText())),yr(e.initializer)]))}),r}function Pe(e){T(e)?cr(e):e.initializer&&s(9209,ve("class field initializers not supported"))}function De(e){var r=ze(e);if((!r||r.kind==t.SK.PropertyDeclaration&&!T(r)||r.kind==t.SK.PropertySignature||r.kind==t.SK.PropertyAssignment)&&(yr(e.expression,!1),!r))return t.ir.numlit(0);if(r.kind==t.SK.GetAccessor)return Ye(e,e,[],null);var n=F(r),i={decl:r,qName:t.getFullName(ge,r.symbol),attrs:n,args:[],isExpression:!0};if(e.callInfo=i,r.kind==t.SK.EnumMember){var o=n.enumval;if(!o){var l=ge.getConstantValue(r);if(null==l){if(r.initializer)return yr(r.initializer);s(9210,ve("Cannot compute enum value"))}o=l+""}return/^[+-]?\d+$/.test(o)?$t(parseInt(o)):/^0x[A-Fa-f\d]{2,8}$/.test(o)?$t(parseInt(o,16)):(t.U.userError("enumval only support number literals"),t.ir.rtcall(o,[]))}if(r.kind==t.SK.PropertySignature||r.kind==t.SK.PropertyAssignment)return Ye(e,e,[],null,r,e.expression);if(r.kind==t.SK.PropertyDeclaration){if(T(r))return we(r);var u=Tt(e);return i.args.push(e.expression),t.ir.op(fe.FieldAccess,[yr(e.expression)],u)}if(w(r)||r.kind==t.SK.MethodSignature)throw s(9211,ve("cannot use method as lambda; did you forget '()' ?"));if(r.kind==t.SK.FunctionDeclaration)return _e(r);if(r.kind==t.SK.VariableDeclaration)return we(r);throw L(e,ve("Unknown property access for {0}",a(r)),9237)}function Re(r,n){void 0===n&&(n=null);var i=Z(r.expression),a={callingConvention:t.ir.CallingConvention.Plain,paramDefl:{}},s=null;if(!n&&i.flags&e.TypeFlags.String?s="String_::charAt":R(i)?s=n?"Array_::setAt":"Array_::getAt":M(i)&&(a=$(i.symbol),s=n?a.indexerSet:a.indexerGet),s){if(Ft(r.argumentExpression))return Pt(s,[r.expression,r.argumentExpression],a,n?[n]:[]);throw L(r,ve("non-numeric indexer on {0}",s),9238)}throw L(r,ve("unsupported indexer"),9239)}function Me(e){return!(!N(e)||Ie(e.initializer)&&!F(e).whenUsed)}function Oe(r){var n=Me(r)||U(r);return!(d.testMode&&n&&!t.U.startsWith(e.getSourceFileOfNode(r).fileName,"pxt_modules"))&&n}function Be(e){return!Oe(e)||wr.hasOwnProperty(C(e))}function qe(e,r){if(A(e).isUsed=!0,r&&r.length){var n=A(e);n.usages||(wr[C(e)]=e,n.usages=[],n.prePassUsagesEmitted=0,d.computeUsedSymbols&&e&&e.symbol&&(v.usedSymbols[t.getFullName(ge,e.symbol)]=null));var i=ue(r);n.usages.some(function(e){return ue(e)==i})||(n.usages.push(r),_r.push(e))}else je(e)}function je(e){d.computeUsedSymbols&&e&&e.symbol&&(v.usedSymbols[t.getFullName(ge,e.symbol)]=null),e&&!Be(e)&&(wr[C(e)]=e,_r.push(e))}function ze(t){if(!t)return null;var r,n=ge.getSymbolAtLocation(t);if(n&&!(r=n.valueDeclaration)&&n.declarations){var i=n.declarations[0];i&&i.kind==e.SyntaxKind.ImportEqualsDeclaration&&(n=ge.getSymbolAtLocation(i.moduleReference))&&(r=n.valueDeclaration)}return je(r),r}function Ve(e){return e.kind==t.SK.NullKeyword||e.kind==t.SK.NumericLiteral?!!e.isRefOverride:!(!u()&&x(e))&&p(Z(e))}function Je(e){t.assert(e.length<=8,"args.length <= 8");var r=0;return e.forEach(function(e,t){Ve(e)&&(r|=1<<t)}),r}function Ge(r,n,i){var a=F(r),s=!(Z(n).flags&e.TypeFlags.Void),o=a.shim;if(d.target.needsUnboxing)switch(o){case"Number_::toString":case"Boolean_::toString":o="numops::toString"}if(o.indexOf("(")>=0){var l=/(.*)\((.*)\)$/.exec(o);if(l){i.length&&t.U.userError("no arguments expected");var u=[];if(l[2].replace(/\s/g,"")){for(var c=0,p=l[2].split(/,/);c<p.length;c++){var f=p[c],m=parseInt(f);isNaN(m)&&(null==(m=Ut(n,f))&&(m=Lt(n,f)),null==m&&t.U.userError("invalid argument: "+f+" in "+o)),u.push(t.ir.numlit(m))}u.length>4&&t.U.userError("too many args")}return o=l[1],d.target.isNative&&t.hex.validateShim(ie(r),o,a,!0,u.map(function(e){return!0})),t.ir.rtcallMask(o,0,a.callingConvention,u)}}return"TD_NOOP"==o?(t.assert(!s,"!hasRet"),$t(void 0)):"TD_ID"==o?(t.assert(1==i.length,"args.length == 1"),yr(i[0])):(d.target.isNative&&t.hex.validateShim(ie(r),o,a,s,i.map(Ft)),Pt(o,i,a))}function He(e){switch(e.kind){case t.SK.NullKeyword:case t.SK.TrueKeyword:case t.SK.FalseKeyword:case t.SK.NumericLiteral:return!0;case t.SK.PropertyAccessExpression:return yr(e).exprKind==fe.NumberLiteral;default:return!1}}function Ze(r,n,i){if(r){var o=r.getParameters(),l=n.length;o.length>n.length&&o.slice(n.length).forEach(function(r){if(r.valueDeclaration&&r.valueDeclaration.kind==t.SK.Parameter){var a=r.valueDeclaration;if(a.initializer)He(a.initializer)||s(9212,ve("only numbers, null, true and false supported as default arguments")),n.push(a.initializer);else{var o=i.paramDefl[P(a)],l=o?$t(parseInt(o)):null;null==l&&(l=$t(Z(a).flags&e.TypeFlags.NumberLike?0:void 0)),n.push(yt(l))}}else s(9213,ve("unsupported default argument (shouldn't happen)"))});for(var u=0;u<l;u++){var c=o[u];c&&c.valueDeclaration&&c.valueDeclaration.kind==t.SK.Parameter&&X(n[u],c.valueDeclaration)}i.imageLiteral&&(x(n[0])||s(9214,ve("Only image literals (string literals) supported here; {0}",a(n[0]))),n[0]=de(n[0].text))}}function We(e){var t=ge.getResolvedSignature(e);return Ye(e,e.expression,e.arguments,t)}function Ye(r,n,i,a,o,u){function c(){return et(o,h.map(function(e){return yr(e)}),b)}void 0===o&&(o=null),void 0===u&&(u=null),o||(o=ze(n));var d=!1;if(o)switch(o.kind){case t.SK.PropertySignature:case t.SK.PropertyAssignment:case t.SK.MethodDeclaration:case t.SK.MethodSignature:case t.SK.GetAccessor:case t.SK.SetAccessor:d=!0;break;case t.SK.ModuleDeclaration:case t.SK.FunctionDeclaration:break;default:o=null}var f=F(o),m=!(Z(r).flags&e.TypeFlags.Void),h=i.slice(0),g={decl:o,qName:o?t.getFullName(ge,o.symbol):"?",attrs:f,args:h.slice(0),isExpression:m};r.callInfo=g,!d||u||T(o)||n.kind!=t.SK.PropertyAccessExpression||(u=n.expression),0==g.args.length&&t.U.lookup(Ar,g.qName)&&(g.isAutoCreate=!0);var b=nt(a),y=b.length>0;if(le(b,o),v.usedArguments&&f.trackArgs){var k=u?[u].concat(h):h,x=f.trackArgs.map(function(e){return k[e]}).map(function(e){var r=ze(e);return!r||r.kind!=t.SK.EnumMember&&r.kind!=t.SK.VariableDeclaration?"*":t.getFullName(ge,r.symbol)}).join(","),S=t.getFullName(ge,o.symbol),E=v.usedArguments[S];E||(E=v.usedArguments[S]=[]),E.indexOf(x)<0&&E.push(x)}if(q(function(){t.U.pushRange(xe,b),Ze(a,h,f)}),o&&o.kind==t.SK.FunctionDeclaration&&!(K=A(o)).location)return f.shim&&!ft(o)?Ge(o,r,h):(qe(o,b),c());if(n.kind==t.SK.SuperKeyword){var I=Pr.classInfo.baseClassInfo.ctor;t.assert(!Dr.finalPass||!!I,"!bin.finalPass || !!baseCtor");var w=h.map(function(e){return yr(e)});return w.unshift(Le(n)),Xe(I,null,w)}if(d){var _=!1;T(o)||(u?(u.kind==t.SK.SuperKeyword&&(_=!0),h.unshift(u),g.args.unshift(u),b=ae(Z(u)).concat(b)):L(r,ve("strange method call"),9241));var K=A(o);if(K.virtualParent&&(K=K.virtualParent),!K.isUsed){K.isUsed=!0;for(var N=0,C=K.virtualInstances||[];N<C.length;N++){var U=C[N];U.parentClassInfo.isUsed&&qe(U.decl,b)}}if(K.virtualParent&&!_)return t.U.assert(!Dr.finalPass||null!=K.virtualIndex,"!bin.finalPass || info.virtualIndex != null"),Xe(null,K.virtualIndex,h.map(function(e){return yr(e)}));if(f.shim&&!ft(o))return Ge(o,r,h);if(f.helper){var $=ge.getSymbolsInScope(r,e.SymbolFlags.Module).filter(function(e){return"helpers"==e.name})[0].valueDeclaration.body.statements.filter(function(e){return e.symbol.name==f.helper})[0];$||s(9215,ve("helpers.{0} not found",f.helper)),$.kind!=t.SK.FunctionDeclaration&&s(9216,ve("helpers.{0} isn't a function",f.helper)),o=$;var D=ge.getSignatureFromDeclaration(o).getTypeParameters()||[];return D.length!=b.length&&t.U.oops("helpers type parameter mismatch"),b.forEach(function(e,t){e.tp=D[t]}),qe(o,b),c()}if(o.kind==t.SK.MethodSignature){var R=P(o);return Xe(null,null,h.map(function(e){return yr(e)}),j(R))}if(o.kind!=t.SK.PropertySignature&&o.kind!=t.SK.PropertyAssignment)return qe(o,b),c();if(r==n){var M=P(o),O=Xe(null,null,h.map(function(e){return yr(e)}),j(M));if(o.kind==t.SK.PropertySignature||o.kind==t.SK.PropertyAssignment){var B=O.data;B.mapIdx=B.ifaceIndex;var z="";2==h.length?(Ve(h[1])&&(z="Ref"),B.ifaceIndex=j("set/"+M),B.mapMethod="pxtrt::mapSet"+z):(p(Z(r))&&(z="Ref"),B.mapMethod="pxtrt::mapGet"+z)}return O}h.shift(),g.args.shift()}y&&t.U.oops("invalid generic call"),o&&o.kind==t.SK.ModuleDeclaration&&("String"==P(o)?s(9219,ve('to convert X to string use: X + ""')):s(9220,ve("namespaces cannot be called directly"))),h.length>(l()?2:3)&&s(9217,ve("lambda functions with more than 3 arguments not supported"));var V=h.length+"";return h.unshift(n),g.args.unshift(n),t.ir.rtcallMask("pxt::runAction"+V,Je(h),t.ir.CallingConvention.Async,h.map(function(e){return yr(e)}))}function Xe(e,r,n,i){void 0===i&&(i=null);var a={proc:e,virtualIndex:r,ifaceIndex:i};return t.ir.op(fe.ProcCall,n,a)}function Qe(e,t){var r={action:e,bindings:t};return Dr.procs.filter(function(e){return e.matches(r)})[0]}function et(e,r,n){var i=Qe(e,n);return t.assert(!!i||!Dr.finalPass,"!!proc || !bin.finalPass"),Xe(i,null,r)}function tt(e){return e.members.filter(function(e){return e.kind==t.SK.Constructor})[0]}function rt(e){return null!=t.U.lookup(Cr,e)}function nt(e){var t=[];if(e){var r=e.target,n=e.typeParameters||(r?r.typeParameters:null)||[];t=se(n,n.map(function(t){return e.mapper(t)}))}return t}function it(e){if(!e.isUsed){e.isUsed=!0,e.baseClassInfo&&it(e.baseClassInfo),Dr.usedClassInfos.push(e);for(var t=0,r=e.methods;t<r.length;t++){var n=r[t],i=A(n);(rt(P(n))||i.virtualParent&&i.virtualParent.isUsed)&&qe(n,e.bindings)}var a=tt(e.decl);a&&qe(a,e.bindings)}}function at(e){var r=Z(e);if(R(r))throw t.oops();if(z(r)){var n=ze(e.expression);n.kind!=t.SK.ClassDeclaration&&s(9221,ve("new expression only supported on class types"));for(var i=void 0,a=ee(Z(e),n),o=a;o&&!(i=tt(o.decl));o=o.baseClassInfo);it(a);var l=a.id+"_VT",u=t.ir.rtcall("pxt::mkClassInstance",[t.ir.ptrlit(l,l)]);if(u=t.ir.shared(u),i){je(i);var c=e.arguments.slice(0),p=F(i),d=nt(ge.getResolvedSignature(e));Ze(ge.getResolvedSignature(e),c,p);var f=c.map(function(e){return yr(e)});return p.shim?(t.U.userError("shim=... on constructor not supported right now"),t.ir.rtcall(p.shim,f)):(f.unshift(t.ir.op(fe.Incr,[u])),Pr.emitExpr(et(i,f,d)),u)}return e.arguments&&e.arguments.length&&s(9222,ve("constructor with arguments not found")),u}throw L(e,ve("unknown type for new"),9243)}function st(e){function r(e){return/^[0-9a-f]$/i.test(e)}var n=ze(e.tag);if(!n)throw L(e,ve("invalid tagged template"),9265);var i=F(n);switch(i.shim){case"@hex":if(e.template.kind!=t.SK.NoSubstitutionTemplateLiteral)throw L(e,ve("substitution not supported in hex literal",i.shim),9265);return function(n){""==n&&Fr&&(Fr.dataEncoding&&"base64"!=Fr.dataEncoding?"hex"==Fr.dataEncoding?n=Fr.data:s(9271,ve("invalid jres encoding '{0}' on '{1}'",Fr.dataEncoding,Fr.id)):n=t.U.toHex(t.U.stringToUint8Array(atob(Fr.data))));for(var i="",a=0;a<n.length;++a){var o=n[a];if(!r(o)){if(/^[\s\.]$/.test(o))continue;throw L(e,ve("invalid character in hex literal '{0}'",o),9265)}r(n[a+1])&&(i+=o+n[a+1],a++)}var l=Dr.emitHexLiteral(i.toLowerCase());return t.ir.ptrlit(l,l,!0)}(e.template.text);default:throw L(e,ve("invalid shim '{0}' on tagged template",i.shim),9265)}}function ot(e){return X(e.expression,e),yr(e.expression)}function lt(e){return X(e.expression,e),yr(e.expression)}function ut(e){return yr(e.expression)}function ct(e){var r=e.parameters.slice(0);if(!T(e)&&w(e)){var n=A(e);n.thisParameter||(n.thisParameter={kind:t.SK.Parameter,name:{text:"this"},isThisParameter:!0,parent:e}),r.unshift(n.thisParameter)}return r}function pt(e,r){void 0===r&&(r=!1);var n=ce(e,oe(e)),i=n;t.target.nativeType==t.NATIVE_TYPE_CS&&(i="(FnPtr)"+i,r||(i="PXT.pxt.mkAction(0, 0, "+i+")"));var a=t.ir.ptrlit(n+"_Lit",i,!u()&&!r);return!r&&u()&&(a=t.ir.shared(t.ir.rtcall("pxt::mkAction",[t.ir.numlit(0),t.ir.numlit(0),a]))),a}function dt(e,r){var n=A(e),i=null,a=e.kind==t.SK.ArrowFunction||e.kind==t.SK.FunctionExpression,o=function(e){if(f(e))return!0;var t=D(e);return t.captured&&t.written},u=n.capturedVars.filter(function(e){return o(e)}),c=n.capturedVars.filter(function(e){return!o(e)}),p=u.concat(c),d=p.map(function(e,r){var n=new t.ir.Cell(r,e,D(e));return n.iscap=!0,n});a&&te(e)&&s(9233,ve("function expressions cannot be generic")),p.length>0&&te(e)&&s(9234,ve("nested functions cannot be generic yet")),p.length>0?(t.assert(null!=K(e),"getEnclosingFunction(node) != null)"),i=t.ir.shared(t.ir.rtcall("pxt::mkAction",[t.ir.numlit(u.length),t.ir.numlit(p.length),pt(e,!0)])),p.forEach(function(e,r){var n=Pr.localIndex(e);n||s(9223,ve("cannot find captured value: {0}",ge.symbolToString(e.symbol)));var a=n.loadCore();(n.isRef()||n.isByRefLocal())&&(a=t.ir.op(fe.Incr,[a])),Pr.emitExpr(t.ir.rtcall("pxtrt::stclo",[i,t.ir.numlit(r),a]))}),e.kind==t.SK.FunctionDeclaration&&(n.location=Pr.mkLocal(e,D(e)),Pr.emitExpr(n.location.storeDirect(i)),i=null)):a&&(i=pt(e)),t.assert(!!i==a,"!!lit == isExpression");var m={action:e,bindings:r},h=Dr.procs.filter(function(e){return e.matches(m)})[0];if(h?(Pr=h).reset():(t.assert(!Dr.finalPass,"!bin.finalPass"),(Pr=new t.ir.Procedure).isRoot=!!e.isRootFunction,Pr.action=e,Pr.info=n,Pr.bindings=r,Dr.addProc(Pr)),Pr.captured=d,e.parent.kind==t.SK.ClassDeclaration){var g=e.parent,b=g.typeParameters?g.typeParameters.length:0;t.assert(r.length>=b,"bindings.length >= numTP");var v=ee(null,g,r.slice(0,b));Pr.classInfo?t.assert(Pr.classInfo==v,"proc.classInfo == classInfo"):Pr.classInfo=v,e.kind==t.SK.Constructor&&(v.ctor?t.assert(v.ctor==Pr,"classInfo.ctor == proc"):v.ctor=Pr)}t.U.pushRange(xe,r);var y=[];Pr.args=ct(e).map(function(e,r){e.name.kind===t.SK.ObjectBindingPattern&&y.push(e);var n=new t.ir.Cell(r,e,D(e));return n.isarg=!0,n}),Pr.args.forEach(function(e){if(e.isByRefLocal()){var r=t.ir.shared(t.ir.rtcall("pxtrt::mkloc"+e.refSuffix(),[]));Pr.emitExpr(t.ir.rtcall("pxtrt::stloc"+e.refSuffix(),[r,e.loadCore()])),Pr.emitExpr(e.storeDirect(r))}}),y.forEach(function(e){return cr(e)}),e.body.kind==t.SK.Block?xr(e.body):(S=yr(e.body),Pr.emitJmp(Yt(e).ret,S,t.ir.JmpMode.Always)),Pr.emitLblDirect(Yt(e).ret),Pr.stackEmpty();var k=Pr.mkLabel("final"),x=ne(Pr.action);if(x){var S=t.ir.shared(t.ir.op(fe.JmpValue,[]));Pr.emitExpr(S),Pr.emitClrs(k,S),Pr.emitJmp(k,S,t.ir.JmpMode.Always)}else Pr.emitClrs(k,null);for((x||l())&&Pr.emitLbl(k),t.assert(!Dr.finalPass||0==_r.length,"!bin.finalPass || usedWorkList.length == 0");_r.length>0;)xr(_r.pop());return i}function ft(e){if(d.target.isNative)return!1;var r=e;return r.body&&(r.body.kind!=t.SK.Block||r.body.statements.length>0)}function mt(r){if(Be(r)){var n=F(r);if(null!=n.shim){if("@"==n.shim[0])return;if(d.target.isNative&&t.hex.validateShim(ie(r),n.shim,n,ne(r),ct(r).map(function(t){return!!(Z(t).flags&e.TypeFlags.NumberLike)})),!ft(r))return}if(!(r.flags&e.NodeFlags.Ambient)&&r.body){var i=A(r),a=null;if(te(r)){i.usages||(t.assert(d.testMode&&!wr[C(r)]&&!Dr.finalPass,"opts.testMode && !usedDecls[nodeKey(node)] && !bin.finalPass"),le(u=re(r).map(function(e){return{arg:ge.getTypeAtLocation(e),tp:ge.getTypeAtLocation(e),isRef:!0}}),r),t.U.assert(u.length>0,"bindings.length > 0"),i.usages=[u]),t.U.assert(i.usages.length>0,"no generic usages recorded");var s=i.usages;Dr.finalPass||(s=i.usages.slice(i.prePassUsagesEmitted),i.prePassUsagesEmitted=i.usages.length);for(var o=0,l=s;o<l.length;o++){var u=l[o];!function(e){q(function(){var n=dt(r,e);t.U.assert(null==n,"nolit == null")})}(u)}}else q(function(){a=dt(r,oe(r))});return a}}}function ht(r){var n=Z(r.operand);if(r.operator==t.SK.ExclamationToken)return h(t.ir.rtcall("Boolean_::bang",[Zt(r.operand)]));if(n.flags&e.TypeFlags.Number)switch(r.operator){case t.SK.PlusPlusToken:return kt(r.operand,"numops::adds",!1);case t.SK.MinusMinusToken:return kt(r.operand,"numops::subs",!1);case t.SK.MinusToken:var i=yr(r.operand),a=At(i);return null!=a?$t(-a):Kt("numops::subs",$t(0),i);case t.SK.PlusToken:return yr(r.operand)}throw L(r,ve("unsupported prefix unary operation"),9245)}function gt(){}function bt(e){var t=e;t.needsIRCache=!0,Lr.push(t)}function vt(e,r){void 0===r&&(r=null);var n=Lr.length;return e.kind!=t.SK.PropertyAccessExpression&&e.kind!=t.SK.ElementAccessExpression||bt(e.expression),r&&bt(r),Lr.length==n?gt:function(){for(var e=n;e<Lr.length;++e)Lr[e].cachedIR=null,Lr[e].needsIRCache=!1;Lr.splice(n,Lr.length-n)}}function yt(e,r){return void 0===r&&(r=!1),{kind:t.SK.NullKeyword,isRefOverride:r,valueOverride:e}}function kt(e,r,n,i){void 0===i&&(i=null);var a=vt(e),s=i?yr(i):$t(1),o=t.ir.shared(yr(e)),l=t.ir.shared(Kt(r,o,s));It(e,yt(l,d.target.taggedInts)),a();var u=n?o:l;return d.target.taggedInts?t.ir.op(fe.Incr,[u]):u}function xt(r){if(Z(r.operand).flags&e.TypeFlags.Number)switch(r.operator){case t.SK.PlusPlusToken:return kt(r.operand,"numops::adds",!0);case t.SK.MinusMinusToken:return kt(r.operand,"numops::subs",!0)}throw L(r,ve("unsupported postfix unary operation"),9246)}function St(e,t,r){var n=F(t);return{idx:e.allfields.indexOf(t),name:P(t),isRef:p(r),shimName:n.shim}}function Tt(e){var t=Z(e.expression);if(z(t)){var r=ee(t);return St(r,Et(r,e.name.text),Z(e))}throw L(e,ve("bad field access"),9247)}function Et(e,t){var r=e.allfields.filter(function(e){return e.name.text==t})[0];return r||s(9224,ve("field {0} not found",t)),r}function It(r,n,i){void 0===i&&(i=!1),i&&X(n,r);var a=ze(r),s=N(a);if(r.kind==t.SK.Identifier||s)if(a&&(s||a.kind==t.SK.VariableDeclaration||a.kind==t.SK.Parameter)){var o=G(a);B(a,!0),Pr.emitExpr(o.storeByRef(yr(n)))}else L(r,ve("bad target identifier"),9248);else if(r.kind==t.SK.PropertyAccessExpression){var l=ze(r);l&&l.kind==t.SK.GetAccessor?((l=e.getDeclarationOfKind(l.symbol,t.SK.SetAccessor))||L(r,ve("setter not available"),9253),Pr.emitExpr(Ye(r,r,[n],null,l))):!l||l.kind!=t.SK.PropertySignature&&l.kind!=t.SK.PropertyAssignment?Pr.emitExpr(t.ir.op(fe.Store,[yr(r),yr(n)])):Pr.emitExpr(Ye(r,r,[n],null,l))}else r.kind==t.SK.ElementAccessExpression?Pr.emitExpr(Re(r,n)):L(r,ve("bad assignment target"),9249)}function wt(e){var t=vt(e.left,e.right);It(e.left,e.right,!0);var r=yr(e.right);return t(),r}function _t(e){if(!d.target.floatingPoint){if(t.U.startsWith(e,"numops::")){var r=e.slice(8);return t.U.lookup(t.thumbArithmeticInstr,r)?"thumb::"+r:"lt_bool"==r?"Number_::lt":"Number_::"+r.replace(/eqq/,"eq")}switch(e){case"pxt::eq_bool":case"pxt::eqq_bool":case"langsupp::ptreq":case"langsupp::ptreqq":return"Number_::eq";case"langsupp::ptrneq":case"langsupp::ptrneqq":return"Number_::neq"}}if(d.target.taggedInts&&c())switch(e){case"numops::adds":case"numops::subs":case"numops::eors":case"numops::ands":return"@nomask@"+e}return e}function Kt(e,r,n){return e=_t(e),t.ir.rtcallMask(e,d.target.taggedInts?3:0,t.ir.CallingConvention.Plain,[r,n])}function Nt(e){var t=At(yr(e));if(void 0===t)throw s(9267,ve("a constant number-like expression is required here"));return t}function Lt(e,t){var r=Ct(e,t,"userconfig");return null==r&&(r=Ct(e,t,"config")),r}function Ct(r,n,i){var a=ge.getSymbolsInScope(r,e.SymbolFlags.Module).filter(function(e){return e.name==i&&!!e.valueDeclaration})[0];if(!a)return null;for(var s=0,o=a.valueDeclaration.body.statements;s<o.length;s++){var l=o[s];if(l.kind==t.SK.VariableStatement)for(var u=0,c=l.declarationList.declarations;u<c.length;u++){var p=c[u];if(p.symbol.name==n)return Nt(p.initializer)}}return null}function Ut(t,r){var n=ge.getSymbolsInScope(t,e.SymbolFlags.Enum).filter(function(e){return"DAL"==e.name&&!!e.valueDeclaration})[0];if(!n)return null;var i=n.valueDeclaration.members.filter(function(e){return e.symbol.name==r})[0];return i?ge.getConstantValue(i):null}function At(e){if(e.exprKind==t.ir.EK.NumberLiteral){var r=e.data;if(d.target.taggedInts){if(r==t.taggedNull||r==t.taggedUndefined||r==t.taggedFalse)return 0;if(r==t.taggedTrue)return 1;if("number"==typeof r)return r>>1}else if("number"==typeof r)return r}}function $t(e){if(d.target.taggedInts){if(null===e)return t.ir.numlit(t.taggedNull);if(void 0===e)return t.ir.numlit(t.taggedUndefined);if(!1===e)return t.ir.numlit(t.taggedFalse);if(!0===e)return t.ir.numlit(t.taggedTrue);if("number"==typeof e){if(n(e))return t.ir.numlit(e<<1|1);var r=Dr.emitDouble(e);return t.ir.ptrlit(r,JSON.stringify(e),!0)}throw t.U.oops("bad literal: "+e)}return d.target.floatingPoint||(!1!==e&&null!==e&&void 0!==e||(e=0),!0===e&&(e=1)),t.ir.numlit(e)}function Ft(r){if(r.kind==t.SK.NullKeyword){var n=r.valueOverride;if(void 0!==n)return n.exprKind==fe.NumberLiteral?!d.target.taggedInts||!!(1&n.data):n.exprKind==fe.RuntimeCall&&"pxt::ptrOfLiteral"==n.data?n.args[0].exprKind==fe.PointerLiteral&&!isNaN(parseFloat(n.args[0].jsInfo)):n.exprKind==fe.PointerLiteral&&!isNaN(parseFloat(n.jsInfo))}return r.kind==t.SK.NumericLiteral||!!(Z(r).flags&e.TypeFlags.NumberLike)}function Pt(e,r,n,i){void 0===i&&(i=null);var a="",s=t.hex.lookupFunc(e);s&&(a=s.argsFmt),i&&(r=r.concat(i));var o=Je(r),l=r.map(function(r,n){var i=yr(r);if(!d.target.taggedInts)return i;var s=a.charAt(n+1),l=Ft(r);if(s){if("_"==s||"T"==s||"N"==s)return i;if("I"==s)return l||t.U.userError("argsFmt=...I... but argument not a number in "+e),i.exprKind==fe.NumberLiteral&&"number"==typeof i.data?t.ir.numlit(i.data>>1):(o&=~(1<<n),t.ir.rtcallMask("pxt::toInt",Je([r]),t.ir.CallingConvention.Plain,[i]));if("B"==s)return o&=~(1<<n),Zt(r,i);if("F"==s||"D"==s)return"D"==s&&t.U.oops("double arguments not yet supported"),l||t.U.userError("argsFmt=...F/D... but argument not a number in "+e),o&=~(1<<n),t.ir.rtcallMask("D"==s?"pxt::toDouble":"pxt::toFloat",Je([r]),t.ir.CallingConvention.Plain,[i]);throw t.U.oops("invalid format specifier: "+s)}throw t.U.userError("not enough args for "+e)}),u=t.ir.rtcallMask(e,o,n.callingConvention,l);return d.target.taggedInts&&("I"==a.charAt(0)?u=m(u):"B"==a.charAt(0)?u=h(u):"F"==a.charAt(0)?u=g(u):"D"==a.charAt(0)&&(t.U.oops("double returns not yet supported"),u=b(u))),u}function Dt(e){var r=Pr.mkLabel("ldjmp");Pr.emitJmp(r,e,t.ir.JmpMode.Always),Pr.emitLbl(r)}function Rt(r){var n=yr(r.left),i=Z(r.left).flags&e.TypeFlags.String,a=Pr.mkLabel("lazy");if(d.target.floatingPoint){n=t.ir.shared(n);var s=t.ir.rtcall("numops::toBool",[n]),o=Pr.mkLabel("lazySkip"),l=r.operatorToken.kind==t.SK.BarBarToken?t.ir.JmpMode.IfZero:r.operatorToken.kind==t.SK.AmpersandAmpersandToken?t.ir.JmpMode.IfNotZero:t.U.oops();Pr.emitJmp(o,s,l),Pr.emitJmp(a,n,t.ir.JmpMode.Always,n),Pr.emitLbl(o),Ve(r.left)?Pr.emitExpr(t.ir.op(fe.Decr,[n])):Pr.emitExpr(t.ir.rtcall("langsupp::ignore",[n]))}else if(r.operatorToken.kind==t.SK.BarBarToken)i&&(n=t.ir.rtcall("pxtrt::emptyToNull",[n])),Pr.emitJmp(a,n,t.ir.JmpMode.IfNotZero);else if(r.operatorToken.kind==t.SK.AmpersandAmpersandToken)if(n=t.ir.shared(n),i){var u=Pr.mkLabel("lazyStr");Pr.emitJmp(u,t.ir.rtcall("pxtrt::emptyToNull",[n]),t.ir.JmpMode.IfNotZero),Pr.emitJmp(a,n,t.ir.JmpMode.Always,n),Pr.emitLbl(u),Ve(r.left)?Pr.emitExpr(t.ir.op(fe.Decr,[n])):Pr.emitExpr(t.ir.rtcall("langsupp::ignore",[n]))}else Ve(r.left)&&Pr.emitExpr(t.ir.op(fe.Decr,[n])),Pr.emitJmpZ(a,n);else t.oops();Pr.emitJmp(a,yr(r.right),t.ir.JmpMode.Always),Pr.emitLbl(a);var c=t.ir.shared(t.ir.op(fe.JmpValue,[]));return Pr.emitExpr(c),c}function Mt(e){switch(e){case t.SK.PlusEqualsToken:return t.SK.PlusToken;case t.SK.MinusEqualsToken:return t.SK.MinusToken;case t.SK.AsteriskEqualsToken:return t.SK.AsteriskToken;case t.SK.AsteriskAsteriskEqualsToken:return t.SK.AsteriskAsteriskToken;case t.SK.SlashEqualsToken:return t.SK.SlashToken;case t.SK.PercentEqualsToken:return t.SK.PercentToken;case t.SK.LessThanLessThanEqualsToken:return t.SK.LessThanLessThanToken;case t.SK.GreaterThanGreaterThanEqualsToken:return t.SK.GreaterThanGreaterThanToken;case t.SK.GreaterThanGreaterThanGreaterThanEqualsToken:return t.SK.GreaterThanGreaterThanGreaterThanToken;case t.SK.AmpersandEqualsToken:return t.SK.AmpersandToken;case t.SK.BarEqualsToken:return t.SK.BarToken;case t.SK.CaretEqualsToken:return t.SK.CaretToken;default:return t.SK.Unknown}}function Ot(r){if(d.breakpoints){var n=e.getSourceFileOfNode(r);if(!d.justMyCode||!t.U.startsWith(n.fileName,"pxt_modules")){for(var i=r.pos;/^\s$/.exec(n.text[i]);)i++;var a=e.getLineAndCharacterOfPosition(n,i),s=e.getLineAndCharacterOfPosition(n,r.end),o={id:v.breakpoints.length,isDebuggerStmt:r.kind==t.SK.DebuggerStatement,fileName:n.fileName,start:i,length:r.end-i,line:a.line,endLine:s.line,column:a.character,endColumn:s.character};v.breakpoints.push(o);var l=t.ir.stmt(t.ir.SK.Breakpoint,null);l.breakpointInfo=o,Pr.emit(l)}}}function Bt(e){switch(e){case t.SK.PlusToken:return"numops::adds";case t.SK.MinusToken:return"numops::subs";case t.SK.SlashToken:return"numops::div";case t.SK.PercentToken:return"numops::mod";case t.SK.AsteriskToken:return"numops::muls";case t.SK.AmpersandToken:return"numops::ands";case t.SK.BarToken:return"numops::orrs";case t.SK.CaretToken:return"numops::eors";case t.SK.LessThanLessThanToken:return"numops::lsls";case t.SK.GreaterThanGreaterThanToken:return"numops::asrs";case t.SK.GreaterThanGreaterThanGreaterThanToken:return"numops::lsrs";case t.SK.LessThanEqualsToken:return"numops::le";case t.SK.LessThanToken:return"numops::lt";case t.SK.GreaterThanEqualsToken:return"numops::ge";case t.SK.GreaterThanToken:return"numops::gt";case t.SK.EqualsEqualsToken:return"numops::eq";case t.SK.EqualsEqualsEqualsToken:return"numops::eqq";case t.SK.ExclamationEqualsEqualsToken:return"numops::neqq";case t.SK.ExclamationEqualsToken:return"numops::neq";default:return null}}function qt(r){if(r.operatorToken.kind==t.SK.EqualsToken)return wt(r);var n=Z(r.left),i=Z(r.right);r.operatorToken.kind==t.SK.PlusToken&&(n.flags&e.TypeFlags.String||i.flags&e.TypeFlags.String)&&(r.exprInfo={leftType:ge.typeToString(n),rightType:ge.typeToString(i)});var a=function(e){e=_t(e);var n=[r.left,r.right];return t.ir.rtcallMask(e,Je(n),t.ir.CallingConvention.Plain,n.map(function(e){return yr(e)}))};if(r.operatorToken.kind==t.SK.CommaToken){if(er(r.left))return yr(r.right);var s=tr(r.left);return t.ir.op(fe.Sequence,[s,yr(r.right)])}switch(r.operatorToken.kind){case t.SK.BarBarToken:case t.SK.AmpersandAmpersandToken:return Rt(r)}if(n.flags&e.TypeFlags.NumberLike&&i.flags&e.TypeFlags.NumberLike){var o=Mt(r.operatorToken.kind),l=Bt(o||r.operatorToken.kind);return l||L(r.operatorToken,ve("unsupported numeric operator"),9250),o?kt(r.left,l,!1,r.right):a(l)}if(r.operatorToken.kind==t.SK.PlusToken&&(n.flags&e.TypeFlags.String||i.flags&e.TypeFlags.String))return t.ir.rtcallMask("String_::concat",3,t.ir.CallingConvention.Plain,[jt(r.left),jt(r.right)]);if(r.operatorToken.kind==t.SK.PlusEqualsToken&&n.flags&e.TypeFlags.String){var u=vt(r.left),c=t.ir.shared(t.ir.rtcallMask("String_::concat",3,t.ir.CallingConvention.Plain,[yr(r.left),jt(r.right)]));return It(r.left,yt(c)),u(),t.ir.op(fe.Incr,[c])}if(n.flags&e.TypeFlags.String&&i.flags&e.TypeFlags.String)switch(r.operatorToken.kind){case t.SK.EqualsEqualsToken:case t.SK.EqualsEqualsEqualsToken:case t.SK.ExclamationEqualsEqualsToken:case t.SK.ExclamationEqualsToken:if(d.target.needsUnboxing)break;case t.SK.LessThanEqualsToken:case t.SK.LessThanToken:case t.SK.GreaterThanEqualsToken:case t.SK.GreaterThanToken:return t.ir.rtcallMask(_t(Bt(r.operatorToken.kind)),d.target.boxDebug?1:0,t.ir.CallingConvention.Plain,[m(a("String_::compare")),$t(0)]);default:L(r.operatorToken,ve("unknown string operator"),9251)}switch(r.operatorToken.kind){case t.SK.EqualsEqualsToken:return a("langsupp::ptreq");case t.SK.EqualsEqualsEqualsToken:return a("langsupp::ptreqq");case t.SK.ExclamationEqualsEqualsToken:return a("langsupp::ptrneqq");case t.SK.ExclamationEqualsToken:return a("langsupp::ptrneq");default:throw L(r.operatorToken,ve("unknown generic operator"),9252)}}function jt(r){var n=yr(r);if(x(r))return n;var i=Z(r);if(t.target.floatingPoint&&i.flags&(e.TypeFlags.NumberLike|e.TypeFlags.Boolean))return t.ir.rtcallMask("numops::toString",1,t.ir.CallingConvention.Plain,[n]);if(i.flags&e.TypeFlags.NumberLike)return t.ir.rtcall("Number_::toString",[n]);if(i.flags&e.TypeFlags.Boolean)return t.ir.rtcall("Boolean_::toString",[n]);if(i.flags&e.TypeFlags.String)return n;var a=i.symbol?i.symbol.valueDeclaration:null;if(a&&(a.kind==t.SK.ClassDeclaration||a.kind==t.SK.InterfaceDeclaration)){var o=a.members.filter(function(e){return(e.kind==t.SK.MethodDeclaration||e.kind==t.SK.MethodSignature)&&0==e.parameters.length&&"toString"==P(e)})[0];if(o){var l=r;return Ye(l,l,[],null,o,l)}throw s(9254,ve("type {0} lacks toString() method",P(a)))}throw s(9225,ve("don't know how to convert to string"))}function zt(e){var r=Pr.mkLabel("condexprz"),n=Pr.mkLabel("condexprfin");Pr.emitJmp(r,Zt(e.condition),t.ir.JmpMode.IfZero),Pr.emitJmp(n,yr(e.whenTrue),t.ir.JmpMode.Always),Pr.emitLbl(r),Pr.emitJmp(n,yr(e.whenFalse),t.ir.JmpMode.Always),Pr.emitLbl(n);var i=t.ir.shared(t.ir.op(fe.JmpValue,[]));return Pr.emitExpr(i),i}function Vt(e){e.statements.forEach(xr)}function Jt(t){if(t.flags&e.NodeFlags.Let||t.flags&e.NodeFlags.Const)return!0;throw s(9260,ve("variable needs to be defined using 'let' instead of 'var'"))}function Gt(r){if(r.declarationList.flags&e.NodeFlags.Const)for(var n=0,i=r.declarationList.declarations;n<i.length;n++){var a=i[n],o=ie(a),l=r.parent&&r.parent.kind==t.SK.ModuleBlock?P(r.parent.parent):"?";if("config"==l||"userconfig"==l){if(!a.initializer)continue;var u=Nt(a.initializer),c=Ut(r,"CFG_"+o);if(null==c||0==c)throw s(9268,ve("can't find DAL.CFG_{0}",o));"userconfig"==l&&(o="!"+o),function(e){var r=t.U.lookup($r,e.name);if(r||(r=e,$r[e.name]=r),r.value!=e.value)throw s(9269,ve("conflicting values for config.{0}",e.name))}({name:o,key:c,value:u})}}r.flags&e.NodeFlags.Ambient||(Jt(r.declarationList),r.declarationList.declarations.forEach(xr))}function Ht(e){rr(e.expression)}function Zt(r,n){if(void 0===n&&(n=null),!n&&d.target.taggedInts&&c()&&r.kind==t.SK.BinaryExpression){var i=r,a=Z(i.left),s=Z(i.right);if(a.flags&e.TypeFlags.NumberLike&&s.flags&e.TypeFlags.NumberLike){var o=t.U.lookup(t.thumbCmpMap,Bt(i.operatorToken.kind));if(o)return t.ir.rtcall(o,[yr(i.left),yr(i.right)])}}return n||(n=yr(r)),d.target.floatingPoint?t.ir.rtcall("numops::toBoolDecr",[n]):Z(r).flags&e.TypeFlags.String?t.ir.rtcall("pxtrt::stringToBool",[n]):Ve(r)?t.ir.rtcall("pxtrt::ptrToBool",[n]):n}function Wt(e){Ot(e);var t=Pr.mkLabel("else");Pr.emitJmpZ(t,Zt(e.expression)),xr(e.thenStatement);var r=Pr.mkLabel("afterif");Pr.emitJmp(r),Pr.emitLbl(t),e.elseStatement&&xr(e.elseStatement),Pr.emitLbl(r)}function Yt(e){var t=i(e);return{fortop:".fortop."+t,cont:".cont."+t,brk:".brk."+t,ret:".ret."+t}}function Xt(e){Ot(e);var t=Yt(e);Pr.emitLblDirect(t.cont),xr(e.statement),Ot(e.expression),Pr.emitJmpZ(t.brk,Zt(e.expression)),Pr.emitJmp(t.cont),Pr.emitLblDirect(t.brk)}function Qt(e){Ot(e);var t=Yt(e);Pr.emitLblDirect(t.cont),Ot(e.expression),Pr.emitJmpZ(t.brk,Zt(e.expression)),xr(e.statement),Pr.emitJmp(t.cont),Pr.emitLblDirect(t.brk)}function er(e){if(!e)return!0;switch(e.kind){case t.SK.Identifier:case t.SK.StringLiteral:case t.SK.NumericLiteral:case t.SK.NullKeyword:return!0}return!1}function tr(r){var n=yr(r),i=Z(r);return i.flags&e.TypeFlags.Void||p(i)&&(n=t.ir.op(fe.Decr,[n])),n}function rr(e){if(!er(e)){Ot(e);var t=tr(e);Pr.emitExpr(t),Pr.stackEmpty()}}function nr(e){e.initializer&&e.initializer.kind==t.SK.VariableDeclarationList?(Jt(e.initializer),e.initializer.declarations.forEach(xr)):rr(e.initializer),Ot(e);var r=Yt(e);Pr.emitLblDirect(r.fortop),e.condition&&(Ot(e.condition),Pr.emitJmpZ(r.brk,Zt(e.condition))),xr(e.statement),Pr.emitLblDirect(r.cont),rr(e.incrementor),Pr.emitJmp(r.fortop),Pr.emitLblDirect(r.brk)}function ir(r){if(r.initializer&&r.initializer.kind==t.SK.VariableDeclarationList){var n=r.initializer;if(1==n.declarations.length){Jt(n);var i=Z(r.expression),a="",s="";if(i.flags&e.TypeFlags.String)a="String_::charAt",s="String_::length";else{if(!R(i))return void L(r.expression,"cannot use for...of with this expression");a="Array_::getAt",s="Array_::length"}je(n.declarations[0]);var o=cr(n.declarations[0]);Pr.emitExpr(o.storeByRef($t(void 0))),Pr.stackEmpty();var l=Pr.mkLocalUnnamed(!0);Pr.emitExpr(l.storeByRef(yr(r.expression)));var u=Pr.mkLocalUnnamed(!!d.target.taggedInts);Pr.emitExpr(u.storeByRef($t(0))),Pr.stackEmpty(),Ot(r);var c=Yt(r);Pr.emitLblDirect(c.fortop);var p=t.ir.rtcall(s,[l.loadCore()]),f=Kt("numops::lt_bool",u.load(),m(p));Pr.emitJmpZ(c.brk,f),Pr.emitExpr(o.storeByRef(t.ir.rtcall(a,[l.loadCore(),function(e){return d.target.needsUnboxing?t.ir.rtcall("pxt::toInt",[e]):e}(u.loadCore())]))),xr(r.statement),Pr.emitLblDirect(c.cont),Pr.emitExpr(u.storeByRef(Kt("numops::adds",u.load(),$t(1)))),Pr.emitJmp(c.fortop),Pr.emitLblDirect(c.brk),Pr.emitExpr(l.storeByRef($t(void 0)))}else L(r,"only a single variable may be used to iterate a collection")}else L(r,"only a single variable may be used to iterate a collection")}function ar(r){function n(r){return r?i&&r.kind==t.SK.LabeledStatement&&r.label.text==i?r.statement:r.kind==t.SK.SwitchStatement&&!i&&a?r:!i&&e.isIterationStatement(r,!1)?r:n(r.parent):null}Ot(r);var i=r.label?r.label.text:null,a=r.kind==t.SK.BreakStatement,s=n(r);if(s){var o=Yt(s);r.kind==t.SK.ContinueStatement?e.isIterationStatement(s,!1)?Pr.emitJmp(o.cont):E(r,9231,ve("continue on non-loop")):r.kind==t.SK.BreakStatement?Pr.emitJmp(o.brk):t.oops()}else E(r,9230,ve("cannot find outer loop"))}function sr(e){Ot(e);var r=null;e.expression?r=yr(e.expression):ne(Pr.action)&&(r=$t(void 0)),Pr.emitJmp(Yt(Pr.action).ret,r,t.ir.JmpMode.Always)}function or(r){Ot(r);var n,i=Z(r.expression),a=!!(i.flags&e.TypeFlags.NumberLike),s=Yt(r),o=a,u=t.ir.shared(yr(r.expression)),c=u;a&&Dt(u);var p=r.caseBlock.clauses.map(function(r){var a=Pr.mkLabel("switch");if(r.kind==t.SK.CaseClause){var s=r,p=yr(s.expression);if(d.target.needsUnboxing)f=t.ir.rtcallMask(_t("pxt::switch_eq"),Ve(s.expression)?1:0,t.ir.CallingConvention.Plain,[p,u]),o=!1,Pr.emitJmp(a,f,t.ir.JmpMode.IfNotZero,c);else if(i.flags&e.TypeFlags.String)f=t.ir.rtcallMask("String_::compare",Ve(s.expression)?3:2,t.ir.CallingConvention.Plain,[p,u]),u=t.ir.op(fe.Incr,[u]),Pr.emitJmp(a,f,t.ir.JmpMode.IfZero,c);else if(Ve(s.expression))f=t.ir.rtcallMask(_t("langsupp::ptreq"),3,t.ir.CallingConvention.Plain,[p,u]),o=!1,u=t.ir.op(fe.Incr,[u]),Pr.emitJmp(a,f,t.ir.JmpMode.IfNotZero,c);else if(l()||d.target.needsUnboxing||p.exprKind!=fe.NumberLiteral){var f=Kt("pxt::eq_bool",p,u);o=!1,Pr.emitJmp(a,f,t.ir.JmpMode.IfNotZero,c)}else o||(Dt(u),o=!0),Pr.emitJmp(a,p,t.ir.JmpMode.IfJmpValEq,c)}else r.kind==t.SK.DefaultClause?(t.assert(!n,"!defaultLabel"),n=a):t.oops();return a});d.target.taggedInts&&Pr.emitExpr(t.ir.op(fe.Decr,[u])),n?Pr.emitJmp(n,c):Pr.emitJmp(s.brk,c),r.caseBlock.clauses.forEach(function(e,t){Pr.emitLbl(p[t]),e.statements.forEach(xr)}),Pr.emitLblDirect(s.brk)}function lr(e){var t=Yt(e.statement);xr(e.statement),Pr.emitLblDirect(t.brk)}function ur(e){Ot(e)}function cr(e){if(e.name.kind===t.SK.ObjectBindingPattern){if(!e.initializer)return e.name.elements.forEach(function(e){return cr(e)}),null;s(9259,"Object destructuring with initializers is not supported")}if(J(e),!Be(e))return null;if(Se(e))return null;var r=N(e)?G(e):Pr.mkLocal(e,D(e));if(r.isByRefLocal()&&(Pr.emitClrIfRef(r),Pr.emitExpr(r.storeDirect(t.ir.rtcall("pxtrt::mkloc"+r.refSuffix(),[])))),e.kind===t.SK.BindingElement){Ot(e);var n=pr(e);X(n[1],e),Pr.emitExpr(r.storeByRef(n[0])),Pr.stackEmpty()}else if(e.initializer){if(Ot(e),N(e)){var i=F(e).jres;if(i){"true"==i&&(i=t.getFullName(ge,e.symbol));var a=t.U.lookup(d.jres||{},i);a?Fr=a:s(9270,ve("resource '{0}' not found in any .jres file",i))}}X(e.initializer,e),Pr.emitExpr(r.storeByRef(yr(e.initializer))),Fr=null,Pr.stackEmpty()}return r}function pr(e){var r,n,i=e.parent.parent;if(i.kind===t.SK.BindingElement){var a=pr(i);r=a[0],n=a[1]}else n=Z(i);var s=e.propertyName||e.name;if(z(n)){var o=ee(n);r=r||we(i);var l=ge.getTypeOfSymbolAtLocation(ge.getPropertyOfType(n,s.text),e);return[t.ir.op(fe.FieldAccess,[r],St(o,Et(o,s.text),l)),l]}throw L(e,ve("bad field access"),9247)}function dr(e){ee(null,e),e.members.forEach(xr)}function fr(e){Y(e,Ir);var t=F(e);t.autoCreate&&(Ar[t.autoCreate]=!0)}function mr(e){}function hr(e){xr(e.body)}function gr(e){}function br(e){e.statements.forEach(xr)}function vr(e,t){var r=be;ke++;try{be=null;var n=t(e);return be&&s(ye,be),be=r,ke--,n}catch(t){ke--,be=null,t.ksEmitterUserError||console.log(t.stack);var i=t.ksErrorCode||9200;return E(e,i,t.message),null}}function yr(e,r){void 0===r&&(r=!0);var n=e;if(r&&n.cachedIR)return Ve(e)?t.ir.op(fe.Incr,[n.cachedIR]):n.cachedIR;var i=vr(n,kr)||$t(void 0);return r&&n.needsIRCache?(n.cachedIR=t.ir.shared(i),n.cachedIR):i}function kr(e){var t=Tr(e);if(t.isExpr())return t;throw new Error("expecting expression")}function xr(e){vr(e,Sr)}function Sr(e){switch(e.kind){case t.SK.SourceFile:return br(e);case t.SK.InterfaceDeclaration:return fr(e);case t.SK.VariableStatement:return Gt(e);case t.SK.ModuleDeclaration:return hr(e);case t.SK.EnumDeclaration:return mr(e);case t.SK.FunctionDeclaration:case t.SK.Constructor:case t.SK.MethodDeclaration:return void mt(e);case t.SK.ExpressionStatement:return Ht(e);case t.SK.Block:case t.SK.ModuleBlock:return Vt(e);case t.SK.VariableDeclaration:return void cr(e);case t.SK.IfStatement:return Wt(e);case t.SK.WhileStatement:return Qt(e);case t.SK.DoStatement:return Xt(e);case t.SK.ForStatement:return nr(e);case t.SK.ForOfStatement:return ir(e);case t.SK.ContinueStatement:case t.SK.BreakStatement:return ar(e);case t.SK.LabeledStatement:return lr(e);case t.SK.ReturnStatement:return sr(e);case t.SK.ClassDeclaration:return dr(e);case t.SK.PropertyDeclaration:case t.SK.PropertyAssignment:return Pe(e);case t.SK.SwitchStatement:return or(e);case t.SK.TypeAliasDeclaration:return;case t.SK.DebuggerStatement:return ur(e);case t.SK.GetAccessor:case t.SK.SetAccessor:return Ne(e);case t.SK.ImportEqualsDeclaration:return gr(e);case t.SK.EmptyStatement:return;default:L(e)}}function Tr(e){switch(e.kind){case t.SK.NullKeyword:var r=e.valueOverride;return r||$t(null);case t.SK.TrueKeyword:return $t(!0);case t.SK.FalseKeyword:return $t(!1);case t.SK.TemplateHead:case t.SK.TemplateMiddle:case t.SK.TemplateTail:case t.SK.NumericLiteral:case t.SK.StringLiteral:case t.SK.NoSubstitutionTemplateLiteral:return Ue(e);case t.SK.TaggedTemplateExpression:return st(e);case t.SK.PropertyAccessExpression:return De(e);case t.SK.BinaryExpression:return qt(e);case t.SK.PrefixUnaryExpression:return ht(e);case t.SK.PostfixUnaryExpression:return xt(e);case t.SK.ElementAccessExpression:return Re(e);case t.SK.ParenthesizedExpression:return ut(e);case t.SK.TypeAssertionExpression:return ot(e);case t.SK.ArrayLiteralExpression:return $e(e);case t.SK.NewExpression:return at(e);case t.SK.SuperKeyword:case t.SK.ThisKeyword:return Le(e);case t.SK.CallExpression:return We(e);case t.SK.FunctionExpression:case t.SK.ArrowFunction:return mt(e);case t.SK.Identifier:return Ke(e);case t.SK.ConditionalExpression:return zt(e);case t.SK.AsExpression:return lt(e);case t.SK.TemplateExpression:return Ae(e);case t.SK.ObjectLiteralExpression:return Fe(e);default:return L(e),null}}t.target=d.target;var Er=e.createDiagnosticCollection();ge=r.getTypeChecker();var Ir={},wr={},_r=[],Kr={},Nr={},Lr=[],Cr={},Ur=0,Ar={},$r={},Fr=null;if(Te={},me=0,he++,d.target.isNative){if(!d.hexinfo)return{diagnostics:[{file:r.getSourceFiles()[0],start:0,length:0,category:t.DiagnosticCategory.Error,code:9043,messageText:ve("The hex file is not available, please connect to internet and try again.")}],emitSkipped:!0};t.hex.setupFor(d.target,d.extinfo||t.emptyExtInfo(),d.hexinfo),t.hex.setupInlineAssembly(d)}var Pr,Dr=new Ee;Dr.res=v,Dr.options=d,Dr.target=d.target,d.computeUsedSymbols&&(v.usedSymbols={},v.usedArguments={});var Rr=d.forceEmit&&v.diagnostics.length>0?[]:t.Util.concat(r.getSourceFiles().map(function(e){return e.statements})),Mr=r.getSourceFiles()[0],Or={kind:t.SK.FunctionDeclaration,parameters:[],name:{text:"<main>",pos:0,end:0},body:{kind:t.SK.Block,statements:Rr},parent:Mr,pos:0,end:0,isRootFunction:!0,isBogusFunction:!0};if(je(Or),_r=[],k(),xr(Or),function(){var e=Dr.globals.slice(0);e.forEach(function(e,t){return e.index=t}),e.sort(function(e,t){return y(e.bitSize)-y(t.bitSize)||e.index-t.index});for(var r=4*t.numReservedGlobals,n=0,i=e;n<i.length;n++){for(var a=i[n],s=y(a.bitSize);r&s-1;)r++;a.index=r,r+=s}Dr.globalsWords=r+3>>2}(),function(){for(var e in Nr)Nr[e].virtualParent=void 0,Nr[e].virtualIndex=void 0,Nr[e].virtualInstances=void 0;for(var t in Ir)Ir[t].methods=Ir[t].methods.filter(function(e){return A(e).isUsed});for(var t in Ir)Ir[t].baseClassInfo&&Q(Ir[t])}(),function(){for(var e=0,t=Dr.usedClassInfos;e<t.length;e++)W(t[e])}(),0==Er.getModificationCount()){k(),Dr.finalPass=!0,xr(Or),v.configData=[];for(var Br=0,qr=Object.keys($r);Br<qr.length;Br++){var jr=qr[Br];$r["!"+jr]||v.configData.push({name:jr.replace(/^\!/,""),key:$r[jr].key,value:$r[jr].value})}vr(Or,function(){Er.getModificationCount()||d.noEmit||!o||(Dr.writeFile=function(e,t){return o.writeFile(e,t,!1,null)},d.target.isNative?(d.extinfo.yotta&&Dr.writeFile("yotta.json",JSON.stringify(d.extinfo.yotta,null,2)),d.extinfo.platformio&&Dr.writeFile("platformio.json",JSON.stringify(d.extinfo.platformio,null,2)),d.target.nativeType==t.NATIVE_TYPE_CS?t.csEmit(Dr,d):d.target.nativeType==t.NATIVE_TYPE_AVRVM?t.vmEmit(Dr,d):t.processorEmit(Dr,d,v)):t.jsEmit(Dr))})}return{diagnostics:Er.getDiagnostics(),emitSkipped:!!d.noEmit}};var Ee=function(){function e(){this.procs=[],this.globals=[],this.finalPass=!1,this.writeFile=function(e,t){},this.usedClassInfos=[],this.sourceHash="",this.numStmts=1,this.strings={},this.hexlits={},this.doubles={},this.otherLiterals=[],this.codeHelpers={},this.lblNo=0}return e.prototype.reset=function(){this.lblNo=0,this.otherLiterals=[],this.strings={},this.hexlits={},this.doubles={}},e.prototype.addProc=function(e){t.assert(!this.finalPass,"!this.finalPass"),this.procs.push(e),e.seqNo=this.procs.length},e.prototype.emitLabelled=function(e,r,n){var i=t.U.lookup(r,e);if(null!=i)return i;var a=n+this.lblNo++;return r[e]=a,a},e.prototype.emitDouble=function(e){return this.emitLabelled(de(e),this.doubles,"_dbl")},e.prototype.emitString=function(e){return this.emitLabelled(e,this.strings,"_str")},e.prototype.emitHexLiteral=function(e){return this.emitLabelled(e,this.hexlits,"_hexlit")},e}();t.Binary=Ee}(e.pxtc||(e.pxtc={}))}(ts||(ts={}));var ts;!function(e){!function(t){function r(r){var n=e.getDefaultCompilerOptions();return n.target=t.ScriptTarget.ES5,n.module=e.ModuleKind.None,n.noImplicitAny=!0,n.noImplicitReturns=!0,n.allowUnreachableCode=!0,n}function n(r,n){void 0===n&&(n=!1),n&&(r=r.filter(function(e){return 5012!==e.code}));var i=r.filter(function(e){return 1148==e.code});return i.length>0&&(r=i),r.map(function(r){if(!r.file)return{code:r.code,start:r.start,length:r.length,line:0,column:0,messageText:r.messageText,category:r.category,fileName:"?"};var n=e.getLineAndCharacterOfPosition(r.file,r.start),i={code:r.code,start:r.start,length:r.length,line:n.line,column:n.character,messageText:r.messageText,category:r.category,fileName:r.file.fileName};return 1148==i.code&&(i.messageText=t.Util.lf("all symbols in top-level scope are always exported; please use a namespace if you want to export only some")),i})}function i(i){var s=Date.now(),o={outfiles:{},diagnostics:[],success:!1,times:{}};i.target.taggedInts&&(i.target.floatingPoint=!0),i.target.isNative||(i.target.taggedInts=!1);var l={};for(var u in i.fileSystem)l[a(u)]=i.fileSystem[u];var c=r(i),p={getSourceFile:function(t,r,n){t=a(t);var i="";return l.hasOwnProperty(t)?i=l[t]:n&&n("File not found: "+t),null==i&&(n("File not found: "+t),i=""),e.createSourceFile(t,i,r,!0)},fileExists:function(e){return e=a(e),l.hasOwnProperty(e)},getCanonicalFileName:function(e){return e},getDefaultLibFileName:function(){return"no-default-lib.d.ts"},writeFile:function(e,t,r,n){o.outfiles[e]=t},getCurrentDirectory:function(){return"."},useCaseSensitiveFileNames:function(){return!0},getNewLine:function(){return"\n"},readFile:function(e){return e=a(e),l[e]||""},directoryExists:function(e){return!0}};i.sourceFiles||(i.sourceFiles=Object.keys(i.fileSystem));var d=i.sourceFiles.filter(function(e){return t.U.endsWith(e,".ts")}),f=d.filter(function(e){return"main.ts"!=e});d.length>f.length&&(d=f).push("main.ts");var m=e.createProgram(d,c,p);if(o.diagnostics=n(m.getSyntacticDiagnostics(),i.ignoreFileResolutionErrors),o.diagnostics.length>0)return i.forceEmit&&(pxt.debug("syntactic errors, forcing emit"),t.compileBinary(m,p,i,o)),o;o.diagnostics=n(m.getOptionsDiagnostics().concat(m.getGlobalDiagnostics()),i.ignoreFileResolutionErrors),0==o.diagnostics.length&&(o.diagnostics=n(m.getSemanticDiagnostics(),i.ignoreFileResolutionErrors));var h=Date.now();if(o.times.typescript=h-s,i.ast&&(o.ast=m),i.ast||i.forceEmit||0==o.diagnostics.length){var g=t.compileBinary(m,p,i,o);o.times.compilebinary=Date.now()-h,o.diagnostics=o.diagnostics.concat(n(g.diagnostics))}0==o.diagnostics.length&&(o.success=!0);for(var b=0,v=i.sourceFiles;b<v.length;b++){var y=v[b];t.Util.startsWith(y,"built/")&&(o.outfiles[y.slice(6)]=i.fileSystem[y])}return o}function a(e){var t=[];return(e=e.replace(/\\/g,"/")).split("/").forEach(function(e){".."===e&&t.length?t.pop():"."!==e&&t.push(e)}),t.join("/")}t.getTsCompilerOptions=r,t.nodeLocationInfo=function(t){var r=e.getSourceFileOfNode(t),n=t.getStart?t.getStart():t.pos,i=e.getLineAndCharacterOfPosition(r,n),a=i.line,s=i.character,o=e.getLineAndCharacterOfPosition(r,t.end),l=o.line,u=o.character;return{start:n,length:t.end-n,line:a,column:s,endLine:l,endColumn:u,fileName:r.fileName}},t.patchUpDiagnostics=n,t.compile=i,t.decompile=function(e,r){var n=i(e);if(!n.success)return n;var a=n.ast.getSourceFile(r),s=t.getApiInfo(e,n.ast),o=t.getBlocksInfo(s);return t.decompiler.decompileToBlocks(o,a,{snippetMode:!1,alwaysEmitOnStart:e.alwaysDecompileOnStart},t.decompiler.buildRenameMap(n.ast,a))}}(e.pxtc||(e.pxtc={}))}(ts||(ts={}));var pxt;!function(e){!function(t){var r=["type","offset","vaddr","paddr","filesz","memsz","flags","align"],n=e.HF2.read32,i=e.HF2.read16,a=4096;t.parse=function(t){function s(e){for(var i={},a=e,s=0,o=r;s<o.length;s++)i[o[s]]=n(t,e),e+=4;var l=i;return l._filepos=a,l}1179403647!=n(t,0)&&e.U.userError("no magic"),1!=t[4]&&e.U.userError("not 32 bit"),1!=t[5]&&e.U.userError("not little endian"),1!=t[6]&&e.U.userError("bad version"),2!=i(t,16)&&e.U.userError("wrong object type"),40!=i(t,18)&&e.U.userError("not ARM");var o=n(t,28);n(t,32);0==o&&e.U.userError("expecting program headers");for(var l=i(t,42),u=i(t,44),c=e.U.range(u).map(function(e){return s(o+e*l)}),p=t.length+1;15&p;)p++;for(var d=0,f=0,m=c;f<m.length;f++)1==(y=m[f]).type&&(d=Math.max(d,y.vaddr+y.memsz));for(var h=(d+a-1&~(a-1))+(p&a-1),g=-1,b=0,v=c;b<v.length;b++){var y=v[b];4==y.type&&(g=y._filepos)}return{imageMemStart:h,imageFileStart:p,phOffset:g,template:t}},t.patch=function(t,n){var i=new Uint8Array(t.imageFileStart+n.length);return i.fill(0),e.U.memcpy(i,0,t.template),e.U.memcpy(i,t.imageFileStart,n),function(t,n){for(var i=n._filepos,a=0,s=r;a<s.length;a++){var o=s[a];e.HF2.write32(t,i,n[o]||0),i+=4}}(i,{_filepos:t.phOffset,type:1,offset:t.imageFileStart,vaddr:t.imageMemStart,paddr:t.imageMemStart,filesz:n.length,memsz:n.length,flags:5,align:a}),i}}(e.elf||(e.elf={}))}(pxt||(pxt={}));var ts;!function(e){!function(t){function r(e){switch(e){case T.CommaToken:return 2;case T.EqualsToken:case T.PlusEqualsToken:case T.MinusEqualsToken:case T.AsteriskEqualsToken:case T.AsteriskAsteriskEqualsToken:case T.SlashEqualsToken:case T.PercentEqualsToken:case T.LessThanLessThanEqualsToken:case T.GreaterThanGreaterThanEqualsToken:case T.GreaterThanGreaterThanGreaterThanEqualsToken:case T.AmpersandEqualsToken:case T.BarEqualsToken:case T.CaretEqualsToken:return 5;case T.QuestionToken:case T.ColonToken:return 7;case T.BarBarToken:return 10;case T.AmpersandAmpersandToken:return 20;case T.BarToken:return 30;case T.CaretToken:return 40;case T.AmpersandToken:return 50;case T.EqualsEqualsToken:case T.ExclamationEqualsToken:case T.EqualsEqualsEqualsToken:case T.ExclamationEqualsEqualsToken:return 60;case T.LessThanToken:case T.GreaterThanToken:case T.LessThanEqualsToken:case T.GreaterThanEqualsToken:case T.InstanceOfKeyword:case T.InKeyword:case T.AsKeyword:return 70;case T.LessThanLessThanToken:case T.GreaterThanGreaterThanToken:case T.GreaterThanGreaterThanGreaterThanToken:return 80;case T.PlusToken:case T.MinusToken:return 90;case T.AsteriskToken:case T.SlashToken:case T.PercentToken:return 100;case T.AsteriskAsteriskToken:return 101;case T.DotToken:return 120;default:return 0}}function n(e){switch(e){case T.EndOfFileToken:return x.EOF;case T.SingleLineCommentTrivia:return x.CommentLine;case T.MultiLineCommentTrivia:return x.CommentBlock;case T.NewLineTrivia:return x.NewLine;case T.WhitespaceTrivia:return x.Whitespace;case T.ShebangTrivia:case T.ConflictMarkerTrivia:return x.CommentBlock;case T.NumericLiteral:case T.StringLiteral:case T.RegularExpressionLiteral:case T.NoSubstitutionTemplateLiteral:case T.TemplateHead:case T.TemplateMiddle:case T.TemplateTail:return x.Literal;case T.Identifier:return x.Identifier;default:return e<T.Identifier?x.Operator:x.Keyword}}function i(t){S=t;for(var r=e.createScanner(e.ScriptTarget.Latest,!1,e.LanguageVariant.Standard,t,function(e){var t=r.getTextPos();console.log("scanner error",t,e.message)}),i=[],a=0,s=-1;;){var o=r.scan();if(o==T.CloseBraceToken&&a==s&&(s=-1,o=r.reScanTemplateToken()),E&&o==T.SlashToken||o==T.SlashEqualsToken){var l=r.reScanSlashToken();l==T.RegularExpressionLiteral&&(o=l)}o==T.GreaterThanToken&&(o=r.reScanGreaterToken());var u={kind:n(o),synKind:o,lineNo:0,pos:r.getTokenPos(),text:r.getTokenText()};if(o==T.OpenBraceToken&&a++,o==T.CloseBraceToken&&--a<0&&(a=-1e7),i.push(u),o!=T.TemplateHead&&o!=T.TemplateMiddle||(s=a),u.kind==x.EOF)break}return{tokens:i,braceBalance:a}}function a(e,t){for(;e[t]&&e[t].kind==x.Whitespace;)t++;return t}function s(e,t){for(var r=[],n=!0,i=1,s=0;s<e.length;++s){if(n){var o=s;if(s=a(e,s),e[s].kind==x.NewLine){var l=!1;t>=0&&e[s].pos>=t&&(t=-1,l=!0),r.push({text:"",kind:x.CommentLine,pos:e[s].pos,lineNo:i,synKind:T.SingleLineCommentTrivia,isCursor:l})}else s=o}r.push(e[s]),e[s].lineNo=i,e[s].kind==x.NewLine?(n=!0,i++):n=!1,t>=0&&e[s].pos>=t&&(t=-1)}return r}function o(e){var t=[];t.push({synKind:T.EndOfFileToken,token:{children:[]}});for(var r=0;r<e.length;++r){var n=e[r],i=t[t.length-1];switch(i.token.children.push(n),n.kind){case x.Operator:switch(n.synKind){case T.OpenBraceToken:case T.OpenParenToken:case T.OpenBracketToken:!function(e,r){var n=e;n.children=[],n.kind=x.Tree,t.push({synKind:r,token:n})}(n,n.synKind+1);break;case T.CloseBraceToken:case T.CloseParenToken:case T.CloseBracketToken:for(i.token.children.pop();;){if((i=t.pop()).synKind==n.synKind){i.token.endToken=n;break}if(0==t.length||i.synKind==T.CloseBraceToken){t.push(i);break}}}}}return t[0].token.children}function l(){return{kind:x.EOF,synKind:T.EndOfFileToken,pos:0,lineNo:0,text:""}}function u(e,t){return{kind:x.Whitespace,synKind:T.WhitespaceTrivia,pos:e.pos-t.length,lineNo:e.lineNo,text:t}}function c(e){return{kind:x.NewLine,synKind:T.NewLineTrivia,pos:e.pos,lineNo:e.lineNo,text:"\n"}}function p(e){return{kind:x.Block,synKind:T.OpenBraceToken,pos:e[0].pos,lineNo:e[0].lineNo,stmts:[{tokens:e}],text:"{",endToken:null}}function d(e){return{kind:x.Tree,synKind:T.WhitespaceTrivia,pos:e[0].pos,lineNo:e[0].lineNo,children:e,endToken:null,text:""}}function f(e){if(!e)return!1;switch(e.synKind){case T.IfKeyword:case T.ElseKeyword:case T.LetKeyword:case T.ConstKeyword:case T.VarKeyword:case T.DoKeyword:case T.WhileKeyword:case T.SwitchKeyword:case T.CaseKeyword:case T.DefaultKeyword:case T.ForKeyword:case T.ReturnKeyword:case T.BreakKeyword:case T.ContinueKeyword:case T.TryKeyword:case T.CatchKeyword:case T.FinallyKeyword:case T.DeleteKeyword:case T.FunctionKeyword:case T.ClassKeyword:case T.YieldKeyword:case T.DebuggerKeyword:return!0;default:return!1}}function m(e,n,i){function a(e){for(var t=[],r=0;r<e.length;)if(e[r].blockSpanLength){var n=e.slice(r,r+e[r].blockSpanLength),i=!!n[0].blockSpanIsVirtual;delete n[0].blockSpanLength,delete n[0].blockSpanIsVirtual,r+=n.length,n=a(n),i?t.push(d(n)):(t.push(u(n[0]," ")),t.push(p(b(n))))}else t.push(e[r++]);return t}function s(e){if(e.kind==x.Tree){var r=e;r.children=t.Util.concat(m(r.children,!1,r).map(function(e){return e.tokens}))}}function o(t){for(void 0===t&&(t=!1);;)switch(E++,e[E].kind){case x.Whitespace:case x.CommentBlock:case x.CommentLine:break;case x.NewLine:if(t)break;break;default:return}}function c(){for(;e[E].kind==x.Whitespace;)E++;e[E].kind==x.NewLine&&E++}function h(){for(;;)switch(E++,e[E].kind){case x.EOF:return;case x.Tree:if(e[E].synKind==T.OpenBraceToken)return E--,void v()}}function g(){t.Util.assert(e[E].synKind==T.OpenBraceToken);var r=e[E];t.Util.assert(r.kind==x.Tree);var n=e[E];n.stmts=m(r.children,!0,k),delete r.children,n.kind=x.Block,E++,I=!0}function v(){var t=E+1;o(),e[E].synKind==T.OpenBraceToken?(g(),c()):(y(),e[t].blockSpanLength=E-t)}function y(){for(;;){var a=e[E],s=E;if(k=a,I=!1,a.kind==x.EOF)return;if(n&&a.synKind==T.SemicolonToken)return E++,void c();if(a.synKind==T.EqualsGreaterThanToken){if(o(),e[E].synKind==T.OpenBraceToken){g();continue}u=E;y();for(var l=E;e[l].kind==x.NewLine;)l--;return e[u].blockSpanLength=l-u,void(e[u].blockSpanIsVirtual=!0)}if(n&&r(a.synKind)){var u=E;if(o(),!f(e[E]))continue;E=u}if(n&&a.kind==x.NewLine){if(o(),a=e[E],r(a.synKind)&&a.synKind!=T.PlusToken&&a.synKind!=T.MinusToken)continue;return void(E=s+1)}if(a.synKind==T.OpenBraceToken&&i&&i.synKind==T.ClassKeyword){for(var p=E-1;p>=0&&e[p].kind==x.Whitespace;)p--;if(p<0||e[p].synKind!=T.EqualsToken)return E--,void v()}switch(t.Util.assert(s==E),a.synKind){case T.ForKeyword:case T.WhileKeyword:case T.IfKeyword:case T.CatchKeyword:if(o(),e[E].synKind!=T.OpenParenToken)continue;return void v();case T.DoKeyword:if(v(),E--,o(),e[E].synKind==T.WhileKeyword){E++;continue}return;case T.ElseKeyword:if(o(),e[E].synKind==T.IfKeyword)continue;return E=s,void v();case T.TryKeyword:case T.FinallyKeyword:return void v();case T.ClassKeyword:case T.NamespaceKeyword:case T.ModuleKeyword:case T.InterfaceKeyword:case T.FunctionKeyword:return void h()}t.Util.assert(!I,"forgot continue/return after expectBlock"),E++}}void 0===i&&(i=null);var k,S=[],E=0,I=!1;for(e=e.concat([l()]);e[E].kind!=x.EOF;){var w=E;y(),t.Util.assert(E>w,"Error at "+e[E].text),function(e){if(n&&(e=b(e)),0!=e.length){if(e.forEach(s),e=a(e),n&&S.length>0){var r=S[S.length-1].tokens[0].synKind,i=e[0].synKind;if(r==T.IfKeyword&&i==T.ElseKeyword||r==T.TryKeyword&&i==T.CatchKeyword||r==T.TryKeyword&&i==T.FinallyKeyword||r==T.CatchKeyword&&i==T.FinallyKeyword)return e.unshift(u(e[0]," ")),void t.Util.pushRange(S[S.length-1].tokens,e)}S.push({tokens:e})}}(e.slice(w,E))}return S}function h(e){return e&&(e.kind==x.Whitespace||e.kind==x.NewLine)}function g(e){for(var t=[],r=!1,n=0;n<e.length;++n)r&&(n=a(e,n)),e[n]&&(t.push(e[n]),r=e[n].kind==x.NewLine);return t}function b(e){for(e=e.slice(0);h(e[0]);)e.shift();for(;h(e[e.length-1]);)e.pop();return e}function v(e){var t=[],n=0,i=l();for(e=e.concat([l()]);n<e.length;){var s=e[n=a(e,n)];if(s.kind==x.EOF)break;var o=a(e,n+1);if(s.kind!=x.NewLine||e[o].synKind!=T.OpenBraceToken){var p=!0,d=0==t.length?c(s):t[t.length-1];switch(d.synKind){case T.ExclamationToken:case T.TildeToken:case T.DotToken:p=!1;break;case T.PlusToken:case T.MinusToken:case T.PlusPlusToken:case T.MinusMinusToken:d.isPrefix&&(p=!1)}switch(s.synKind){case T.DotToken:case T.CommaToken:case T.NewLineTrivia:case T.ColonToken:case T.SemicolonToken:case T.OpenBracketToken:p=!1;break;case T.PlusPlusToken:case T.MinusMinusToken:d.kind!=x.Tree&&d.kind!=x.Identifier&&d.kind!=x.Keyword||(p=!1);case T.PlusToken:case T.MinusToken:(i.kind==x.EOF||r(i.synKind)||i.synKind==T.SemicolonToken)&&(s.isPrefix=!0);break;case T.OpenParenToken:if(d.kind==x.Identifier&&(p=!1),d.kind==x.Keyword)switch(d.synKind){case T.IfKeyword:case T.ForKeyword:case T.WhileKeyword:case T.SwitchKeyword:case T.ReturnKeyword:case T.ThrowKeyword:case T.CatchKeyword:break;default:p=!1}}d.kind==x.NewLine&&(p=!1),p&&t.push(u(s," ")),t.push(s),s.kind!=x.NewLine&&(i=s),n++}else n=o}return t}function y(e,t){if(t.synKind==T.NoSubstitutionTemplateLiteral&&/^`[\s\.#01]*`$/.test(t.text)){var r=t.text.slice(1,t.text.length-1).split("\n").map(function(e){return e.replace(/\s/g,"")}).filter(function(e){return!!e});if(r.length<4||r.length>5)return;var n=Math.floor((Math.max.apply(Math,r.map(function(e){return e.length}))+2)/5);n<=0&&(n=1);for(var i="`\n",a=0;a<5;++a){for(var s=r[a]||"";s.length<5*n;)s+=".";i+=e+(s=(s=(s=s.replace(/0/g,".")).replace(/1/g,"#")).replace(/...../g,function(e){return"/"+e})).replace(/./g,function(e){return" "+e}).replace(/\//g," ").slice(3)+"\n"}i+=e+"`",t.text=i}}function k(e){return Array.isArray(e)?"[[ "+e.map(k).join("  ")+" ]]":"string"==typeof e.text?JSON.stringify(e.text):e+""}var x;!function(e){e[e.None=0]="None",e[e.Whitespace=1]="Whitespace",e[e.Identifier=2]="Identifier",e[e.Keyword=3]="Keyword",e[e.Operator=4]="Operator",e[e.CommentLine=5]="CommentLine",e[e.CommentBlock=6]="CommentBlock",e[e.NewLine=7]="NewLine",e[e.Literal=8]="Literal",e[e.Tree=9]="Tree",e[e.Block=10]="Block",e[e.EOF=11]="EOF"}(x||(x={}));var S="",T=e.SyntaxKind,E=!1;t.toStr=k,t.format=function(e,t){function r(e){if(e.kind==x.Tree){var t=e;e.synKind,T.OpenBraceToken,t.children.forEach(r)}else e.kind==x.Block&&e.stmts.forEach(function(e){return e.tokens.forEach(r)})}function n(e,t){if(b==e.lineNo)t();else{b=e.lineNo;var r=d;d+="    ",t(),d=r}}function a(e){var t=g(e.tokens);1!=t.length||t[0].isCursor||""!=t[0].text?(f+=d,n(t[0],function(){u(t)}),"\n"!=f[f.length-1]&&(f+="\n")):f+="\n"}function l(e){-1==h&&e.pos+e.text.length>=t&&(h=f.length+(t-e.pos)),f+=e.text}function u(e){e=v(e);for(var t=0;t<e.length;++t)!function(t){var r=e[t];switch(y(d,r),l(r),r.kind){case x.Tree:var i=r;n(r,function(){u(g(i.children))}),i.endToken&&l(i.endToken);break;case x.Block:var s=r;0==s.stmts.length?f+=" ":(f+="\n",s.stmts.forEach(a),f+=d.slice(4)),s.endToken?l(s.endToken):f+="}";break;case x.NewLine:if(e[t+1]&&e[t+1].kind==x.CommentLine&&""==e[t+1].text&&!e[t+1].isCursor)break;t==e.length-1?f+=d.slice(4):f+=d;break;case x.Whitespace:}}(t)}var c=i(e).tokens,p=m(c=o(c=s(c,t)),!0),d="",f="",h=-1,b=0;return p.forEach(a),p.forEach(function(e){return e.tokens.forEach(r)}),-1==h&&(h=f.length),{formatted:f,pos:h}}}(e.pxtc||(e.pxtc={}))}(ts||(ts={}));var ts;!function(e){!function(e){function t(e,t){for(var r=0,n=Object.keys(t.strings);r<n.length;r++){var i=n[r];t.otherLiterals.push(e.string_literal(t.strings[i],i))}for(var a=0,s=Object.keys(t.doubles);a<s.length;a++){var o=s[a],l=t.doubles[o];t.otherLiterals.push("\n.balign 4\n"+l+": .short 0xffff, "+pxt.REF_TAG_NUMBER+"\n        .hex "+o+"\n")}for(var u=0,c=Object.keys(t.hexlits);u<c.length;u++){o=c[u];t.otherLiterals.push(e.hex_literal(t.hexlits[o],o)),t.otherLiterals.push()}}function r(t){var r="\n        .balign "+(1<<e.vtableShift)+"\n"+t.id+"_VT:\n        .short "+(4*t.refmask.length+4)+"  ; size in bytes\n        .byte "+(t.vtable.length+2)+", 0  ; num. methods\n",n=e.target.shortPointers?".short":".word",i=function(t){"0"!=t&&(!e.isStackMachine()||t.indexOf("::")>=0)&&(t+="@fn"),r+="        "+n+" "+t+"\n"};r+="        "+n+" "+t.id+"_IfaceVT\n",i("pxt::RefRecord_destroy"),i("pxt::RefRecord_print");for(var a=0,s=t.vtable;a<s.length;a++)i((c=s[a]).label());for(var o=t.refmask.map(function(e){return e?"1":"0"});o.length<2||o.length%2!=0;)o.push("0");r+="        .byte "+o.join(",")+"\n",r+="\n        .balign "+(e.target.shortPointers?2:4)+"\n"+t.id+"_IfaceVT:\n";for(var l=0,u=t.itable;l<u.length;l++){var c=u[l];i(c?c.label():"0")}return r+="\n"}function n(n,i){var a="; start\n"+u.hexPrelude()+"        \n    .hex 708E3B92C615A841C49866C975EE5197 ; magic number\n    .hex "+u.hexTemplateHash()+" ; hex template hash\n    .hex 0000000000000000 ; @SRCHASH@\n    .short "+n.globalsWords+"   ; num. globals\n    .short 0 ; patched with number of words resulting from assembly\n    .word _pxt_config_data\n    .word 0 ; reserved\n    .word 0 ; reserved\n",s=null;s=i.target.nativeType==e.NATIVE_TYPE_AVR?new e.AVRSnippets:new e.ThumbSnippets,n.procs.forEach(function(t){var r=new e.ProctoAssembler(s,n,t);a+="\n"+r.getAssembly()+"\n"}),n.usedClassInfos.forEach(function(e){a+=r(e)}),e.U.iterMap(n.codeHelpers,function(e,t){a+="    .section code\n"+t+":\n"+e+"\n"}),a+=s.arithmetic(),a+="\n.balign 4\n_pxt_config_data:\n";for(var o=0,l=n.res.configData||[];o<l.length;o++){var c=l[o];a+="    .word "+c.key+", "+c.value+"  ; "+c.name+"="+c.value+"\n"}return a+="    .word 0\n\n",a+=u.asmTotalSource,a+="_js_end:\n",t(s,n),a+=n.otherLiterals.join(""),a+="_program_end:\n"}function i(t,r){var n=e.U.sha256(r);return t.sourceHash=n,r.replace(/\n.*@SRCHASH@\n/,"\n    .hex "+n.slice(0,16).toUpperCase()+" ; program hash\n")}function a(t){var r;return(r=t.nativeType==e.NATIVE_TYPE_AVR?new e.assembler.File(new e.avr.AVRProcessor):t.nativeType==e.NATIVE_TYPE_AVRVM?new e.assembler.VMFile(new e.vm.VmProcessor(t)):new e.assembler.File(new e.thumb.ThumbProcessor)).ei.testAssembler(),r.lookupExternalLabel=u.lookupFunctionAddr,r.normalizeExternalLabel=function(e){var t=u.lookupFunc(e);return t?t.name:e},r}function s(t){if(t.errors.length>0){var r="";throw t.errors.forEach(function(t){var n=/^user(\d+)/.exec(t.scope);if(n){parseInt(n[1]);r+=e.U.lf("At inline assembly:\n"),r+=t.message}}),r?(console.log(e.U.lf("errors in inline assembly")),console.log(r),new Error(t.errors[0].message)):new Error(t.errors[0].message)}}function o(e,t,r){var n=a(e);return n.emit(r),r=n.getSource(!c,t.numStmts,e.flashEnd),s(n),{src:r,buf:n.buf,thumbFile:n}}function l(t,r){var n=e.Util.toUTF8(t);if(n.length+r.length>4e4)return"; program too long\n";var i="\n    .balign 16\n    .hex 41140E2FB82FA2BB\n    .short "+n.length+"\n    .short "+r.length+'\n    .short 0, 0   ; future use\n\n_stored_program: .string "',a=function(e){for(var t=0;t<e.length;++t){var r=255&e.charCodeAt(t);i+=r<=15?"\\x0"+r.toString(16):"\\x"+r.toString(16)}};return a(n),a(r),i+='"\n'}e.vtableShift=2;var u;!function(t){function r(t){for(var r="",n=0;n<t.length;n+=2)r=t[n]+t[n+1]+r;return e.assert(n==t.length),r}function n(t){if(!(t=t.replace(/^[\s:]/,"")))return[];var r=/^([a-f0-9][a-f0-9])/i.exec(t);if(r)return[parseInt(r[1],16)].concat(n(t.slice(2)));throw e.oops("bad bytes "+t)}function i(e){return e.flashCodeAlign||t.defaultPageSize}function a(t){for(var r=0;r<t.length;++r)if("2"==t[r][8]){var n=/^:02....02(....)..$/.exec(t[r]);e.U.assert(!!n);var i=16*parseInt(n[1],16);e.U.assert(0==(65535&i)),t[r]=l([2,0,0,4,0,i>>16])}}function s(e){return b[e]}function o(){for(var e=t.currentSetup?t.currentSetup.slice(0,16):"";e.length<16;)e+="0";return e.toUpperCase()}function l(e){var t=0,r=":";return e.forEach(function(e){return t+=e}),e.push(255&-t),e.forEach(function(e){return r+=("0"+e.toString(16)).slice(-2)}),r.toUpperCase()}function u(t,r){void 0===r&&(r=null);var n=[255,255,1,0];e.assert(4==n.length);var i=function(t,r,i){if(64==t[r]&&80==t[r+1]&&88==t[r+2]&&84==t[r+3]){var a=i();if(64==a[4]&&58==a[5]){for(var s=0;6+s<a.length&&0!=a[6+s];)s++;return 6+s>=a.length&&e.U.oops("constant string too long!"),n.concat([255&s,s>>8])}}return null};if(r)for(l=0;l<r.length-8;l+=4)!function(t){var n=i(r,t,function(){return r.slice(t,t+200)});n&&e.U.memcpy(r,t,n)}(l);else for(var a=0;a<t.blocks.length;++a)for(var s=t.blocks[a],o=t.ptrs[a]<<8,l=32;l<288;l+=4)!function(r){var n=o+r-32,a=i(s,r,function(){return e.UF2.readBytesFromFile(t,n,200)});a&&e.UF2.writeBytes(t,n,a)}(l)}var c,p,d,f,m,h,g,b={},v={};t.asmTotalSource="",t.defaultPageSize=1024,t.hexDump=function(e,t){function r(e,t){void 0===t&&(t=8);for(var r=e.toString(16);r.length<t;)r="0"+r;return r}void 0===t&&(t=0);for(var n="",i=0;i<e.length;i+=16){n+=r(t+i)+": ";for(var a="",s=0;s<16;s++){0==(3&s)&&(n+=" ");var o=e[i+s];null!=o?(n+=r(o,2)+" ",a+=32<=o&&o<127?String.fromCharCode(o):"."):n+="   "}n+=" "+a+"\n"}return n},t.setupInlineAssembly=function(r){v={};var n=r.sourceFiles.filter(function(t){return e.U.endsWith(t,".asm")});t.asmTotalSource="";for(var i=0,a=0,s=n;a<s.length;a++){var o=s[a],l=r.fileSystem[o];l.replace(/^\s*(\w+):/gm,function(e,t){return v[t]=!0,""});var u=".section code\n@stackmark func\n@scope user"+i+++"\n"+l+"\n@stackempty func\n@scope\n";t.asmTotalSource+=u}},t.flashCodeAlign=i,t.encodeVTPtr=function(t){var r=t>>e.vtableShift;return e.assert(r<65535),e.assert(r<<e.vtableShift==t),r},t.setupFor=function(s,o,u){function v(t){for(var n=s.shortPointers?4:8;t.length>=n;){var i=t.slice(0,n),a=parseInt(r(i),16);t=t.slice(n);var o=k.shift();if(!o)break;b[o.name]=o,a||e.U.oops("No value for "+o.name+" / "+i),s.nativeType!=e.NATIVE_TYPE_THUMB||1&a||e.U.oops("Non-thumb addr for "+o.name+" / "+i),o.value=a}}function y(){k.length&&e.oops("premature EOF in hex file; missing: "+k.map(function(e){return e.name}).join(", "))}if(!t.isSetupFor(o)){var k=o.functions;if(t.currentSetup=o.sha,t.currentHexInfo=u,c=u.hex,a(c),s.nativeType!=e.NATIVE_TYPE_CS){if(c.length<=2){h=pxt.elf.parse(e.U.fromHex(c[0])),g=-1,m=h.imageMemStart,t.bytecodeStartAddrPadded=h.imageMemStart,f=0;var x=c[0].indexOf("0108010842424242010801083ed8e98d");return x<0&&e.oops("no jmp table in elf"),p=x/2,d=-1,v(c[0].slice(x+32,x+32+8*k.length+16)),void y()}var S=0,T="0000",E=0,I=0;m=0;for(var w=function(){if(!m){var r=n(c[I]),a=16-(E+r[0]&15)&15;if(a)if(15&r[2]){for(var o=E+r[0],u=[a,o>>8,255&o,0],p=0;p<a;++p)u.push(0);I++,c.splice(I,0,l(u)),m=o+a}else{if(16!=r[0]){for(r.pop(),r[0]=16;r.length<20;)r.push(0);c[I]=l(r)}m=E+16}else m=E+r[0];g=I+1;var d=i(s);t.bytecodeStartAddrPadded=(m&~(d-1))+d;var h=t.bytecodeStartAddrPadded-m;e.assert(0==(15&h)),f=h}};S<c.length;++S){if((N=/:02000004(....)/.exec(c[S]))&&(T=N[1]),N=/^:..(....)00/.exec(c[S])){var _=parseInt(T+N[1],16);_>=245760&&w(),I=S,E=_}/^:00000001/.test(c[S])&&w(),(N=/^:10....000108010842424242010801083ED8E98D/.exec(c[S]))&&(p=E,d=S)}p||e.oops("No hex start"),m||e.oops("No hex end"),b={};for(var K=d+1;K<c.length;++K){var N=/^:..(....)00(.{4,})/.exec(c[K]);if(N&&(v(N[2]),0==k.length))break}y()}else for(var L=0,C=k;L<C.length;L++){var U=C[L];b[U.name]=U}}},t.validateShim=function(t,r,n,i,a){if("TD_ID"!=r&&"TD_NOOP"!=r&&!e.U.lookup(v,r)){var o=t+"(...) (shim="+r+")",l=s(r);if(l){if(e.target.nativeType==e.NATIVE_TYPE_CS)return;i?"V"==l.argsFmt[0]&&e.U.userError("expecting function for "+o):"V"!=l.argsFmt[0]&&e.U.userError("expecting procedure for "+o);for(var u=0;u<a.length;++u){var c=l.argsFmt[u+1];if(c||e.U.userError("excessive parameters passed to "+o),e.target.taggedInts){var p="I"==c||"N"==c||"F"==c;"T"==c||(p&&!a[u]?e.U.userError("expecting number at parameter "+(u+1)+" of "+o):!p&&a[u]&&e.U.userError("expecting non-number at parameter "+(u+1)+" of "+o+" / "+l.argsFmt))}}a.length!=l.argsFmt.length-1&&e.U.userError("not enough arguments for "+o+" (got "+a.length+"; fmt="+l.argsFmt+")")}else e.U.userError("function not found: "+o)}},t.lookupFunc=s,t.lookupFunctionAddr=function(e){var t=s(e);return t?t.value:null},t.hexTemplateHash=o,t.hexPrelude=function(){return"    .startaddr 0x"+t.bytecodeStartAddrPadded.toString(16)+"\n"},t.patchHex=function(n,i,a,s){function b(e,t){for(var r=[16,t>>8&255,255&t,0],n=0;n<8;++n)r.push(255&(e[x]||0)),r.push((e[x]||0)>>>8),x++;return r}var v=c.slice(0,g);e.assert(i.length<64e3,"program too large, words: "+i.length),i[17]=i.length;for(var y=[],k=0;k<f>>1;++k)y.push(0);i=y.concat(i);for(var x=0,S=[16905,0,65535&t.bytecodeStartAddrPadded,t.bytecodeStartAddrPadded>>>16],T=o(),k=0;k<4;++k)S.push(parseInt(r(T.slice(4*k,4*k+4)),16));var E=s?e.UF2.newBlockFile():null;if(h){for(var I=new Uint8Array(2*i.length),k=0;k<i.length;++k)pxt.HF2.write16(I,2*k,i[k]);for(var w=pxt.elf.patch(h,I),k=0;k<S.length;++k)pxt.HF2.write16(w,2*k+p,S[k]);return u(null,w),E?(e.UF2.writeBytes(E,0,w),[e.UF2.serializeFile(E)]):[e.U.uint8ArrayToString(w)]}if(E){if(e.UF2.writeHex(E,v),u(E),e.UF2.writeBytes(E,p,b(S,d).slice(4)),n.checksumBlock){for(var _=[],K=0,N=n.checksumBlock;K<N.length;K++){var L=N[K];_.push(255&L,L>>8)}e.UF2.writeBytes(E,n.target.flashChecksumAddr,_)}}else v[d]=l(b(S,p)),n.checksumBlock&&e.U.oops("checksum block in HEX not implemented yet");x=0,a&&(v=[]);for(var C=m,U=C-16>>16;x<i.length;)E?e.UF2.writeBytes(E,C,b(i,C).slice(4)):(C>>16!=U&&(U=C>>16,v.push(l([2,0,0,4,U>>8,255&U]))),v.push(l(b(i,C)))),C+=16;if(!a){var A=c.slice(g);E?e.UF2.writeHex(E,A):e.Util.pushRange(v,A)}return E?[e.UF2.serializeFile(E)]:v}}(u=e.hex||(e.hex={})),e.asmline=function(e){return/(^[\s;])|(:$)/.test(e)||(e="    "+e),e+"\n"},e.vtableToAsm=r,e.processorInlineAssemble=function(e,t){var r=a(e);r.disablePeepHole=!0,r.emit(t),s(r);for(var n=[],i=0;i<r.buf.length;i+=2)n.push(((r.buf[i+1]||0)<<16|r.buf[i])>>>0);return n};var c=!1;e.assemble=o,e.processorEmit=function(t,r,a){var s=n(t,r);s=i(t,s),r.embedBlob&&(s+=l(r.embedMeta,e.decodeBase64(r.embedBlob)));var c=u.flashCodeAlign(r.target);if(r.target.flashChecksumAddr){for(var p=0;c>1<<p;)p++;var d=parseInt(t.sourceHash.slice(0,8),16),f=u.bytecodeStartAddrPadded/c;d=4294967040&d|p;var m=0,h=f;r.target.flashChecksumAddr<u.bytecodeStartAddrPadded&&(h-=m=Math.ceil((r.target.flashChecksumAddr+32)/c)),s+="\n    .balign 4\n__end_marker:\n    .word "+d+"\n\n; ------- this will get removed from the final binary ------\n__flash_checksums:\n    .word 0x87eeb07c ; magic\n    .word __end_marker ; end marker position\n    .word "+d+" ; end marker\n    ; template region\n    .short "+m+", "+h+"\n    .word 0x"+u.hexTemplateHash().slice(0,8)+"\n    ; user region\n    .short "+f+", 0xffff\n    .word 0x"+t.sourceHash.slice(0,8)+"\n    .word 0x0 ; terminator\n"}t.writeFile(e.BINARY_ASM,s),t.numStmts=a.breakpoints.length;var g=o(r.target,t,s);if(g.src&&t.writeFile(e.BINARY_ASM,g.src),g.buf){if(r.target.flashChecksumAddr){var b=g.thumbFile.lookupLabel("__flash_checksums")/2;e.U.assert(b==g.buf.length-16);var v=g.buf.slice(g.buf.length-16);g.buf.splice(g.buf.length-16,16);var y=Math.ceil(2*g.buf.length/c);v[v.length-5]=y,t.checksumBlock=v}if(pxt.isOutputText(e.target))k=u.patchHex(t,g.buf,!1,!1).join("\r\n")+"\r\n",t.writeFile(pxt.outputName(e.target),k);else{var k=btoa(u.patchHex(t,g.buf,!1,!0)[0]);t.writeFile(pxt.outputName(e.target),k)}}for(var x=0,S=a.breakpoints;x<S.length;x++){var T=S[x],E=e.U.lookup(g.thumbFile.getLabels(),"__brkp_"+T.id);null!=E&&(T.binAddr=E)}for(var I=0,w=t.procs;I<w.length;I++)w[I].fillDebugInfo(g.thumbFile);a.procDebugInfo=t.procs.map(function(e){return e.debugInfo})},e.validateShim=u.validateShim}(e.pxtc||(e.pxtc={}))}(ts||(ts={}));var ts;!function(e){!function(t){function r(e,t){for(var r=0,n=e;r<n.length;r++){var a=n[r];i(a,t)}}function n(t,n,i){var a=e.createProgram(t,n,i);return function(){var e=a.getSyntacticDiagnostics();0===e.length&&0===(e=a.getOptionsDiagnostics().concat(a.getGlobalDiagnostics())).length&&(e=a.getSemanticDiagnostics()),r(e,i)}(),a}var i=function(r,n){var i="";if(r.file){var a=e.getLineAndCharacterOfPosition(r.file,r.start),s=a.line,o=a.character;i+=r.file.fileName+"("+(s+1)+","+(o+1)+"): "}i+=t.DiagnosticCategory[r.category].toLowerCase()+" TS"+r.code+": "+t.flattenDiagnosticMessageText(r.messageText,e.sys.newLine)+e.sys.newLine,e.sys.write(i)};t.plainTsc=function(t){function i(){var n=e.sys.readFile(s),i=e.parseConfigFileTextToJson(s,n),o=i.config;if(!o)return r([i.error],void 0),void e.sys.exit(e.ExitStatus.DiagnosticsPresent_OutputsSkipped);var l=e.parseJsonConfigFileContent(o,e.sys,t,a.options,s);return l.errors.length>0?(r(l.errors,void 0),void e.sys.exit(e.ExitStatus.DiagnosticsPresent_OutputsSkipped)):l}var a=e.parseCommandLine([]),s=e.findConfigFile(t,e.sys.fileExists);return function(){var t=i(),r=e.createCompilerHost(t.options);return r.getDefaultLibFileName=function(){return"node_modules/typescript/lib/lib.d.ts"},n(t.fileNames,t.options,r)}()}}(e.pxtc||(e.pxtc={}))}(ts||(ts={}));var ts;!function(e){!function(t){function r(e,r,n,i){if(r.initializer)return r.initializer;if(r.default)return r.default;if("number"==r.type)return"0";if("boolean"==r.type)return"false";if("string"==r.type)return n?(n=!1,"`"+t.defaultImgLit+i+"`"):'"'+i+'"';var a=e?t.Util.lookup(e.byQName,r.type):void 0;if(a&&a.kind==t.SymbolKind.Enum){var s=t.Util.values(e.byQName).filter(function(e){return e.namespace==r.type})[0];if(s)return s.namespace+"."+s.name}var o=/^\((.*)\) => (.*)$/.exec(r.type);return o?"("+o[1]+") => {\n    "+i+"\n}":t.placeholderChar}function n(e,t,n){if(void 0===n&&(n=""),t.parameters){var i=!!t.attributes.imageLiteral;return"("+t.parameters.filter(function(e){return!e.initializer}).map(function(t){return r(e,t,i,n)}).join(", ")+")"}return""}function i(e){switch(e.kind){case t.SK.MethodDeclaration:case t.SK.MethodSignature:return t.SymbolKind.Method;case t.SK.PropertyDeclaration:case t.SK.PropertySignature:return t.SymbolKind.Property;case t.SK.FunctionDeclaration:return t.SymbolKind.Function;case t.SK.VariableDeclaration:return t.SymbolKind.Variable;case t.SK.ModuleDeclaration:return t.SymbolKind.Module;case t.SK.EnumDeclaration:return t.SymbolKind.Enum;case t.SK.EnumMember:return t.SymbolKind.EnumMember;case t.SK.ClassDeclaration:return t.SymbolKind.Class;case t.SK.InterfaceDeclaration:return t.SymbolKind.Interface;default:return t.SymbolKind.None}}function a(e){if(e.modifiers&&e.modifiers.some(function(e){return e.kind==t.SK.PrivateKeyword||e.kind==t.SK.ProtectedKeyword}))return!1;var r=e.symbol;if(!r)return!1;for(;;){var n=r.parent;if(!n)break;r=n}var i=r.valueDeclaration||r.declarations[0];return i.kind==t.SK.VariableDeclaration&&(i=i.parent.parent),!(!i.parent||i.parent.kind!=t.SK.SourceFile)}function s(r,n,a){function s(t,n,i){void 0===i&&(i=!1);var a=r.getTypeAtLocation(n);return a?(i&&(a=a.getCallSignatures()[0].getReturnType()),r.typeToString(a,null,e.TypeFormatFlags.UseFullyQualifiedType)):"None"}var o=i(a);if(o!=t.SymbolKind.None){var l=a,u=t.parseComments(l);if(u.weight<0)return null;var c=/^(.*)\.(.*)/.exec(n),p=o==t.SymbolKind.Function||o==t.SymbolKind.Method,d=null,f=e.getSourceFileOfNode(a);if(f){var m=/^pxt_modules\/([^\/]+)/.exec(f.fileName);m&&(d=m[1])}var h=void 0;if(o==t.SymbolKind.Class||o==t.SymbolKind.Interface){var g=a;if(h=[],g.heritageClauses)for(var b=0,v=g.heritageClauses;b<v.length;b++){var y=v[b];if(y.types)for(var k=0,x=y.types;k<x.length;k++){var S=x[k];h.push(s(0,S))}}}return{kind:o,namespace:c?c[1]:"",name:c?c[2]:n,attributes:u,pkg:d,extendsTypes:h,retType:o==t.SymbolKind.Module?"":s(l.type,l,p),parameters:p?(l.parameters||[]).map(function(n,i){var a,o,l=t.getName(n),c=u.paramHelp[l]||"",p=u.paramMin&&u.paramMin[l],d=u.paramMax&&u.paramMax[l];/\beg\.?:\s*(.+)/.exec(c);if(n.type&&n.type.kind===t.SK.FunctionType){var f=r.getSignatureFromDeclaration(n.type).getParameters();"objectdestructuring"===u.mutate?(t.assert(f.length>0),a=r.getTypeAtLocation(f[0].valueDeclaration).getProperties().map(function(e){return{name:e.getName(),type:r.typeToString(r.getTypeOfSymbolAtLocation(e,f[0].valueDeclaration))}})):o=f.map(function(e,t){return{name:e.getName(),type:r.typeToString(r.getTypeOfSymbolAtLocation(e,n))}})}var m={},h=r.getTypeAtLocation(n),g=h&&!!(h.flags&e.TypeFlags.Enum);if(u.block&&u.paramShadowOptions){var b=[];u.block.replace(/%(\w+)/g,function(e,t){return b.push(t),""}),u.paramShadowOptions[b[i]]&&(m.fieldEditorOptions={value:u.paramShadowOptions[b[i]]})}return p&&(m.min={value:p}),d&&(m.max={value:d}),{name:l,description:c,type:s(n.type,n),initializer:n.initializer?n.initializer.getText():u.paramDefl[l],default:u.paramDefl[l],properties:a,handlerParameters:o,options:m,isEnum:g}}):null,snippet:t.service.getSnippet(l,u)}}return null}function o(e,t){return e.getFullyQualifiedName(t)}t.placeholderChar="◊",t.defaultImgLit="\n. . . . .\n. . . . .\n. . # . .\n. . . . .\n. . . . .\n",t.renderCall=function(e,t){return t.namespace+"."+t.name+n(e,t)+";"},t.renderParameters=n,t.genDocs=function(r,n,i){function a(e){return!!e.attributes.block&&!!e.attributes.blockId}void 0===i&&(i={}),pxt.debug("generating docs for "+r),pxt.debug(JSON.stringify(Object.keys(n.byQName),null,2));for(var s={},o=t.Util.values(n.byQName),l=o.filter(function(e){return e.kind==t.SymbolKind.EnumMember}).sort(function(e,r){var n=-(a(e)?1:-1)+(a(r)?1:-1);return n||(n=-(e.attributes.weight||50)+(r.attributes.weight||50))||t.U.strcmp(e.name,r.name)}),u={},c={},p=function(r){if(i.locs&&r.qName&&!r.attributes.deprecated&&!/^__/.test(r.name)){if(pxt.debug("loc: "+r.qName),r.kind!=t.SymbolKind.EnumMember){var n=e.pxtc.blocksCategory(r);n&&(u["{id:category}"+n]=n)}r.attributes.jsDoc&&(c[r.qName]=r.attributes.jsDoc),r.attributes.block&&(u[r.qName+"|block"]=r.attributes.block),r.attributes.group&&(u["{id:group}"+r.attributes.group]=r.attributes.group),r.parameters&&r.parameters.filter(function(e){return!!e.description}).forEach(function(e){c[r.qName+"|param|"+e.name]=e.description})}},d=function(e,t){if(i.locs){var n={};Object.keys(e).sort().forEach(function(t){return n[t]=e[t]}),s[r+t+"-strings.json"]=JSON.stringify(n,null,2)}},f=0,m=o;f<m.length;f++)!function(e){if(e.kind==t.SymbolKind.Module){if(!o.filter(function(t){return t.namespace==e.name&&!!t.attributes.jsDoc})[0])return"continue";e.attributes.block||(e.attributes.block=e.name)}p(e)}(m[f]);return i.locs&&l.forEach(function(e){e.attributes.block&&(u[e.qName+"|block"]=e.attributes.block),e.attributes.jsDoc&&(u[e.qName]=e.attributes.jsDoc)}),d(u,""),d(c,"-jsdoc"),s},t.getApiInfo=function(e,r,n){void 0===n&&(n=!1);for(var i={byQName:{},jres:e.jres},l=r.getTypeChecker(),u=function(e){if(e.kind!=t.SK.VariableStatement){if(a(e)){if(!e.symbol)return void console.warn("no symbol",e);var r=o(l,e.symbol),n=s(l,r,e);if(n){var c=t.U.lookup(i.byQName,r);c&&(n.attributes=t.parseCommentString(c.attributes._source+"\n"+n.attributes._source),c.extendsTypes&&(n.extendsTypes=n.extendsTypes||[],c.extendsTypes.forEach(function(e){-1===n.extendsTypes.indexOf(e)&&n.extendsTypes.push(e)}))),i.byQName[r]=n}}if(e.kind==t.SK.ModuleDeclaration){var p=e;p.body.kind==t.SK.ModuleBlock&&p.body.statements.forEach(u)}else if(e.kind==t.SK.InterfaceDeclaration)(d=e).members.forEach(u);else if(e.kind==t.SK.ClassDeclaration){var d=e;d.members.forEach(u)}else e.kind==t.SK.EnumDeclaration&&e.members.forEach(u)}else e.declarationList.declarations.forEach(u)},c=0,p=r.getSourceFiles();c<p.length;c++)p[c].statements.forEach(u);var d=[];for(var f in i.byQName){var m=i.byQName[f];m.qName=f,m.attributes._source=null,m.extendsTypes&&m.extendsTypes.length&&d.push(m);var h=m.attributes.jres;if(h){"true"==h&&(h=f);var g=t.U.lookup(e.jres||{},h);g&&g.icon&&!m.attributes.iconURL&&(m.attributes.iconURL=g.icon),g&&g.data&&!m.attributes.jresURL&&(m.attributes.jresURL="data:"+g.mimeType+";base64,"+g.data)}}var b={},v=function(e){if(!t.U.lookup(b,e.qName)){b[e.qName]=!0;var r={};r[e.qName]=!0;for(var n=0,a=e.extendsTypes||[];n<a.length;n++){var s=a[n];r[s]=!0;var o=i.byQName[s];if(o){v(o);for(var l=0,u=o.extendsTypes;l<u.length;l++)r[u[l]]=!0}}e.extendsTypes=Object.keys(r)}};return d.forEach(v),n&&delete i.byQName["Array.map"],i},t.getFullName=o,t.fillCompletionEntries=function(e,r,n,i){for(var a=e.getTypeChecker(),l=0,u=r;l<u.length;l++){var c=u[l],p=o(a,c);if((n.isMemberCompletion||!t.Util.lookup(i.byQName,p))&&!t.Util.lookup(n.entries,p)){var d=c.valueDeclaration||(c.declarations||[])[0];if(d){var f=s(a,p,d);f&&(f.isContextual=!0,n.entries[p]=f)}}}}}(e.pxtc||(e.pxtc={}))}(ts||(ts={}));var ts;!function(e){!function(t){!function(r){function n(e){if(!/\.ts$/.test(e))return[];var t=a.getSyntacticDiagnostics(e);return t&&t.length||(t=a.getSemanticDiagnostics(e)),t||(t=[]),t}function i(){a||(s=new h,a=e.createLanguageService(s))}var a,s,o,l,u,c,p,d,f,m={fileSystem:{},sourceFiles:[],target:{isNative:!1,hasHex:!1},hexinfo:null},h=function(){function r(){this.opts=m,this.fileVersions={},this.projectVer=0}return r.prototype.getProjectVersion=function(){return this.projectVer+""},r.prototype.setFile=function(e,t){this.opts.fileSystem[e]!=t&&(this.fileVersions[e]=(this.fileVersions[e]||0)+1,this.opts.fileSystem[e]=t,this.projectVer++)},r.prototype.setOpts=function(e){var r=this;t.Util.iterMap(e.fileSystem,function(e,t){r.opts.fileSystem[e]!=t&&(r.fileVersions[e]=(r.fileVersions[e]||0)+1)}),this.opts=e,this.projectVer++},r.prototype.getCompilationSettings=function(){return t.getTsCompilerOptions(this.opts)},r.prototype.getScriptFileNames=function(){return this.opts.sourceFiles.filter(function(e){return t.U.endsWith(e,".ts")})},r.prototype.getScriptVersion=function(e){return(this.fileVersions[e]||0).toString()},r.prototype.getScriptSnapshot=function(t){var r=this.opts.fileSystem[t];return r?e.ScriptSnapshot.fromString(r):null},r.prototype.getNewLine=function(){return"\n"},r.prototype.getCurrentDirectory=function(){return"."},r.prototype.getDefaultLibFileName=function(e){return"no-default-lib.d.ts"},r.prototype.log=function(e){console.log("LOG",e)},r.prototype.trace=function(e){console.log("TRACE",e)},r.prototype.error=function(e){console.error("ERROR",e)},r.prototype.useCaseSensitiveFileNames=function(){return!0},r}(),g=function(e){return e?(u||(u=t.getBlocksInfo(e)),u):(l||(l=t.getBlocksInfo(o)),l)},b={reset:function(){a.cleanupSemanticCache(),s.setOpts(m)},setOptions:function(e){s.setOpts(e.options)},getCompletions:function(e){e.fileContent&&s.setFile(e.fileName,e.fileContent);var r=a.getProgram(),n=a.getCompletionData(e.fileName,e.position);if(!n)return{};r.getTypeChecker();var i={entries:{},isMemberCompletion:n.isMemberCompletion,isNewIdentifierLocation:n.isNewIdentifierLocation,isTypeLocation:!1};return t.fillCompletionEntries(r,n.symbols,i,o),i},compile:function(e){return t.compile(e.options)},decompile:function(e){return t.decompile(e.options,e.fileName)},compileTd:function(e){var r=t.compile(e.options);return t.getApiInfo(s.opts,r.ast,!0)},assemble:function(e){return{words:t.processorInlineAssemble(s.opts.target,e.fileContent)}},fileDiags:function(e){return t.patchUpDiagnostics(n(e.fileName))},allDiags:function(){var e=a.getCompilerOptionsDiagnostics()||[],r=s.getScriptFileNames().map(n),i=e.concat(t.Util.concat(r));if(0==i.length){var o={outfiles:{},diagnostics:[],success:!0,times:{}};i=t.compileBinary(a.getProgram(),null,s.opts,o).diagnostics}return t.patchUpDiagnostics(i)},format:function(e){var r=e.format;return t.format(r.input,r.pos)},apiInfo:function(){return l=void 0,c=void 0,o=t.getApiInfo(s.opts,a.getProgram())},blocksInfo:g,apiSearch:function(e){var t=e.search,r=g(t.localizedApis);t.localizedStrings&&pxt.Util.setLocalizedStrings(t.localizedStrings);var n=function(e,t,r){if(e)return"string"==typeof e?e:t?e[t]:Object.keys(e).map(function(t){return e[t]}).join(" ")};if(!p){p=[],d=pxt.blocks.blockDefinitions();for(var i in d)!function(e){var t=d[e];if(t.operators)for(var r in t.operators)!function(r){t.operators[r].forEach(function(n){return p.push({id:e,name:t.name,jsdoc:"string"==typeof t.tooltip?t.tooltip:t.tooltip[n],block:n,field:[r,n]})})}(r);else p.push({id:e,name:t.name,jsdoc:n(t.tooltip,t.tooltipSearch),block:n(t.block,t.blockTextSearch)})}(i)}var a,s=function(e){var t=e.attributes.weight||50,n=r.apis.byQName[e.namespace];return(1e3*(n?n.attributes.weight||50:50)+t)*(!!n&&n.attributes.advanced||e.attributes.advanced?1:1e6)};if(!c||t.subset){var o={},l=void 0;t.subset&&(f=t.subset,l=p.filter(function(e){return f[e.id]})),f?a=r.blocks.filter(function(e){return f[e.attributes.blockId]}):(a=r.blocks,l=p);var u=a.map(function(e){return{id:e.attributes.blockId,qName:e.qName,name:e.name,nameSpace:e.namespace,block:e.attributes.block,jsDoc:e.attributes.jsDoc}}),m=0;a.forEach(function(e){var t=o[e.qName]=s(e);m=Math.max(m,t)}),u=u.concat(l);var h={shouldSort:!0,threshold:.6,location:0,distance:100,maxPatternLength:16,minMatchCharLength:2,findAllMatches:!1,caseSensitive:!1,keys:[{name:"name",weight:.3125},{name:"namespace",weight:.1875},{name:"block",weight:.4375},{name:"jsDoc",weight:.0625}],sortFn:function(e,t){var r=e.qName?1-o[e.item.qName]/m:1,n=t.qName?1-o[t.item.qName]/m:1;return e.score*(1+r/10)-t.score*(1+n/10)}};c=new Fuse(u,h)}return c.search(t.term).slice(0,7)}};r.performOperation=function(e,t){i();var r=null;if(b.hasOwnProperty(e))try{r=b[e](t)||{}}catch(e){r={errorMessage:e.stack}}else r={errorMessage:"No such operation: "+e};return r};var v="`\n. . . . .\n. . . . .\n. . # . .\n. . . . .\n. . . . .\n`";r.getSnippet=function(r,n){function i(t){var r="",n=e.mapToDisplayParts(function(e){s.getSymbolDisplayBuilder().buildSignatureDisplay(t,e)}),i=s.getReturnTypeOfSignature(t);i.flags&e.TypeFlags.NumberLike?r="return 0;":i.flags&e.TypeFlags.StringLike?r='return "";':i.flags&e.TypeFlags.Boolean&&(r="return false;");var a=e.displayPartsToString(n);return"function "+a.substr(0,a.lastIndexOf(":"))+" {\n    "+r+"\n}"}if(e.isFunctionLike(r)){var s=a?a.getProgram().getTypeChecker():void 0,o=r.parameters?r.parameters.filter(function(e){return!e.initializer&&!e.questionToken}).map(function(r){var a=r.type;if(!a)return"null";var o=r.name.kind===t.SK.Identifier?r.name.text:void 0;if(n&&n.paramDefl&&n.paramDefl[o]){if(a.kind==t.SK.StringKeyword){var l=n.paramDefl[o];return a.kind==t.SK.StringKeyword&&0!=l.indexOf('"')?'"'+l+'"':l}return n.paramDefl[o]}switch(a.kind){case t.SK.StringKeyword:return"leds"==o?v:'""';case t.SK.NumberKeyword:return"0";case t.SK.BooleanKeyword:return"false";case t.SK.ArrayType:return"[]";case t.SK.TypeReference:if(s){var u=s.getTypeAtLocation(r);if(u){if(u.flags&e.TypeFlags.Enum){if(u.symbol){var c=u.symbol.valueDeclaration;if(c.members.length&&c.members[0].name.kind===t.SK.Identifier)return u.symbol.name+"."+c.members[0].name.text}return"0"}if(u.flags&e.TypeFlags.Number)return"0"}}break;case t.SK.FunctionType:var p=a,d=s?s.getSignatureFromDeclaration(p):void 0;return d?i(d):"function () {}"}var f=s?s.getTypeAtLocation(r):void 0;if(f&&f.flags&e.TypeFlags.Anonymous){var m=s.getSignaturesOfType(f,e.SignatureKind.Call);return m.length?i(m[0]):"function () {}"}return"null"}):[];return r.name.getText()+"("+o.join(", ")+")"}}}(t.service||(t.service={}))}(e.pxtc||(e.pxtc={}))}(ts||(ts={}));var ts;!function(e){!function(e){!function(t){var r=e.assembler.emitErr,n=r("opcode name doesn't match","<name>"),i=function(t){function i(e,r,n){t.call(this,e,r,n,n,!1)}return __extends(i,t),i.prototype.emit=function(t){var i=t.words;if(i[0]!=this.name)return n;for(var a=this.opcode,s=1,o=[],l=null,u=null,c=0;c<this.args.length;++c){var p=this.args[c],d=i[s++];if("$"==p[0]){var f=this.ei.encoders[p],m=null;if(f.isImmediate){if(!d)return r("expecting number",d);if(d=d.replace(/^#/,""),null==(m=t.bin.parseOneInt(d)))return r("expecting number",d)}else e.oops();if(null==m)return r("didn't understand it",d);if(o.push(m),null==(m=f.encode(m)))return r("argument out of range or mis-aligned",d);"$i1"==p?(e.assert(0<=m&&m<=255),l=m):"$i2"==p?(l=255&m,u=m>>8&255):e.oops()}else if(p!=d)return r("expecting "+p,d)}return i[s]?r("trailing tokens",i[s]):("call"==this.name&&(a+=o[0]),{stack:0,opcode:a,opcode2:l,opcode3:u,numArgs:o,labelName:t.bin.normalizeExternalLabel(null)})},i}(e.assembler.Instruction);t.VmInstruction=i;var a=function(t){function r(r){var n=this;t.call(this),this.addEnc("$i1","#0-255",function(e){return n.inrange(255,e,e)}),this.addEnc("$i2","#0-65535",function(e){return n.inrange(65535,e,e)}),e.U.iterMap(r.vmOpCodes,function(t,r){var a=/(.*)_(\d+)/.exec(t),s="";"call"==a[1]?s="call $i1, $i2":"0"==a[2]?s=a[1]:"1"==a[2]?s=a[1]+" $i1":"2"==a[2]?s=a[1]+" $i2":e.oops();var o=new i(n,s,r);n.instructions.hasOwnProperty(o.name)||(n.instructions[o.name]=[]),n.instructions[o.name].push(o)})}return __extends(r,t),r.prototype.testAssembler=function(){},r.prototype.postProcessRelAddress=function(e,t){return t+e.baseOffset},r.prototype.postProcessAbsAddress=function(e,t){return t},r.prototype.getAddressFromLabel=function(e,t,r,n){void 0===n&&(n=!1);var i=e.lookupLabel(r);return null==i?null:t.is32bit?i:i-(e.pc()+2)},r.prototype.toFnPtr=function(e,t){return e},r.prototype.wordSize=function(){return 2},r.prototype.peephole=function(e,t,r){var n=e.getOp(),i="";if(t){var a=n+";"+(i=t.getOp()),s=this.file.peepCounts;s[a]=(s[a]||0)+1}"jmp"==n&&e.numArgs[0]==this.file.baseOffset+t.location?e.update(""):"push"!=n||"callproc"!=i&&"ldconst"!=i&&"stringlit"!=i&&"ldtmp"!=i?"push"!=n||"ldzero"!=i&&"ldone"!=i?"ldtmp"!=n||"incr"!=i&&"decr"!=i||(e.update("ldtmp_"+i+" "+e.words[1]),t.update("")):(e.update(""),t.update("push_"+i)):(e.update(""),t.update("push_"+i+" "+t.words[1]))},r}(e.assembler.AbstractProcessor);t.VmProcessor=a}(e.vm||(e.vm={}))}(e.pxtc||(e.pxtc={}))}(ts||(ts={}));