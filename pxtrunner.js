var pxt;!function(e){!function(n){n.startDebuggerAsync=function(e){new t(e).start()};var t=function(){function n(e){this.container=e,this.pkgLoaded=!1,this.intervalRunning=!1}return n.prototype.start=function(){var e=this;this.initializeWebsocket(),this.intervalRunning||(this.intervalRunning=!0,this.intervalId=setInterval(function(){if(!e.ws)try{e.initializeWebsocket()}catch(e){console.warn("Connection to server failed, retrying in "+n.RETRY_MS+" ms")}},n.RETRY_MS)),this.session=new pxsim.SimDebugSession(this.container),this.session.start(this)},n.prototype.initializeWebsocket=function(){var n=this;e.Cloud.isLocalHost()&&e.Cloud.localToken&&(e.debug("initializing debug pipe"),this.ws=new WebSocket("ws://localhost:3234/"+e.Cloud.localToken+"/simdebug"),this.ws.onopen=function(n){e.debug("debug: socket opened")},this.ws.onclose=function(t){e.debug("debug: socket closed"),n.closeListener&&n.closeListener(),n.session.stopSimulator(),n.ws=void 0},this.ws.onerror=function(t){e.debug("debug: socket closed due to error"),n.errorListener&&n.errorListener(t.type),n.session.stopSimulator(),n.ws=void 0},this.ws.onmessage=function(t){var o;try{o=JSON.parse(t.data)}catch(n){e.debug("debug: could not parse message")}o&&("runner"===o.type?n.handleRunnerMessage(o):("request"===o.type&&"launch"===o.command&&n.sendRunnerMessage("configure",{projectDir:o.arguments.projectDir}),n.dataListener(o)))})},n.prototype.send=function(e){this.ws.send(e)},n.prototype.onData=function(e){this.dataListener=e},n.prototype.onError=function(e){this.errorListener=e},n.prototype.onClose=function(e){this.closeListener=e},n.prototype.close=function(){this.session&&this.session.stopSimulator(!0),this.intervalRunning&&(clearInterval(this.intervalId),this.intervalId=void 0),this.ws&&this.ws.close()},n.prototype.handleRunnerMessage=function(e){switch(e.subtype){case"ready":this.sendRunnerMessage("ready");break;case"runcode":this.runCode(e)}},n.prototype.runCode=function(n){var t=[];n.breakpoints.forEach(function(e){t.push([e.id,{verified:!0,line:e.line,column:e.column,endLine:e.endLine,endColumn:e.endColumn,source:{path:e.fileName}}])}),this.session.runCode(n.code,n.usedParts,n.usedArguments,new pxsim.BreakpointMap(t),e.appTarget.simulator.boardDefinition)},n.prototype.sendRunnerMessage=function(e,n){void 0===n&&(n={}),n.subtype=e,n.type="runner",this.send(JSON.stringify(n))},n.RETRY_MS=2500,n}();n.DebugRunner=t}(e.runner||(e.runner={}))}(pxt||(pxt={}));var pxt;!function(e){!function(n){function t(e,n){e.append($('<div class="ui content blocks"/>').append(n))}function o(e,n,t){e.append($('<div class="ui content js"/>').append(n)),"undefined"!=typeof hljs&&n.find("code.highlight").each(function(e,n){hljs.highlightBlock(n)})}function i(n,i,r,a,s,l){void 0===l&&(l={});e.webConfig.commitCdnUrl;var c=$('<div class="ui bottom attached tabular icon small compact menu hideprint"> <div class="right icon menu"></div></div>'),d=$('<div class="ui top attached segment"></div>'),p=c.find(".right.menu"),u=e.appTarget.appTheme||{};if(l.showEdit&&!u.hideDocsEdit){var f=$('<a class="item" role="button" tabindex="0" aria-label="'+lf("edit")+'"><i role="presentation" aria-hidden="true" class="edit icon"></i></a>').click(function(){s.package.compressToFileAsync(n.showJavaScript?e.JAVASCRIPT_PROJECT_NAME:e.BLOCKS_PROJECT_NAME).done(function(t){return window.open(v(n)+"/#project:"+window.btoa(e.Util.uint8ArrayToString(t)),"pxt")})});p.append(f)}if(n.showJavaScript||!a){if(d.append(r),a){var m=$('<a class="item blocks" role="button" tabindex="0" aria-label="'+lf("Blocks")+'"><i role="presentation" aria-hidden="true" class="puzzle icon"></i></a>').click(function(){d.find(".blocks")[0]?d.find(".blocks").remove():r?t(r.parent(),a):t(d,a)});p.append(m)}}else if(d.append(a),l.showJs)o(d,r,l);else{var g=$('<a class="item js" role="button" tabindex="0" aria-label="'+lf("JavaScript")+'"><i role="presentation" aria-hidden="true" class="align left icon"></i></a>').click(function(){d.find(".js")[0]?d.find(".js").remove():a?o(a.parent(),r,l):o(d,r,l)});p.append(g)}if(l.run&&!u.hideDocsSimulator){var k=$('<a class="item" role="button" tabindex="0" aria-label="'+lf("run")+'"><i role="presentation" aria-hidden="true" class="play icon"></i></a>').click(function(){if(d.find(".sim")[0])d.find(".sim").remove();else{var t="81.97%";e.appTarget.simulator&&(t=100/e.appTarget.simulator.aspectRatio+"%");var o=$('<div class="ui card sim"><div class="ui content"><div style="position:relative;height:0;padding-bottom:'+t+';overflow:hidden;"><iframe style="position:absolute;top:0;left:0;width:100%;height:100%;" src="'+h(n)+"#nofooter=1&code="+encodeURIComponent(r.text())+'" allowfullscreen="allowfullscreen" sandbox="allow-popups allow-forms allow-scripts allow-same-origin" frameborder="0"></iframe></div></div></div>');d.append(o)}});p.append(k)}if(l.hexname&&l.hex){var b=$('<a class="item" role="button" tabindex="0" aria-label="'+lf("download")+'"><i role="presentation" aria-hidden="true" class="download icon"></i></a>').click(function(){e.BrowserUtils.browserDownloadBinText(l.hex,l.hexname,e.appTarget.compile.hexMimeType)});p.append(b)}var w=[d];if(p.children().length&&w.push(c),i.replaceWith(w),n.downloadScreenshots&&l.hexname){e.debug("Downloading screenshot for: "+l.hexname);var y=l.hexname.substr(0,l.hexname.lastIndexOf(".")),x=(window.getComputedStyle(a.get(0).getElementsByClassName("blocklyText").item(0)).getPropertyValue("font-size"),a.get(0)),C=a.get(0).getBoundingClientRect();e.blocks.layout.svgToPngAsync(x,0,0,C.width,C.height,4).done(function(n){n&&e.BrowserUtils.browserDownloadDataUri(n,(name||(e.appTarget.nickname||e.appTarget.id)+"-"+y)+".png")})}}function r(n,t,o){if(!n)return Promise.resolve();var i=$("."+n).first();return i[0]?(o.emPixels||(o.emPixels=14),o.layout||(o.layout=e.blocks.BlockLayout.Flow),e.runner.decompileToBlocksAsync(i.text(),o).then(function(e){try{t(i,e)}catch(e){console.error("error while rendering "+i.html()),i.append($("<div/>").addClass("ui segment warning").text(e.message))}return i.removeClass(n),Promise.delay(1,r(n,t,o))})):Promise.resolve()}function a(n){if(n.tutorial)return r(n.snippetClass,function(e,t){var o=t.blocksSvg;n.snippetReplaceParent&&(e=e.parent());var i=$('<div class="ui segment"/>').append(o);e.replaceWith(i)},{package:n.package,snippetMode:!1});var t=0;return r(n.snippetClass,function(o,r){var a=r.compileBlocks&&r.compileBlocks.success?$(r.blocksSvg):void 0,s=$('<code class="lang-typescript highlight"/>').text(o.text().trim());n.snippetReplaceParent&&(o=o.parent());var l=r.compileJS&&r.compileJS.success,c=n.hex&&l&&r.compileJS.outfiles[pxtc.BINARY_HEX]?r.compileJS.outfiles[pxtc.BINARY_HEX]:void 0,d=(e.appTarget.nickname||e.appTarget.id)+"-"+(n.hexName||"")+"-"+t+++".hex";i(n,o,s,a,r,{showEdit:n.showEdit,run:n.simulator&&l,hexname:d,hex:c})},{package:n.package})}function s(e){if(!e||e.kind!=ts.SyntaxKind.ExpressionStatement)return null;var n=e;return n.expression&&n.expression.kind==ts.SyntaxKind.CallExpression?n.expression.callInfo:null}function l(n){return r(n.signatureClass,function(t,o){if(o.compileJS){var r=s(o.compileJS.ast.getSourceFile("main.ts").statements[0]);if(r){var a=Blockly.Blocks[r.attrs.blockId],l=a&&a.codeCard?a.codeCard.blocksXml:void 0,c=l?$(e.blocks.render(l)):o.compileBlocks&&o.compileBlocks.success?$(o.blocksSvg):void 0,d=r.decl.getText().replace(/^export/,"");d=d.slice(0,d.indexOf("{")).trim()+";";var p=$('<code class="lang-typescript highlight"/>').text(d);n.snippetReplaceParent&&(t=t.parent()),i(n,t,p,c,o,{showJs:!0,hideGutter:!0})}}},{package:n.package,snippetMode:!0})}function c(e){return r(e.blocksClass,function(n,t){var o=t.blocksSvg;e.snippetReplaceParent&&(n=n.parent());var i=$('<div class="ui segment"/>').append(o);n.replaceWith(i)},{package:e.package,snippetMode:!0})}function d(n){return e.runner.decompileToBlocksAsync("",n).then(function(e){var n={},t=e.compileBlocks.blocksInfo;t.blocks.forEach(function(e){var o=(e.attributes.blockNamespace||e.namespace).split(".")[0];if(!n[o]){var i=t.apis.byQName[o];i&&i.attributes.color&&(n[o]=i.attributes.color)}});var o="";return Object.keys(n).forEach(function(e){var t=n[e]||"#dddddd";o+="\n                        span.docs."+e.toLowerCase()+" {\n                            background-color: "+t+" !important;\n                            border-color: "+Blockly.PXTUtils.fadeColour(t,.2,!0)+" !important;\n                        }\n                    "}),o}).then(function(n){return Object.keys(e.blocks.blockColors).forEach(function(t){var o=e.blocks.blockColors[t];n+="\n                        span.docs."+t.toLowerCase()+" {\n                            background-color: "+o+" !important;\n                            border-color: "+Blockly.PXTUtils.fadeColour(o,.2,!0)+" !important;\n                        }\n                    "}),n}).then(function(e){var n=document.createElement("style");n.id="namespaceColors",n.type="text/css",(document.head||document.getElementsByTagName("head")[0]).appendChild(n),n.appendChild(document.createTextNode(e))})}function p(n){function t(){if(i>=o.length)return Promise.resolve();var r=$(o[i++]),a=r.text(),l=/^(\|+)([^\|]+)\|+$/.exec(a);if(l){var c=/^(([^\:\.]*?)[\:\.])?(.*)$/.exec(l[2]),d=c[2]?c[2].trim().toLowerCase():"",p=1==l[1].length?"docs inlinebutton "+d:"docs inlineblock "+d,u=c[3].trim();return r.replaceWith($('<span class="'+p+'"/>').text(e.U.rlf(u))),t()}var f=/^\[([^\]]+)\]$/.exec(a);if(!f)return t();var m=f[1];return e.runner.decompileToBlocksAsync(m,n).then(function(e){if(e.blocksSvg){var n=$('<span class="block"/>').append(e.blocksSvg),o=s(e.compileJS.ast.getSourceFile("main.ts").statements[0]);o&&o.attrs.help&&(n=$('<a class="ui link"/>').attr("href","/reference/"+o.attrs.help).append(n)),r.replaceWith(n)}return Promise.delay(1,t())})}(n=e.Util.clone(n)).emPixels=18,n.snippetMode=!0;var o=$(":not(pre) > code"),i=0;return t()}function u(n){function t(){var o=$("."+n.projectClass).first(),i=o[0];if(!i)return Promise.resolve();o.removeClass(n.projectClass);var r=e.Cloud.parseScriptId(i.innerText);if(r){if(n.snippetReplaceParent){i=i.parentElement;var a=document.createElement("div");i.parentElement.insertBefore(a,i),i.parentElement.removeChild(i),i=a}return e.runner.renderProjectAsync(i,r).then(function(){return t()})}return t()}return n.projectClass?t():Promise.resolve()}function f(n,t,o,i){return r(t,function(n,t){if(t.compileJS){var r=t.compileJS.ast.getSourceFile("main.ts").statements.slice(0).reverse(),a=$("<div />").addClass("ui cards");a.attr("role","listbox");var l=function(n){n&&a.append(e.docs.codeCard.render(n,{hideHeader:!0,shortName:!0}))};r.forEach(function(n){var o=s(n);if(o){var r=Blockly.Blocks[o.attrs.blockId];if(i){var a=t.compileBlocks.blocksInfo.apis.byQName[o.qName],c=t.compileBlocks.blocksInfo.apis.byQName[a.namespace];l({name:c.attributes.blockNamespace||c.name,url:c.attributes.help||"reference/"+(c.attributes.blockNamespace||c.name).toLowerCase(),description:c.attributes.jsDoc,blocksXml:r&&r.codeCard?r.codeCard.blocksXml:o.attrs.blockId?'<xml xmlns="http://www.w3.org/1999/xhtml"><block type="'+o.attrs.blockId+'"></block></xml>':void 0})}else if(r){var d=e.U.clone(r.codeCard);d&&l(d)}else l({name:o.qName,description:o.attrs.jsDoc,url:o.attrs.help||void 0})}else switch(n.kind){case ts.SyntaxKind.ExpressionStatement:var p=n;switch(p.expression.kind){case ts.SyntaxKind.TrueKeyword:case ts.SyntaxKind.FalseKeyword:l({name:"Boolean",url:"blocks/logic/boolean",description:lf("True or false values"),blocksXml:'<xml xmlns="http://www.w3.org/1999/xhtml"><block type="logic_boolean"><field name="BOOL">TRUE</field></block></xml>'});break;default:e.debug("card expr kind: "+p.expression.kind)}break;case ts.SyntaxKind.IfStatement:l({name:i?"Logic":"if",url:"blocks/logic"+(i?"":"/if"),description:i?lf("Logic operators and constants"):lf("Conditional statement"),blocksXml:'<xml xmlns="http://www.w3.org/1999/xhtml"><block type="controls_if"></block></xml>'});break;case ts.SyntaxKind.WhileStatement:l({name:i?"Loops":"while",url:"blocks/loops"+(i?"":"/while"),description:i?lf("Loops and repetition"):lf("Repeat code while a condition is true."),blocksXml:'<xml xmlns="http://www.w3.org/1999/xhtml"><block type="device_while"></block></xml>'});break;case ts.SyntaxKind.ForOfStatement:l({name:i?"Loops":"for of",url:"blocks/loops"+(i?"":"/for-of"),description:i?lf("Loops and repetition"):lf("Repeat code for each item in a list."),blocksXml:'<xml xmlns="http://www.w3.org/1999/xhtml"><block type="controls_for_of"></block></xml>'});break;case ts.SyntaxKind.ForStatement:var u=n,f=!0;3==u.condition.getChildCount()&&(f=!("0"==u.condition.getChildAt(0).getText()||u.condition.getChildAt(1).kind==ts.SyntaxKind.LessThanToken)),l(f?{name:i?"Loops":"for",url:"blocks/loops"+(i?"":"/for"),description:i?lf("Loops and repetition"):lf("Repeat code for a given number of times using an index."),blocksXml:'<xml xmlns="http://www.w3.org/1999/xhtml"><block type="controls_simple_for"></block></xml>'}:{name:i?"Loops":"repeat",url:"blocks/loops"+(i?"":"/repeat"),description:i?lf("Loops and repetition"):lf("Repeat code for a given number of times."),blocksXml:'<xml xmlns="http://www.w3.org/1999/xhtml"><block type="controls_repeat_ext"></block></xml>'});break;case ts.SyntaxKind.VariableStatement:l({name:i?"Variables":"variable declaration",url:"blocks/variables"+(i?"":"/assign"),description:i?lf("Variables"):lf("Assign a value to a named variable."),blocksXml:'<xml xmlns="http://www.w3.org/1999/xhtml"><block type="variables_set"></block></xml>'});break;default:e.debug("card kind: "+n.kind)}}),o&&(n=n.parent()),n.replaceWith(a)}},{package:n.package})}function m(n,t,o){if(!t||0==t.length)return Promise.resolve();if(0==t.length){var i=e.docs.codeCard.render(t[0],o);n.replaceWith(i)}else{var r=document.createElement("div");r.className="ui cards",r.setAttribute("role","listbox"),t.forEach(function(n){return r.appendChild(e.docs.codeCard.render(n,o))}),n.replaceWith(r)}return Promise.resolve()}function g(e,n){if(!e)return Promise.resolve();var t=$("."+e).first();if(!t[0])return Promise.resolve();t.removeClass(e);var o;try{var i=JSON.parse(t.text());Array.isArray(i)||(i=[i]),o=i}catch(e){console.error("error while rendering "+t.html()),t.append($("<div/>").addClass("ui segment warning").text(e.messageText))}return n.snippetReplaceParent&&(t=t.parent()),m(t,o,{hideHeader:!0}).then(function(){return Promise.delay(1,g(e,n))})}function h(n){return n.pxtUrl?n.pxtUrl+"/--run":e.webConfig&&e.webConfig.runUrl?e.webConfig.runUrl:"/--run"}function v(n){return(n.pxtUrl||e.appTarget.appTheme.homeUrl||"").replace(/\/$/,"")}function k(e){e.packageClass&&$("."+e.packageClass).each(function(n,t){var o=$(t),i=o.text().split("\n").map(function(e){return e.replace(/\s*/g,"")}).filter(function(e){return!!e}).join(",");e.package=e.package?e.package+","+i:i,e.snippetReplaceParent&&(o=o.parent()),o.remove()})}function b(e){function n(n){"undefined"!=typeof hljs&&($(n).text($(n).text().replace(/^\s*\r?\n/,"")),hljs.highlightBlock(n)),i(e,$(n).parent(),$(n),void 0,void 0,t)}var t={showEdit:!!e.showEdit,run:!!e.simulator};$("code.lang-typescript").each(function(e,t){n(t),$(t).removeClass("lang-typescript")}),$("code.lang-typescript-ignore").each(function(e,t){n(t),$(t).removeClass("lang-typescript-ignore")})}n.renderAsync=function(n){return n||(n={}),n.pxtUrl&&(n.pxtUrl=n.pxtUrl.replace(/\/$/,"")),n.showEdit=!e.BrowserUtils.isIFrame(),k(n),n.simulatorClass&&$("."+n.simulatorClass).each(function(t,o){var i=$(o),r="81.97%";e.appTarget.simulator&&(r=100/e.appTarget.simulator.aspectRatio+"%");var a=$('<div class="ui centered card"><div class="ui content">\n                    <div style="position:relative;height:0;padding-bottom:'+r+';overflow:hidden;">\n                    <iframe style="position:absolute;top:0;left:0;width:100%;height:100%;" allowfullscreen="allowfullscreen" frameborder="0" sandbox="allow-popups allow-forms allow-scripts allow-same-origin"></iframe>\n                    </div>\n                    </div></div>');a.find("iframe").attr("src",h(n)+"#nofooter=1&code="+encodeURIComponent(i.text().trim())),n.snippetReplaceParent&&(i=i.parent()),i.replaceWith(a)}),b(n),Promise.resolve().then(function(){return d(n)}).then(function(){return p(n)}).then(function(){return f(n,n.linksClass,n.snippetReplaceParent,!1)}).then(function(){return f(n,n.namespacesClass,n.snippetReplaceParent,!0)}).then(function(){return l(n)}).then(function(){return g(n.codeCardClass,n)}).then(function(){return a(n)}).then(function(){return c(n)}).then(function(){return u(n)})}}(e.runner||(e.runner={}))}(pxt||(pxt={}));var pxt;!function(e){!function(n){function t(e){var o=e._editorPkg;if(o)return o;var i=null;e!=n.mainPkg&&(i=t(n.mainPkg));var r=new v(e,i);return e==n.mainPkg&&(r.topPkg=r),e._editorPkg=r,r}function o(){var n=e.appTarget.tsprj,t=e.U.clone(n.files);return t[e.CONFIG_NAME]=JSON.stringify(n.config,null,4)+"\n",t["main.blocks"]="",t}function i(){$&&$.fn&&$.fn.embed&&$.fn.embed.settings&&$.fn.embed.settings.sources&&$.fn.embed.settings.sources.youtube&&($.fn.embed.settings.sources.youtube.url="//www.youtube.com/embed/{id}?rel=0")}function r(){e.setAppTarget(window.pxtTargetBundle),e.Util.assert(!!e.appTarget);var t=/PXT_LANG=(.*?)(?:;|$)/.exec(document.cookie),o=/(live)?lang=([a-z]{2,}(-[A-Z]+)?)/i.exec(window.location.href),r=o?o[2]:t&&t[1]||e.appTarget.appTheme.defaultLocale||navigator.userLanguage||navigator.language,a=!e.appTarget.appTheme.disableLiveTranslations||o&&!!o[1],s=e.appTarget.versions;i();var l=e.webConfig;return e.Util.updateLocalizationAsync(e.appTarget.id,!0,l.commitCdnUrl,r,s?s.pxtCrowdinBranch:"",s?s.targetCrowdinBranch:"",a).then(function(){n.mainPkg=new e.MainPackage(new k)})}function a(e){console.error(e)}function s(o,i){var r=n.mainPkg.host();return n.mainPkg=new e.MainPackage(r),n.mainPkg._verspec=o?/\w+:\w+/.test(o)?o:"pub:"+o:"empty:tsprj",r.downloadPackageAsync(n.mainPkg).then(function(){return r.readFile(n.mainPkg,e.CONFIG_NAME)}).then(function(o){return o?n.mainPkg.installAllAsync().then(function(){if(i){var o=t(n.mainPkg);o.files["main.ts"]=i;var r=JSON.parse(o.files[e.CONFIG_NAME]);r.name=window.location.href.split("/").pop().split(/[?#]/)[0],o.files[e.CONFIG_NAME]=JSON.stringify(r,null,4),n.mainPkg.config.name=r.name,-1==n.mainPkg.config.files.indexOf("main.blocks")&&n.mainPkg.config.files.push("main.blocks")}}).catch(function(e){a(lf("Cannot load package: {0}",e.message))}):Promise.resolve()})}function l(e){var t=n.mainPkg.getTargetOptions();return t.isNative=!!e,t.hasHex=!!e,n.mainPkg.getCompileOptionsAsync(t)}function c(e,n){return l().then(function(e){n&&n(e);var t=pxtc.compile(e);return t.diagnostics&&t.diagnostics.length>0&&t.diagnostics.forEach(function(e){console.error(e.messageText)}),t})}function d(t,o){if(n.languageMode=t,o!=n.editorLocale){var i=/^live-/;return n.editorLocale=o,e.Util.updateLocalizationAsync(e.appTarget.id,!0,e.webConfig.commitCdnUrl,n.editorLocale.replace(i,""),e.appTarget.versions.pxtCrowdinBranch,e.appTarget.versions.targetCrowdinBranch,i.test(n.editorLocale))}return Promise.resolve()}function p(n){var t=n.data;if(t)switch(t.type){case"fileloaded":var o=t,i=o.name;d(/\.ts$/i.test(i)?b.TypeScript:b.Blocks,o.locale).done();break;case"popout":var r=/#(doc|md):([^&?:]+)/i.exec(window.location.href);if(r){var a=e.webConfig.docsUrl||"/--docs",s="doc"==r[1]?""+r[2]:a+"?md="+r[2];window.open(s,"_blank"),window.parent&&window.parent.postMessage({type:"popoutcomplete"},"*")}break;case"localtoken":var l=t;l&&l.localToken&&(e.Cloud.localToken=l.localToken,y.forEach(function(e){return e()}),y=[])}}function u(t,o){return o=o.replace(/^\//,""),e.Cloud.downloadMarkdownAsync(o,n.editorLocale,e.Util.localizeLive).then(function(e){return m(t,e,{path:o})})}function f(t,o){o=o.replace(/^\//,""),e.tickEvent("book",{id:o}),e.log("rendering book from "+o);var i;return e.Cloud.downloadMarkdownAsync(o,n.editorLocale,e.Util.localizeLive).then(function(t){i=e.docs.buildTOC(t),e.log("TOC: "+JSON.stringify(i,null,2));var o=[];return e.docs.visitTOC(i,function(t){/^\//.test(t.path)&&!/^\/pkg\//.test(t.path)&&o.push(e.Cloud.downloadMarkdownAsync(t.path,n.editorLocale,e.Util.localizeLive).then(function(e){t.markdown=e},function(e){t.markdown="_"+t.path+" failed to load._"}))}),Promise.all(o)}).then(function(n){var o=i[0].name;return e.docs.visitTOC(i,function(e){e.markdown&&(o+="\n\n"+e.markdown)}),m(t,o)})}function m(t,o,i){void 0===i&&(i={});(i.path||"").split("/");var r=e.docs.renderMarkdown({template:w,markdown:o,theme:e.appTarget.appTheme});return $(t).html(r),$(t).find("a").attr("target","_blank"),e.runner.renderAsync({blocksAspectRatio:.5,snippetClass:"lang-blocks",signatureClass:"lang-sig",blocksClass:"lang-block",simulatorClass:"lang-sim",linksClass:"lang-cards",namespacesClass:"lang-namespaces",codeCardClass:"lang-codecard",packageClass:"lang-package",projectClass:"lang-project",snippetReplaceParent:!0,simulator:!0,hex:!0,tutorial:!!i.tutorial,showJavaScript:n.languageMode==b.TypeScript,hexName:e.appTarget.id}).then(function(){$(t).find('a[href^="/"]').removeAttr("target").each(function(e,n){$(n).attr("href","#doc:"+$(n).attr("href").replace(/^\//,""))}),$(t).find(".ui.embed").embed()})}function g(t,o){o=o.replace(/^\//,"");var i=Promise.resolve();return e.Cloud.isLocalHost()&&(i=h()),i.then(function(){return e.Cloud.downloadMarkdownAsync(o,n.editorLocale,e.Util.localizeLive)}).then(function(n){var i=n.split(/^##[^#].*$/gim),r=!0;if(i.length<=1&&(i=n.split(/^###[^#].*$/gim),r=!1),0==i[0].indexOf("# Not found"))throw e.log("Tutorial not found: "+o),new Error("Tutorial not found: "+o);var a=[];if(n.replace(r?/^##[^#](.*)$/gim:/^###[^#](.*)$/gim,function(e,n){var t={fullscreen:n.indexOf("@fullscreen")>-1};return a.push(t),""}),i.length<1)return Promise.resolve();i[0];i=i.slice(1,i.length);var s={};return Promise.resolve().then(function(){return m(t,n,{tutorial:!0})}).then(function(){var n=i.join();n=n.replace(/((?!.)\s)+/g,"\n");for(var t,r=/```(sim|block|blocks|filterblocks)\s*\n([\s\S]*?)\n```/gim,a="";null!=(t=r.exec(n));)a+=t[2]+"\n";return""!=a?e.runner.decompileToBlocksAsync(a,{emPixels:14,layout:e.blocks.BlockLayout.Flow,useViewWidth:!0,package:void 0}).then(function(n){var t=n.compileBlocks.outfiles["main.blocks"];if(t)for(var o=e.blocks.loadWorkspaceXml(t).getAllBlocks(),i=0;i<o.length;++i){var r=o[i];s[r.type]=1}}).catch(function(){throw e.log("Failed to decompile tutorial: "+o),new Error("Failed to decompile tutorial: "+o)}):Promise.resolve()}).then(function(){for(var e=t.innerHTML.split(r?/<h2.*\/h2>/gi:/<h3.*\/h3>/gi),n=0;n<e.length-1;n++)t.innerHTML=e[n+1],a[n].headerContent="<p>"+t.firstElementChild.innerHTML+"</p>",a[n].ariaLabel=t.firstElementChild.textContent,a[n].content=e[n+1],a[n].hasHint=t.childElementCount>1;t.innerHTML="",window.parent.postMessage({type:"tutorial",tutorial:o,subtype:"loaded",stepInfo:a,toolboxSubset:s},"*")})}).catch(function(n){e.log("Failed to load tutorial: "+o),e.log(n.message),window.parent.postMessage({type:"tutorial",tutorial:o,subtype:"error"},"*")})}function h(){return e.Cloud.localToken?Promise.resolve():new Promise(function(e,n){y.push(e)})}var v=function(){function n(e,n){this.ksPkg=e,this.topPkg=n,this.files={}}return n.prototype.getKsPkg=function(){return this.ksPkg},n.prototype.getPkgId=function(){return this.ksPkg?this.ksPkg.id:this.id},n.prototype.isTopLevel=function(){return this.ksPkg&&0==this.ksPkg.level},n.prototype.setFiles=function(e){this.files=e},n.prototype.getAllFiles=function(){return e.Util.mapMap(this.files,function(e,n){return n})},n}(),k=function(){function n(){this.githubPackageCache={}}return n.prototype.readFile=function(n,o){var i=t(n);return e.U.lookup(i.files,o)},n.prototype.writeFile=function(n,t,o){if(t!=e.CONFIG_NAME)throw e.Util.oops("trying to write "+n+" / "+t)},n.prototype.getHexInfoAsync=function(n){return e.hex.getHexInfoAsync(this,n)},n.prototype.cacheStoreAsync=function(e,n){return Promise.resolve()},n.prototype.cacheGetAsync=function(e){return Promise.resolve(null)},n.prototype.downloadPackageAsync=function(n){var i=this,r=n.verProtocol(),a=void 0;"github"==r&&(a=this.githubPackageCache[n._verspec]);var s=t(n);return(a?Promise.resolve(a):n.commonDownloadAsync()).then(function(t){if(t)return"github"!=r||a||(i.githubPackageCache[n._verspec]=e.Util.clone(t)),s.setFiles(t),Promise.resolve();if("empty"==r)return s.setFiles(o()),Promise.resolve();if("docs"==r){var l=o(),c=JSON.parse(l[e.CONFIG_NAME]);return n.verArgument().split(",").forEach(function(e){var n=/^([a-zA-Z0-9_-]+)(=(.+))?$/.exec(e);n?c.dependencies[n[1]]=n[3]||"*":console.warn("unknown package syntax "+e)}),c.yotta||(c.yotta={}),c.yotta.ignoreConflicts=!0,l[e.CONFIG_NAME]=JSON.stringify(c,null,4),s.setFiles(l),Promise.resolve()}return Promise.reject("Cannot download "+n.version()+"; unknown protocol")})},n}();n.initFooter=function(n,t){if(n){var o=e.appTarget.appTheme,i=$("body"),r=$(n),a=$("<a/>").attr("href",o.homeUrl).attr("target","_blank");r.append(a),o.organizationLogo?a.append($("<img/>").attr("src",e.Util.toDataUri(o.organizationLogo))):a.append(lf("powered by {0}",o.title)),i.mouseenter(function(e){return r.fadeOut()}),i.mouseleave(function(e){return r.fadeIn()})}},n.showError=a,n.generateHexFileAsync=function(e){return s(e.id).then(function(){return c(!0,function(n){e.code&&(n.fileSystem["main.ts"]=e.code)})}).then(function(e){return e.diagnostics&&e.diagnostics.length>0&&console.error("Diagnostics",e.diagnostics),e.outfiles[pxtc.BINARY_HEX]})},n.simulateAsync=function(n,t){return s(t.id).then(function(){return c(!1,function(e){t.code&&(e.fileSystem["main.ts"]=t.code)})}).then(function(t){t.diagnostics&&t.diagnostics.length>0&&console.error("Diagnostics",t.diagnostics);var o=t.outfiles[pxtc.BINARY_JS];if(o){var i={},r=new pxsim.SimulatorDriver(n,i),a=t.usedArguments,s=e.appTarget.simulator.boardDefinition,l=pxtc.computeUsedParts(t,!0),c={boardDefinition:s,parts:l,fnArgs:a,cdnUrl:e.webConfig.commitCdnUrl,localizedStrings:e.Util.getLocalizedStrings()};e.appTarget.simulator&&(c.aspectRatio=l.length&&e.appTarget.simulator.partsAspectRatio?e.appTarget.simulator.partsAspectRatio:e.appTarget.simulator.aspectRatio),r.run(o,c)}})},function(e){e[e.Blocks=0]="Blocks",e[e.TypeScript=1]="TypeScript"}(n.LanguageMode||(n.LanguageMode={}));var b=n.LanguageMode;n.languageMode=b.Blocks,n.editorLocale="en",n.setEditorContextAsync=d,n.startRenderServer=function(){function t(){if(!i){var r=o.shift();r&&(i=n.decompileToBlocksAsync(r.code,r.options).then(function(n){return n.blocksSvg?e.blocks.layout.blocklyToSvgAsync(n.blocksSvg,0,0,n.blocksSvg.viewBox.baseVal.width,n.blocksSvg.viewBox.baseVal.height):void 0}).then(function(e){window.parent.postMessage({source:"makecode",type:"renderblocks",id:r.id,width:e?e.width:void 0,height:e?e.height:void 0,svg:e?e.svg:void 0,uri:e?e.xml:void 0},"*"),i=void 0,t()}))}}e.tickEvent("renderer.ready");var o=[],i=void 0;window.addEventListener("message",function(e){var n=e.data;"renderblocks"==n.type&&(o.push(n),t())},!1),window.parent.postMessage({source:"makecode",type:"renderready"},"*")},n.startDocsServer=function(n,t){function o(i,r){e.debug("rendering "+i),$(t).hide(),$(n).show(),Promise.delay(100).then(function(){switch(i){case"doc":return u(t,r);case"tutorial":return $("body").addClass("tutorial"),$(n).hide(),g(t,r);case"book":return f(t,r);default:return m(t,r)}}).catch(function(n){$(t).html('\n                    <img style="height:4em;" src="'+e.appTarget.appTheme.docsLogo+'" />\n                    <h1>'+lf("Oops")+"</h1>\n                    <h3>"+lf("We could not load the documentation, please check your internet connection.")+'</h3>\n                    <button class="ui button primary" id="tryagain">'+lf("Try Again")+"</button>"),$(t).find("#tryagain").click(function(){o(i,r)}),window.parent&&window.parent.postMessage({type:"docfailed",docType:i,src:r},"*")}).finally(function(){$(n).hide(),$(t).show()}).done(function(){})}function i(){var e=/^#(doc|md|tutorial|book):([^&?:]+)(:([^&?:]+):([^&?:]+))?/i.exec(window.location.hash);e&&(e[4]?d(/^blocks$/.test(e[4])?b.Blocks:b.TypeScript,e[5]):Promise.resolve()).then(function(){return o(e[1],decodeURIComponent(e[2]))})}var r=Promise.resolve();if(e.appTarget.appTheme&&e.appTarget.appTheme.extendEditor){var a={};r=r.then(function(){return e.BrowserUtils.loadScriptAsync(e.webConfig.commitCdnUrl+"editor.js")}).then(function(){return e.editor.initExtensionsAsync(a)}).then(function(n){n.fieldEditors&&n.fieldEditors.forEach(function(n){e.blocks.registerFieldEditor(n.selector,n.editor,n.validator)})})}r.done(function(){window.addEventListener("message",p,!1),window.addEventListener("hashchange",function(){i()},!1),parent.postMessage({type:"sidedocready"},"*"),setTimeout(function(){return i()},1)})},n.renderProjectAsync=function(n,t,o){return void 0===o&&(o="blocks"),e.Cloud.privateGetTextAsync(t+"/text").then(function(e){return JSON.parse(e)}).then(function(e){var t="```"+o+"\n"+e["main.ts"]+"\n```";return m(n,t)})};var w='\n<aside id=button class=box>\n   <a class="ui primary button" href="@ARGS@">@BODY@</a>\n</aside>\n\n<aside id=vimeo>\n<div class="ui two column stackable grid container">\n<div class="column">\n    <div class="ui embed mdvid" data-source="vimeo" data-id="@ARGS@" data-placeholder="/thumbnail/1024/vimeo/@ARGS@" data-icon="video play">\n    </div>\n</div></div>\n</aside>\n\n<aside id=youtube>\n<div class="ui two column stackable grid container">\n<div class="column">\n    <div class="ui embed mdvid" data-source="youtube" data-id="@ARGS@" data-placeholder="https://img.youtube.com/vi/@ARGS@/maxresdefault.jpg">\n    </div>\n</div></div>\n</aside>\n\n<aside id=section>\n    \x3c!-- section @ARGS@ --\x3e\n</aside>\n\n<aside id=hide class=box>\n    <div style=\'display:none\'>\n        @BODY@\n    </div>\n</aside>\n\n<aside id=avatar class=box>\n    <div class=\'avatar @ARGS@\'>\n        <div class=\'avatar-image\'></div>\n        <div class=\'ui compact message\'>\n            @BODY@\n        </div>\n    </div>\n</aside>\n\n<aside id=hint class=box>\n    <div class="ui icon green message">\n        <div class="content">\n            <div class="header">Hint</div>\n            @BODY@\n        </div>\n    </div>\n</aside>\n\n\x3c!-- wrapped around ordinary content --\x3e\n<aside id=main-container class=box>\n    <div class="ui text">\n        @BODY@\n    </div>\n</aside>\n\n\x3c!-- used for \'column\' box - they are collected and wrapped in \'column-container\' --\x3e\n<aside id=column class=aside>\n    <div class=\'column\'>\n        @BODY@\n    </div>\n</aside>\n<aside id=column-container class=box>\n    <div class="ui three column stackable grid text">\n        @BODY@\n    </div>\n</aside>\n@breadcrumb@\n@body@';n.renderMarkdownAsync=m,n.renderTutorialAsync=g,n.decompileToBlocksAsync=function(t,o){return s(o&&o.package?"docs:"+o.package:null,t).then(function(){return l(!!e.appTarget.compile&&e.appTarget.compile.hasHex)}).then(function(i){i.fileSystem["main.ts"]=t,i.ast=!0;var r=pxtc.compile(i);if(r.diagnostics&&r.diagnostics.length>0&&r.diagnostics.forEach(function(e){return console.error(e.messageText)}),!r.success)return Promise.resolve({package:n.mainPkg,compileJS:r});var a=pxtc.getApiInfo(i,r.ast);return ts.pxtc.localizeApisAsync(a,n.mainPkg).then(function(){var t=pxtc.getBlocksInfo(a);e.blocks.initBlocks(t);var i=pxtc.decompiler.decompileToBlocks(t,r.ast.getSourceFile("main.ts"),{snippetMode:o&&o.snippetMode});return i.diagnostics&&i.diagnostics.length>0&&i.diagnostics.forEach(function(e){return console.error(e.messageText)}),i.success?(e.debug(i.outfiles["main.blocks"]),{package:n.mainPkg,compileJS:r,compileBlocks:i,blocksSvg:e.blocks.render(i.outfiles["main.blocks"],o)}):{package:n.mainPkg,compileJS:r,compileBlocks:i}})})};var y=[];n.initCallbacks=[],n.init=function(){r().done(function(){for(var e=0;e<n.initCallbacks.length;++e)n.initCallbacks[e]()})},function(){var e=window.ksRunnerWhenLoaded;e&&e()}()}(e.runner||(e.runner={}))}(pxt||(pxt={}));